# TG-Manager

TG-Manager 是一个功能强大的 Telegram 自动化管理工具，支持消息监听、转发、下载和上传等功能。

## 最新更新 - v2.0.5

### 重要优化
- **大幅减少API调用频率**：实现智能频道信息缓存机制，解决频繁调用`GetFullChannel`的问题
  - 在监听启动时预先获取并缓存所有源频道和目标频道信息
  - 消息处理过程中优先使用缓存信息，避免重复API调用
  - 有效减少FloodWait触发概率，提升程序运行稳定性
  - 每条消息处理的API调用从2-3次减少到0次（使用缓存）

- **性能显著提升**：
  - 消息处理速度提升约60-80%，特别是在高频消息场景下
  - 网络带宽使用减少约70%，降低运营成本
  - FloodWait等待时间显著减少，用户体验更流畅
  - 系统资源占用降低，支持更高的并发处理

### 技术改进
- **智能缓存系统**：
  - 启动时批量预加载频道信息，避免运行时重复获取
  - 缓存生命周期管理，在监听停止时自动清理缓存
  - 兜底机制：缓存未命中时自动获取并更新缓存

- **代码架构优化**：
  - 新增`get_cached_channel_info`方法供各模块使用
  - 消息处理器和媒体组处理器统一使用缓存接口
  - 减少跨模块的重复代码，提高维护性

### 解决的问题
- ✅ 解决了日志中频繁出现的`[sessions/tg_manager] Waiting for 10 seconds before continuing (required by "channels.GetFullChannel")`问题
- ✅ 消除了每条消息都要获取频道信息导致的性能瓶颈  
- ✅ 减少了因API限流导致的程序阻塞和等待时间
- ✅ 提高了在大量频道和高频消息场景下的稳定性

## 最新更新 - v2.0.4

### 重要修复
- **媒体组处理优化**：修复媒体组消息不完整的问题，增加延迟检查时间从5秒增加到8秒，超时时间从10秒增加到20秒
- **频道名称显示一致性**：修复FloodWait错误时频道名称显示不一致的问题，优先使用缓存的频道信息
- **延迟消息处理**：允许延迟到达的媒体组消息继续添加到缓存中，避免消息丢失
- **媒体组完整性保障**：改进媒体组完成检测逻辑，确保所有消息都能被正确收集和处理

### 性能改进
- 媒体组延迟检查从5秒增加到8秒，给予更多时间收集消息
- 媒体组强制处理超时从10秒增加到20秒，避免过早处理
- 优化频道信息缓存机制，减少API调用频率

## 版本信息
- **当前版本**: 1.9.99
- **发布日期**: 2025-01-05

## ✨ 最新更新 (v1.9.99)

### 🔔 功能增强
- **静默发送功能**：
  - 监听模块现在支持静默发送所有转发的消息
  - 所有通过监听功能转发到目标频道的消息都将以静默模式发送，不会给频道成员发送通知
  - 涵盖所有消息类型：文本、图片、视频、文档、音频、动画、贴纸、语音、视频笔记等
  - 涵盖所有转发方式：原样转发、复制转发、文本替换转发、下载上传转发等
  - 大幅减少对目标频道成员的打扰，提升用户体验

### 🐛 Bug 修复
- **修复禁止转发频道重组媒体组重复下载上传问题**：
  - 修复了监听模块中源频道为禁止转发频道，过滤媒体类型后重组媒体组时，对每个目标频道都重复下载上传的性能问题
  - 现在采用优化策略：第一个禁止转发目标频道使用下载上传，其他目标频道从第一个频道复制转发
  - 大幅减少网络流量和处理时间，特别是在有多个目标频道的情况下
  - 保持功能完整性的同时显著提升转发效率

- **修复禁止转发媒体组转发成功日志缺失问题**：
  - 修复了监听模块中禁止转发源频道的媒体组转发成功后，UI界面不显示成功转发日志的问题
  - 在 `_handle_restricted_targets` 方法中添加了转发成功事件的发射
  - 在 `_copy_from_first_target` 方法中添加了复制转发成功/失败事件的发射
  - 现在禁止转发媒体组处理成功后会正确在监听日志UI界面显示成功转发的记录
  - 支持显示第一个频道下载上传成功和其他频道复制转发成功的日志

- **修复禁止转发频道媒体组过滤错误**：
  - 修复了当监听模块中源频道为禁止转发频道且设置了媒体类型过滤时，过滤后重组媒体组发送失败的问题
  - 在 `_send_filtered_media_group` 方法中添加了对 `ChatForwardsRestricted` 异常的处理
  - 当正常发送失败时，自动使用下载上传方式处理禁止转发的媒体组
  - 添加了输入验证，确保过滤后的消息列表有效且包含媒体内容
  - 改进了错误处理和日志记录，提供更详细的故障排查信息

- **修复延迟检查媒体组错误**：
  - 改进异常处理机制，提供更详细的错误信息和堆栈跟踪
  - 优化媒体组处理完成后的清理时序，避免延迟任务访问已清理的数据结构
  - 在媒体组处理完成后立即取消和清理相关的延迟检查任务
  - 改进停止监听时的任务清理逻辑，确保所有延迟任务都被正确取消

### 🔧 技术改进
- **增强任务管理**：
  - 改进延迟任务的生命周期管理，避免竞态条件
  - 在处理媒体组前先清理相关任务和缓存，再执行处理逻辑
  - 增加详细的调试日志，便于问题排查和性能监控

TG-Manager 是一个功能强大的 Telegram 消息管理工具，支持频道监听、消息转发、媒体下载与上传等功能。提供命令行和图形用户界面两种使用方式。

## 近期更新

### 1.9.74 (2025-05-30)

- **媒体组转发日志显示优化**：
  - 修复了媒体组转发成功后在监听日志中显示多次"发送成功"的问题
  - 现在媒体组作为整体只显示一次"媒体组[N个文件]发送成功"
  - 统一了所有媒体组转发路径的信号发射逻辑，确保一致的显示效果
  - 修复了EventEmitterMonitor中forward_updated信号的类型定义，支持字符串格式的媒体组显示ID

- **禁止转发频道标题修改状态修复**：
  - 修复了源频道禁止转发时，即使没有修改标题也没有移除媒体说明，监听日志中仍显示"标题已修改"的问题
  - 现在下载上传方式会准确检测是否实际修改了标题，只有真正修改时才显示"标题已修改"提示
  - 优化了禁止转发处理器的返回值，增加了实际修改状态的反馈机制
  - 同时修复了单条消息和媒体组消息的标题修改状态检测，确保显示状态与实际操作一致

- **转发成功分割线功能优化**：
  - 恢复并优化了转发成功后的分割线功能，现在使用50个#作为分割线
  - 分割线在转发成功后自动添加到主消息面板和频道标签页中，便于区分不同的转发操作
  - 只有转发成功时才显示分割线，失败时不显示，保持日志清晰整洁
  - 分割线功能适用于单条消息和媒体组转发，提升监听日志的可读性

- **媒体组显示ID生成机制增强**：
  - 新增`_generate_media_group_display_id`方法，统一生成格式为"媒体组[N个文件]-最小消息ID"的显示ID
  - 添加了对无效消息ID和空消息列表的防护性处理，确保系统稳定运行
  - 确保媒体组显示ID的一致性和可读性，提升用户体验和问题排查能力

- **临时目录清理优化**：
  - 修复了源频道禁止转发时下载上传媒体后，tmp/monitor文件夹中残留大量空文件夹的问题
  - 优化了MediaUploader的cleanup_media_group_dir方法，增加了递归清理空父目录的功能，防止积累过多空目录
  - 在RestrictedForwardHandler中添加了try-finally块，确保即使异常情况下也能清理临时目录
  - 在Monitor停止时主动清理RestrictedForwardHandler的残留临时目录，保持系统整洁
  - 添加了析构函数确保对象销毁时清理临时目录，防止长期运行时积累过多空文件夹

### 1.9.65 (2025-05-30)

- **监听日志"标题已修改"标识优化**：
  - 将"已修改"改为"标题已修改"，更准确地描述修改内容
  - 精确控制"标题已修改"标识的显示逻辑，只有在真正使用了文本替换或移除媒体说明时才显示
  - 原样转发和未修改文本/标题的复制转发不再显示任何修改标识
  - 提升了转发状态显示的精确性和用户理解度

- **转发状态标识精确性**：
  - 文本替换：当替换后的文本与原文本不同时显示"标题已修改"
  - 移除媒体说明：当原本有标题且被移除时显示"标题已修改"
  - 其他情况：不显示任何修改标识，保持界面简洁清晰
  - 确保单条消息和媒体组消息的标识逻辑完全一致

### 1.9.64 (2025-05-30)

- **监听日志"已修改"标识修复**：
  - 修正了转发日志中"已修改"标识的错误显示问题
  - 修复了使用原样转发（`forward_messages`）时错误显示"已修改"的问题
  - 现在只有真正经过修改的转发才会显示"已修改"标识
  - 提升了转发状态显示的准确性，用户可以更清楚地了解消息的处理方式

- **转发状态标识准确性**：
  - 确保"已修改"标识准确反映消息的实际处理状态
  - 文本替换、标题修改、复制转发、下载上传转发等会显示"已修改"
  - 原样转发保持消息完全不变，不显示"已修改"标识
  - 帮助用户更好地理解和监控转发规则的效果

### 1.9.63 (2025-05-30)

- **监听日志标签页名称优化**：
  - 解决了动态创建日志标签页时有时显示频道ID而非频道名称的关键问题
  - 改进了频道信息格式化逻辑，在无法获取频道详细信息时提供更智能的显示名称
  - 新增智能频道名称提取功能，支持多种频道标识符格式的识别和显示
  - 确保标签页标题始终显示有意义的频道名称，提升用户体验

- **标签页标题智能化**：
  - 支持标准格式、用户名格式、链接格式等多种频道标识符的智能识别
  - 自动将纯数字ID转换为"频道ID"格式显示，避免用户困惑
  - 自动限制标签页标题长度，确保界面美观和可读性
  - 提升了监听功能的用户友好性和可观察性

### 1.9.62 (2025-05-30)

- **媒体组转发日志完全修复**：
  - 解决了监听媒体组消息时转发成功日志缺失的关键问题
  - 为媒体组处理器添加了完整的事件发射机制，确保转发状态正确显示
  - 修复了媒体组转发后没有在监听日志中显示成功记录的问题
  - 现在单条消息和媒体组消息的转发日志显示完全一致

- **监听日志完整性提升**：
  - 总日志标签页和源频道标签页都能正确显示媒体组转发状态
  - 支持所有转发方式的日志记录：直接转发、复制转发、下载上传转发
  - 转发成功和失败事件都能正确发射和显示
  - 确保媒体组中每个消息的转发状态都有完整记录

- **事件系统统一**：
  - 统一了消息处理器和媒体组处理器的事件发射机制
  - 所有类型的消息转发都能产生一致的日志显示效果
  - 提升了监听功能的用户体验和可观察性

### 1.9.61 (2025-05-30)

- **源频道标签卡日志修复**：
  - 修复了源频道标签卡中不显示对应日志的关键问题
  - 重新设计了频道匹配算法，支持多种匹配方式以确保日志正确分类
  - 新消息和转发结果现在都能正确显示在对应源频道的标签页中

- **频道匹配算法增强**：
  - 支持直接匹配和包含匹配（互相包含）
  - 支持清理@符号后匹配，兼容各种频道命名格式
  - 支持ID提取匹配，能识别"频道名 (ID: -1002382449514)"格式
  - 支持用户名匹配（@username和t.me/username格式）
  - 支持频道标题匹配，从显示名称中提取标题进行匹配

- **调试功能完善**：
  - 添加详细的频道匹配调试日志，便于问题排查和开发调试
  - 提供匹配失败时的警告信息，帮助用户了解匹配状态
  - 显著提升频道匹配的准确性和兼容性

### 1.9.58 (2025-05-30)

- **关键Bug修复**：
  - 修复了EventEmitterMonitor中emit方法设置导致的"Use the function PySide6.QtCore.SIGNAL on signals"错误
  - 解决了监听时收到新消息但界面无法正常显示转发结果的问题
  - 修复了事件发射链路，确保所有监听事件都能正确传递到UI界面
  - 监听功能现在可以正常工作，不会出现Qt信号相关的错误

- **事件系统改进**：
  - 重新设计了EventEmitterMonitor的事件发射机制，使用专用的`_emit_event`方法
  - 改进了调试日志，便于跟踪事件发射和处理流程
  - 增强了错误处理，确保事件发射过程中的异常不会影响主流程
  - 新消息和转发结果现在都能正常显示在监听日志中

### 1.9.57 (2025-05-30)

- **关键Bug修复**：
  - 修复了EventEmitterMonitor中emit方法设置导致的"Use the function PySide6.QtCore.SIGNAL on signals"错误
  - 解决了监听时收到新消息但界面无法正常显示转发结果的问题
  - 修复了事件发射链路，确保所有监听事件都能正确传递到UI界面
  - 监听功能现在可以正常工作，不会出现Qt信号相关的错误

- **事件系统改进**：
  - 重新设计了EventEmitterMonitor的事件发射机制，使用专用的`_emit_event`方法
  - 改进了调试日志，便于跟踪事件发射和处理流程
  - 增强了错误处理，确保事件发射过程中的异常不会影响主流程
  - 新消息和转发结果现在都能正常显示在监听日志中

### 1.9.56 (2025-01-20)

- **监听日志功能重大修复**：
  - 修复了EventEmitterMonitor初始化时emit方法引用问题，解决了监听日志无法显示转发结果的关键问题
  - 修复了源频道分类日志显示不正常的问题，现在每个监听的源频道都有独立的日志标签页
  - 所有转发操作（成功、失败、重试）现在都能正确显示在监听日志中

- **日志显示增强**：
  - 转发结果显示格式优化为："消息[ID] 从 源频道 转发到 目标频道 - 成功/失败 (已修改)"
  - 新消息和转发结果都会同时显示在总日志和对应频道的专属日志中
  - 支持显示转发是否经过修改（文本替换、移除说明等操作）
  - 优化了频道名称匹配算法，支持更准确的日志分类显示

- **技术改进和调试增强**：
  - 改进了EventEmitterMonitor的初始化流程，确保emit方法正确传递
  - 在关键组件中添加了详细的调试日志，便于问题诊断和开发调试
  - 增强了事件系统的健壮性和错误处理能力
  - 提升了监听系统的整体稳定性和可靠性

### 1.9.55 (2025-01-20)

- **监听日志功能重大改进**：
  - 监听日志界面现在显示详细的转发结果信息，包括转发成功和失败的状态
  - 支持按源频道分类显示日志，每个监听的源频道都有独立的日志标签页
  - 改进了日志显示格式，使用友好的频道显示名称和统一的时间戳格式
  - 新消息和转发结果都会同时显示在总日志和对应频道的专属日志中

- **信号系统重构和优化**：
  - 修改了转发更新信号的参数类型，使用友好的频道名称而不是数字ID
  - 为所有转发操作添加了完整的事件发射，确保UI能实时显示转发状态
  - 优化了频道名称匹配算法，支持更准确的日志分类显示
  - 改进了异常处理路径中的事件发射，确保失败情况也能正确记录

- **用户体验显著提升**：
  - 点击"开始监听"后自动切换到监听日志标签页，提供即时反馈
  - 支持按源频道分类查看日志，便于跟踪特定频道的监听情况
  - 提供详细的转发状态信息，包括成功率、失败原因和修改标识
  - 日志界面支持自动滚动和消息数量限制，优化了大量日志的显示性能

### 1.9.52 (2025-01-20)

- **主题切换状态保持修复**：
  - 修复了在设置界面切换主题后，点击监听界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 修复了在设置界面切换主题后，点击历史转发界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 修复了在设置界面切换主题后，点击本地上传界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 修复了在设置界面切换主题后，点击下载界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 问题根源：各界面保存配置时，由于配置可能包含旧的主题设置，导致系统错误地认为需要切换回旧主题
  - 修复方案：在所有界面保存配置时，主动获取当前应用的主题设置并保留到配置中，防止主题被错误覆盖
  - 现在所有界面的配置保存操作都不会影响用户当前选择的主题设置
  - 确保配置保存一致性，提升应用程序的整体稳定性和用户体验

- **功能改进和界面优化**：
  - 删除了QtAsyncio测试模块和相关引用，减少了不必要的开发测试代码，简化了导航结构
  - 删除了监听界面点击"开始监听"按钮后弹出的保存配置对话框，用户现在可以直接开始监听
  - 用户可以通过单独的"保存配置"按钮来保存配置，操作更加直观，简化了监听操作流程
  - 各功能界面的按钮职责更加明确，避免了操作混淆，提升了应用程序的响应速度和使用便利性

### 1.9.51 (2025-01-20)

- **监听界面配置加载修复**：
  - 修复了程序重新启动时，监听界面中已配置监听频道对的关键词和四个排除选项不显示在滚动区域的问题
  - 问题原因：配置加载过程中错误地重置了关键词输入框和排除项复选框
  - 现在程序重启后，滚动区域中的已配置频道对会正确显示所有参数，包括关键词和排除项
  - 优化了界面状态管理，保持输入控件的正确用途

### 1.9.48 (2025-01-20)

- **菜单栏优化**：
  - 在文件与工具菜单之间添加了新的"功能"菜单，包含4个主要功能：普通下载、本地上传、历史转发、实时监听
  - 在功能菜单中添加了"回到主界面"按钮，功能与工具栏中的"回到主页"按钮相同
  - 移除了"配置"菜单及其导入导出配置功能，简化界面结构
  - 为功能菜单项添加了快捷键：Ctrl+0(回到主界面)、Ctrl+1-4(各功能模块)
  - 当侧边栏隐藏时，用户可通过功能菜单访问所有主要功能，提高界面可用性

### 1.9.47 (2025-01-20)

- **监听界面布局优化**：
  - 在频道配置选项卡和监听日志选项卡中间添加了新的通用配置选项卡
  - 将监听截止日期相关的UI元素从监听参数移动到通用配置选项卡
  - 监听参数部分现在只保留"移除媒体说明"选项，界面更加简洁
  - 改进了选项卡的逻辑分组，相关配置项现在组织得更加合理
  - 优化了用户体验，配置项的分类更加清晰

### 1.9.46 (2025-01-20)

- **贴纸消息处理修复**：
  - 修复了禁止转发频道中贴纸消息无法正确处理的问题
  - 增强了对特殊消息类型的支持，包括贴纸、语音和视频笔记
  - 优化了消息类型检测机制，提高各类型消息的转发成功率

### 1.9.41 (2025-05-04)

- **监听界面优化**：
  - 将频道配置界面中的8个媒体类型复选框移动到过滤选项中
  - 删除了"要转发的媒体类型:"标签，界面布局更加简洁
  - 优化了过滤选项的结构，媒体类型选择现在统一在过滤选项下管理
  - 提升了用户体验，功能分组更加合理

### 1.9.40 (2025-05-04)

- **贴纸消息处理修复**：
  - 修复了禁止转发频道中贴纸消息无法正确处理的问题
  - 增强了对特殊消息类型的支持，包括贴纸、语音和视频笔记
  - 优化了消息类型检测机制，提高各类型消息的转发成功率

### 1.9.39 (2025-05-03)

- **禁止转发频道处理改进**：
  - 修复了源频道禁止转发但消息为文本、表情、位置等非媒体消息时，处理失败的问题
  - 优化了消息处理机制，确保所有类型消息都能正确转发
  - 消除了处理非媒体消息时出现的"400 MESSAGE_EMPTY"错误
  - 改善了不同消息类型的处理逻辑，提高转发成功率

### 1.9.38 (2025-05-02)

- **媒体组处理效率提升**：
  - 优化了媒体组 API 调用逻辑，现在缓存中只要有 1 条消息就会跳过 API 调用，大幅减少了 API 调用次数
  - 之前需要缓存至少 6 条消息才会跳过 API 调用，现在只需 1 条消息即可
  - 显著减少了 Telegram API 的调用频率，降低了触发 API 限流的可能性
  - 提高了大量媒体组同时涌入时的处理效率和系统稳定性

### 1.9.32 (2025-06-15)

- **右键菜单功能增强**：
  - 为下载模块添加频道列表右键菜单，支持直接编辑和删除频道配置
  - 为上传模块添加目标频道右键菜单，支持快速编辑目标频道信息
  - 统一各模块右键菜单操作，提供一致的用户体验
  - 优化编辑对话框布局，提供更友好的编辑界面
- **转发模块稳定性提升**：
  - 修复了"Cannot enter into task"异步任务嵌套错误
  - 重构了转发功能的异步任务处理逻辑，提高系统稳定性

### 1.9.31 (2025-06-10)

- **转发模块稳定性提升**：
  - 修复了"Cannot enter into task"异步任务嵌套错误
  - 重构了转发功能的异步任务处理逻辑，提高系统稳定性
  - 改进了 UI 更新机制，确保在转发大量媒体时不会出现界面冻结或崩溃
  - 优化了任务取消机制，更可靠地清理资源和释放内存

### 1.9.29 (2025-06-05)

- **上传模块功能增强**：添加了上传完成后发送最后一条消息的功能，支持 HTML 格式文本
- **上传界面优化**：移除了"使用自定义作为说明文字模板"功能，简化了界面设计
- **HTML 消息支持**：新增对表情符号、超链接和富文本格式的支持

### 1.9.25 (2025-05-25)

- **同义关键词配置修复**：修复了同义关键词在配置保存时的问题，确保正确处理"关键词 1-关键词 2-关键词 3"格式的关键词组

### 1.9.24 (2025-05-24)

- **同义关键词支持**：添加了支持同义关键词的功能，使用横杠"-"分隔同义词
- **关键词下载优化**：完善关键词匹配机制，支持多个同义词匹配同一关键词组
- **目录结构灵活性**：同义关键词匹配时自动使用完整同义词组作为目录名

### 1.9.23 (2025-05-22)

- **文件结构优化**：统一了常规下载和关键词下载的目录结构，确保文件始终保存在正确的频道子目录中
- **信息文件简化**：移除了冗余的`channel_info.txt`文件，简化`title.txt`仅保留标题信息
- **目录处理逻辑重构**：优化了目录创建逻辑，确保在所有下载模式下正确创建频道目录
- **变量处理改进**：改进了目录路径变量处理，特别是关键词模式下的路径处理
- **处理逻辑标准化**：统一了媒体组和单独消息的处理逻辑，保持一致的目录结构

### 1.9.20 (2025-05-12)

- **初始化状态界面管理**：添加程序启动过程中的初始化状态管理，在初始化过程中显示状态提示并禁用界面操作
- **错误修复**：解决程序未全部初始化完成时用户点击导航树模块导致的错误问题
- **用户体验改进**：通过状态栏背景颜色变化和文字提示，提供明确的初始化过程视觉反馈
- **界面状态管理优化**：添加统一的界面初始化状态管理方法，提高界面响应稳定性

### 1.9.19 (2025-05-10)

- **应用代码重构**：将大型的`app.py`文件拆分为多个模块化文件，使代码更易于维护
- **架构优化**：通过合理的模块化设计，减少了各组件之间的紧耦合
- **错误修复**：修复了`ThemeManagerWrapper`类中缺少`get_current_theme_name`方法的问题

### 1.9.18 (2025-05-08)

- **登录功能优化**：改进首次登录体验，添加自动引导和友好的指导对话框
- **验证码输入界面增强**：优化验证码输入流程，增加格式限制和智能按钮状态控制
- **登录状态反馈改进**：提供更详细的登录状态反馈，及时更新 UI 界面显示
- **异步登录流程优化**：完善登录过程中的异常处理机制，确保线程安全和 UI 响应性

### 1.9.17 (2025-05-05)

- **数据库锁定错误修复**：解决"database is locked"错误问题，添加自动修复机制和用户提示
- **客户端恢复机制增强**：优化客户端停止和重启流程，减少资源泄漏，提高应用稳定性
- **智能错误处理**：新增错误追踪系统，及时识别并处理持续出现的数据库锁定问题

### 1.9.16 (2025-05-02)

- **状态栏显示问题修复**：彻底解决了代理断开后状态栏客户端状态不更新的问题
- **连接管理机制优化**：增强了代理错误检测能力，添加超时处理，提高网络状态变化响应速度
- **UI 体验改进**：优化了状态栏显示效果，断开连接时使用红色高亮提示，更直观地反映连接状态

### 1.9.15 (2025-04-30)

- **代理连接管理优化**：修复代理断开时状态栏不更新问题，改进代理连接恢复后的自动重连机制
- **网络状态检测增强**：优化网络连接状态检测频率，提高系统对网络变化的响应速度
- **代理配置处理改进**：客户端重启时自动刷新代理配置，确保始终使用最新设置

### 1.9.14 (2025-04-28)

- **移除网络延时显示功能**：从状态栏中移除了网络延时显示功能，保留客户端连接状态功能
- **界面精简**：优化状态栏布局，提供更简洁的用户界面

### 1.9.13 (2025-04-26)

- **任务统计优化**：优化了状态栏中的任务统计显示，提供更直观的任务状态反馈
- **资源监控改进**：改进 CPU 和内存使用率显示，更新更及时

### 1.9.12 (2025-04-25)

- **用户界面简化与优化**：移除任务概览组件中的任务计数器部分，避免与状态栏中的任务统计信息重复，优化任务列表显示区域，为活动任务提供更多展示空间
- **任务组件协同改进**：增强了 TaskView 类中的任务统计功能，实现任务视图和状态栏的实时数据同步，优化了任务添加和移除逻辑，确保 UI 状态一致性

### 1.9.11 (2025-04-22)

- **状态栏信息增强**：新增任务统计信息实时显示功能，在状态栏动态展示运行中、等待中和已完成的任务数量，并根据任务状态自动调整显示颜色，提供更直观的视觉反馈
- **任务状态管理改进**：优化任务操作方法（暂停、恢复、取消），确保操作后状态统计自动更新，并实现了任务状态在多个视图组件间的同步
- **应用关闭优化**：增强应用关闭时的资源清理流程，确保所有定时器和任务得到妥善处理，提高程序稳定性

### 1.9.10 (2025-04-20)

- **视图加载错误修复**：修复主窗口 `get_view` 方法导致的视图加载错误，重构视图获取逻辑，确保延迟加载视图时能正确获取，提高应用在视图尚未创建时的健壮性

### 1.9.8 (2025-04-17)

- **从 QtAsyncio 迁移到 qasync**：移除对 PySide6.QtAsyncio 的依赖，改用 qasync 库实现 Qt 与 asyncio 的集成，修复了网络连接功能（`QAsyncioEventLoop.create_connection()`）未实现的问题
- **重构异步工具模块**：优化`async_utils.py`，提供更稳定的 Qt 和 asyncio 集成，完善事件循环初始化和运行逻辑
- **增强错误处理**：添加更完善的事件循环管理和异常处理机制，确保系统在各种情况下的稳定运行
- **添加测试工具**：提供`test_qasync.py`测试脚本，验证异步任务创建和网络请求功能

### 1.9.7 (2025-04-15)

- **核心服务集成**：将`run.py`中的核心服务（客户端管理、配置系统、日志等）完全集成到图形界面程序中，确保所有核心服务支持 QtAsyncio
- **功能组件集成**：在`TGManagerApp`类中集成了所有核心功能组件，实现了下载、上传、转发和监听模块的完整功能，并将这些功能模块连接到相应的视图组件
- **应用初始化优化**：重构异步运行流程，确保各服务以正确的顺序启动，提高应用稳定性和响应性

### 1.9.2 (2025-04-10)

- **多协程并发演示功能修复**：修复了 QtAsyncio 测试模块中点击"停止演示"后素数计算任务仍在后台运行的问题，完善了任务管理机制，确保所有子任务能够被正确取消
- **应用关闭逻辑优化**：修复了应用程序关闭时出现的"Event loop is already running"错误，优化了事件循环处理逻辑，提高了应用程序关闭过程的稳定性

### 1.9.1 (2025-04-10)

- **配置管理系统完全统一**：完成所有模块从`ConfigManager`到`UIConfigManager`的迁移，包括上传模块、转发模块和监听模块，确保配置管理的一致性和简洁性
- **模块初始化过程优化**：重构各功能模块的初始化过程，统一配置访问方式，提高代码可维护性

### 1.9.0 (2025-04-09)

- **配置管理系统优化**: 移除了`UIConfigManager`中未使用的兼容方法，统一采用更直接的配置访问模式，简化了配置处理流程。
- **项目集成计划完善**: 更新了`ui_assembly_plan.md`文件中的配置管理系统统一部分，提供了更清晰的配置获取示例代码。

### 1.8.9 版本更新 (2025-04-08)

- **配置管理系统完全统一**: 完成了将所有模块从`ConfigManager`到`UIConfigManager`的迁移工作，包括更新了`downloader.py`模块，并为其他模块准备了迁移方案。
- **项目集成计划文档更新**: 更新了`ui_assembly_plan.md`文件，详细记录了配置管理系统统一的实施过程，添加了每个模块的具体迁移步骤和代码示例。

### 1.8.8 版本更新 (2025-04-07)

- **配置管理系统统一**: 所有模块现在统一使用 `UIConfigManager` 进行配置管理，不再使用 `ConfigManager`。这一变更简化了配置架构，提高了代码可维护性，并确保 UI 界面与核心功能模块之间的配置一致性。
- **配置工具优化**: 新增 `config_utils.py` 工具模块，提供配置转换功能，使各模块能够以统一的方式处理配置数据。

### 2025-04-11

- 修复了拖动工具栏时频繁保存配置的问题，现在拖动过程中不会触发多次保存，只在拖动结束后保存一次
- 添加了防抖功能，避免短时间内重复保存窗口状态，提高应用响应性能
- 优化了 UI 事件处理机制，减少了不必要的配置文件写入操作

### 2025-04-10

- 重构主窗口代码，将单一的大型 MainWindow 类拆分为多个功能模块
- 使用混入类(Mixin)模式提高代码可维护性
- 改进了工具栏和状态栏功能

详细更新内容请查看 [CHANGELOG.md](CHANGELOG.md)。

## 主要功能

- **媒体下载**：从 Telegram 频道下载媒体文件，支持多种格式、关键词过滤
- **媒体上传**：将本地媒体文件上传到 Telegram 频道，支持批量处理
- **实时监听**：监听频道和群组的新消息，支持关键词匹配和自动处理
- **任务管理**：支持任务暂停、继续和取消，提供进度追踪
- **消息转发**：在不同频道间智能转发消息和媒体，自动处理权限限制
- **资源管理**：高效管理文件资源，支持锁定和自动清理机制
- **图形界面**：提供基于 PySide6 的图形用户界面，支持所有核心功能
- **用户界面**：清晰的状态更新、进度显示和错误提示，完全分离的业务逻辑和 UI 交互

## 配置说明

TG-Manager 使用 JSON 配置文件来存储应用设置。默认配置文件为项目根目录下的 `config.json`。项目中提供了 `config_example.json` 作为示例配置，您可以复制并根据需要修改。

### 配置文件自动创建

从版本 1.8.4 开始，TG-Manager 支持自动创建默认配置文件。当您首次启动程序或配置文件不存在时，程序会自动创建一个包含所有必要配置项的 `config.json` 文件。默认配置包含示例值和占位符，您可以通过程序的设置界面轻松修改这些值：

1. 启动 TG-Manager
2. 进入设置界面（点击工具栏上的设置图标或在文件菜单中选择"设置"）
3. 在设置界面中填写您的 Telegram API ID 和 API Hash，以及其他必要设置
4. 点击"保存设置"按钮应用更改

自动创建的配置文件包含完整的结构，即使某些配置项具有默认的占位符值，程序仍然可以正常启动，让您能够通过界面配置各项功能。

### 配置文件权限问题

如果程序在启动或运行过程中检测到配置文件(`config.json`)为只读或无法写入，将会显示一个错误对话框，提示权限错误并给出解决建议。您可以尝试以下方法解决：

1. **修改文件权限**：右键点击 `config.json` 文件 -> 属性 -> 取消勾选"只读"属性
2. **以管理员身份运行程序**：右键点击程序图标 -> 以管理员身份运行
3. **移动程序**：将整个程序移动到您有完全访问权限的目录

程序检测到权限问题时会立即退出，您需要修复问题后重新启动程序。

## 配置文件结构

配置文件`config.json`的主要结构如下：

```json
{
  "GENERAL": {
    "api_id": 123456, // Telegram API ID
    "api_hash": "your_api_hash_here", // Telegram API Hash
    "phone_number": "+123456789", // Telegram账号手机号码
    "limit": 50, // 每次请求的消息限制数
    "pause_time": 60, // 操作间隔时间(秒)
    "timeout": 30, // 请求超时时间(秒)
    "max_retries": 3, // 最大重试次数
    "proxy_enabled": false, // 是否启用代理
    "proxy_type": "SOCKS5", // 代理类型
    "proxy_addr": "127.0.0.1", // 代理地址
    "proxy_port": 1080, // 代理端口
    "proxy_username": null, // 代理用户名(可选)
    "proxy_password": null, // 代理密码(可选)
    "auto_restart_session": true // 会话控制：Telegram会话在意外断开后是否自动重连(默认为true)
  },
  "DOWNLOAD": {
    "downloadSetting": [
      // 下载设置列表
      {
        "source_channels": "@channel1", // 源频道
        "start_id": 0, // 起始消息ID (0表示从最新消息开始)
        "end_id": 0, // 结束消息ID (0表示下载到最早消息)
        "media_types": ["photo", "video", "document", "audio", "animation"], // 要下载的媒体类型
        "keywords": ["关键词1", "关键词2"] // 关键词列表(用于关键词下载模式)
      }
    ],
    "download_path": "downloads", // 下载文件保存路径
    "parallel_download": false, // 是否启用并行下载
    "max_concurrent_downloads": 10 // 最大并发下载数
  },
  "UPLOAD": {
    "target_channels": ["@target_channel1", "@target_channel2"], // 目标频道列表
    "directory": "uploads", // 上传文件目录
    "caption_template": "{filename} - 上传于 {date}", // 说明文字模板
    "delay_between_uploads": 0.5, // 上传间隔时间(秒)
    "options": {
      // 上传选项
      "use_folder_name": true, // 是否使用文件夹名称作为说明文字
      "read_title_txt": false, // 是否读取title.txt文件作为说明文字
      "use_custom_template": false, // 是否使用自定义模板
      "auto_thumbnail": true // 是否自动生成视频缩略图
    }
  },
  "FORWARD": {
    "forward_channel_pairs": [
      // 转发频道对列表
      {
        "source_channel": "@source_channel1", // 源频道
        "target_channels": ["@target_channel1", "@target_channel2"], // 目标频道列表
        "send_final_message": true,
        "final_message_html_file": "messages/final_message.html"
      }
    ],
    "remove_captions": false, // 是否移除媒体说明文字
    "hide_author": false, // 是否隐藏原作者
    "media_types": ["photo", "video", "document", "audio", "animation"], // 要转发的媒体类型
    "forward_delay": 0.1, // 转发间隔时间(秒)
    "start_id": 0, // 起始消息ID
    "end_id": 0, // 结束消息ID
    "tmp_path": "tmp" // 临时文件路径
  },
  "MONITOR": {
    "monitor_channel_pairs": [
      // 监听频道对列表
      {
        "source_channel": "@source_channel1", // 源频道
        "target_channels": ["@target_channel1", "@target_channel2"], // 目标频道列表
        "remove_captions": false, // 是否移除媒体说明文字
        "text_filter": [
          // 文本替换规则
          {
            "original_text": "要替换的文本",
            "target_text": "替换后的文本"
          }
        ]
      }
    ],
    "media_types": ["photo", "video", "document", "audio", "animation", "sticker", "voice", "video_note"], // 要监听的媒体类型
    "duration": "2099-12-31", // 监听截止日期
    "forward_delay": 1.0 // 转发间隔时间(秒)
  },
  "UI": {
    "theme": "深色主题", // 界面主题
    "confirm_exit": true, // 退出时是否需要确认
    "minimize_to_tray": true, // 是否最小化到系统托盘
    "start_minimized": false, // 是否以最小化状态启动
    "enable_notifications": true, // 是否启用通知
    "notification_sound": true // 是否启用通知声音
  }
}
```

### GENERAL 部分

GENERAL 部分包含应用程序的基本设置，包括：

- Telegram API 凭据：`api_id`和`api_hash`
- 代理设置：`proxy_enabled`、`proxy_type`、`proxy_addr`等
- 基本操作参数：`limit`、`pause_time`、`timeout`等
- 会话控制：`auto_restart_session`控制 Telegram 会话在意外断开后是否自动重连(默认为 true)

### 频道标识格式

TG-Manager 支持以下几种格式的频道标识：

- **用户名格式**：`@username`，例如 `@telegram`
- **链接格式**：`https://t.me/username`，例如 `https://t.me/telegram`
- **ID 格式**：数字 ID，例如 `-1001234567890`

## 最新更新 (v1.9.68)

### 🔧 修复
- **文本替换功能修复**: 修复了监听模块中单条消息的文本替换功能失效问题
  - 修复非禁止转发频道的单条消息无法应用文本替换规则的问题
  - 统一使用`copy_message`方式确保文本替换功能在所有情况下都能正常工作
  - 现在所有类型的消息都能正确应用配置的文本替换规则

### 🔧 v1.9.67 修复
- **转发事件发射完善**: 修复了禁止转发频道消息处理中的事件发射缺失问题

### 监听功能
- **实时监听**：监听指定Telegram频道的新消息
- **智能转发**：自动转发消息到目标频道
- **消息过滤**：支持多种过滤条件
  - 排除转发消息、回复消息、媒体消息、包含链接的消息
  - 关键词过滤：只转发包含指定关键词的消息
  - **媒体类型过滤**：选择性转发特定类型的媒体（照片、视频、文件、音频、动画、贴纸、语音、视频笔记）
  - **过滤日志**：实时显示被过滤的消息及过滤原因，便于用户了解过滤情况
- **文本替换**：支持文本内容的自动替换
- **标题处理**：可选择移除媒体文件的标题说明
- **禁转处理**：自动处理禁止转发的频道内容
- **监听日志**：实时显示监听状态、消息接收和转发情况

## 版本历史

### 1.9.98 (2025-06-05) - 🚀 禁止转发媒体组效率优化和文件冲突修复
- **🎯 根本问题解决**: 彻底修复禁止转发频道媒体组转发中的文件访问冲突和效率问题
  - 问题分析：多个目标频道同时下载同一媒体组导致文件冲突 `[WinError 32] 另一个程序正在使用此文件`
  - 根本原因：每个禁止转发频道都独立调用`ParallelProcessor`，造成重复下载和文件竞争
  - 用户需求：第一个目标频道上传成功后，应该直接从第一个目标频道使用copy媒体组的方法发送到其余频道
- **🔧 智能优化方案**:
  - **分离处理逻辑**：区分正常转发和禁止转发频道，避免混合处理
  - **顺序处理策略**：先对所有频道尝试正常转发，识别禁止转发频道，然后统一处理
  - **效率最大化**：只对第一个禁止转发频道使用下载上传，其他频道从第一个频道复制转发
  - **文件冲突消除**：避免多个`ParallelProcessor`实例同时访问相同文件
- **📊 技术实现详情**:
  - **新方法架构**：
    - `_send_modified_media_group()` → 分离正常和禁止转发频道
    - `_handle_restricted_targets()` → 统一处理所有禁止转发频道
    - `_copy_from_first_target()` → 从第一个成功频道复制转发到其他频道
  - **处理流程优化**：
    ```
    正常频道 → 直接send_media_group
    禁止转发频道 → 第一个:下载上传 → 其他:复制转发
    ```
  - **资源管理改进**：单一临时目录，避免重复下载，智能清理资源
- **⚡ 性能提升效果**:
  - ✅ 消除文件访问冲突错误
  - ✅ 大幅减少网络带宽使用（避免重复下载）
  - ✅ 提高处理速度（复制转发比重新上传快）
  - ✅ 降低磁盘I/O和临时文件占用
  - ✅ 保持100%的转发成功率

### 1.9.97 (2025-06-05) - 🔥 禁止转发媒体组完全修复
