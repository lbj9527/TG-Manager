# TG Forwarder

TG Forwarder 是一个功能强大的 Telegram 消息转发工具，用于在不同的 Telegram 频道、群组或聊天之间转发消息。

## 功能特点

- **历史消息转发**：将源频道的历史消息按原格式转发到目标频道
- **媒体文件下载**：下载源频道的图片、视频、文件等媒体内容
- **本地文件上传**：将本地文件上传至目标频道，支持媒体组
- **实时消息监听**：监听源频道的新消息并实时转发至目标频道

## 项目结构

项目主要目录结构：

```
TG-Manager/
├── config.json         # 配置文件
├── history/            # 历史记录文件目录
│   ├── download_history.json    # 下载历史记录
│   ├── upload_history.json      # 上传历史记录
│   └── forward_history.json     # 转发历史记录
├── downloads/          # 下载的媒体文件目录
├── uploads/            # 待上传的媒体文件目录
├── tmp/                # 临时文件目录
├── logs/               # 日志文件目录
└── src/                # 源代码目录
```

## 安装方法

1. 克隆仓库：

```bash
git clone https://github.com/yourusername/tg-forwarder.git
cd tg-forwarder
```

2. 安装依赖：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

3. 配置 `config.json` 文件：
   - 添加您的 Telegram API ID 和 API Hash
   - 配置转发、下载、上传和监听的相关参数

## 使用方法

TG Forwarder 提供四种主要命令：

1. **历史消息转发**：

```bash
python run.py forward
```

2. **媒体文件下载**：

```bash
python run.py download
```

3. **本地文件上传**：

```bash
python run.py upload
```

4. **实时消息监听**：

```bash
python run.py startmonitor
```

## 配置说明

详细的配置信息请参考 `config.json` 文件，主要包括：

- **通用配置**：API 凭据、代理设置、消息限制等
- **下载配置**：源频道、消息范围、下载路径、并行下载设置等
- **上传配置**：目标频道、本地文件路径等
- **转发配置**：频道映射关系、转发延迟、媒体类型等
- **监听配置**：监听频道、持续时间、转发设置等

## 功能说明

### 历史消息转发

支持在不同频道间转发历史消息，可以保留原始格式并设置消息筛选条件。对于禁止转发的频道，会自动采用"下载后上传"的方式完成转发。消息转发按照原始发送顺序进行（从旧到新），确保转发内容按照时间顺序展示，与文件下载顺序保持一致。

#### 并行下载上传功能

从 0.5.0 版本开始，TG Forwarder 引入了真正的并行下载和上传功能，特别适用于禁止直接转发的频道：

1. **生产者-消费者模式**：采用高效的生产者-消费者架构，实现媒体组的并行处理

   - 生产者负责下载媒体组消息和文件
   - 消费者负责将下载好的媒体组上传到目标频道
   - 两个过程并行执行，大幅提高转发效率

2. **高效媒体组处理**：

   - 自动检测已转发的媒体组，避免重复转发
   - 智能管理本地文件，成功上传后自动清理
   - 详细的转发状态日志，清晰展示每个媒体组的处理情况

3. **特性与优势**：

   - 显著提高转发速度，尤其对大量媒体文件的处理
   - 减少内存占用，支持更大规模的批量转发
   - 完善的错误处理和重试机制，提高转发成功率
   - 精确的转发历史记录，避免重复操作

4. **配置示例**：
   ```json
   "FORWARD": {
     "start_id": 1,
     "end_id": 5000,
     "forward_channel_pairs": [
       {
         "source_channel": "@source_channel",
         "target_channels": ["@target_channel1", "@target_channel2"]
       }
     ],
     "forward_delay": 2,
     "remove_captions": false,
     "media_types": ["photo", "video", "document", "audio", "animation", "text"],
     "tmp_path": "tmp"
   }
   ```

通过合理配置并行下载参数，可以在保证稳定性的同时，获得数倍于顺序下载的性能提升。

### 媒体文件下载

可以下载指定频道的历史消息中包含的媒体文件，支持多种文件类型，并能按源频道分类保存。下载的文件将保存在以"频道标题-频道 ID"命名的文件夹中，使得文件组织更加直观。如果无法获取频道标题，则使用"未知频道"作为默认标题。媒体文件下载按照消息发送的原始时间顺序进行（从旧到新），确保下载的内容保持时间连贯性。

下载模式支持三种方式：

- **顺序下载**：默认模式，按照消息 ID 顺序依次下载文件，适合网络条件较差或需要严格控制带宽占用的场景。
- **并行下载**：通过设置`parallel_download`为`true`启用，可同时下载多个文件，显著提高下载速度。可通过`max_concurrent_downloads`参数控制最大并行下载数量（默认为 10）。
- **关键词下载**：通过命令`python run.py downloadKeywords`启用，仅下载包含指定关键词的消息中的媒体文件，同时将下载的文件按关键词组织存放。

> 自 0.7.2 版本起，普通下载和关键词下载均使用相同的配置结构（`downloadSetting`数组），唯一区别是在关键词下载模式下会使用`keywords`字段进行筛选，而在普通下载模式下则忽略该字段。不再使用顶层的`source_channels`、`start_id`和`end_id`字段。

#### 统一的下载配置示例

```json
"DOWNLOAD": {
  "downloadSetting": [
    {
      "source_channels": "https://t.me/channel1",
      "start_id": 1000,
      "end_id": 2000,
      "media_types": ["photo", "video", "document"],
      "keywords": ["重要", "公告"]  // 普通下载模式忽略此字段，关键词下载模式使用此字段
    },
    {
      "source_channels": "https://t.me/channel2",
      "start_id": 5000,
      "end_id": 0,  // 0表示下载到最新消息
      "media_types": ["photo", "video", "document", "audio", "animation"],
      "keywords": ["测试", "预览"]
    }
  ],
  "download_path": "downloads",
  "parallel_download": true,
  "max_concurrent_downloads": 10
}
```

#### 关键词下载功能

从 0.7.0 版本开始，TG Forwarder 添加了关键词下载功能，支持根据消息文本内容筛选需下载的媒体：

1. **智能关键词匹配**：

   - 自动检测消息文本和说明文字中的关键词
   - 支持设置多个关键词，匹配任一关键词即下载
   - 忽略大小写，提高匹配准确性和灵活性
   - 增强的媒体组处理：当媒体组中任意一条消息匹配关键词时，自动下载整个媒体组所有文件，确保相关媒体内容完整性

2. **目录智能组织**：

   - 按照匹配的关键词自动创建子目录
   - 相同关键词的媒体文件集中存放，便于管理
   - 支持"频道名称/关键词"的层级目录结构

3. **精细化配置**：

   - 通过`downloadSetting`数组为不同频道设置不同的关键词
   - 每个设置项可单独指定消息 ID 范围、媒体类型和关键词列表
   - 实现多频道、多关键词的精确下载策略

4. **配置示例**：

   ```json
   "DOWNLOAD": {
     "downloadSetting": [
       {
         "source_channels": "https://t.me/channel1",
         "start_id": 1000,
         "end_id": 2000,
         "media_types": ["photo", "video"],
         "keywords": ["风景", "自然"]
       },
       {
         "source_channels": "https://t.me/channel2",
         "start_id": 5000,
         "end_id": 0,
         "media_types": ["photo", "video", "document"],
         "keywords": ["科技", "编程"]
       }
     ],
     "download_path": "downloads",
     "parallel_download": true,
     "max_concurrent_downloads": 10
   }
   ```

5. **使用方式**：
   - 命令行执行：`python run.py downloadKeywords`
   - 使用`keywords`参数指定需要匹配的关键词列表
   - 可结合并行下载功能提高下载效率

#### 媒体组文件夹组织功能

从 0.7.1 版本开始，TG Forwarder 引入了媒体组文件夹组织功能，提供更直观的本地文件结构：

1. **二级目录结构**：

   - 第一级为频道名称目录或关键词目录（根据下载模式自动选择）
   - 第二级为媒体组 ID 目录，每个媒体组的内容存放在独立文件夹中
   - 自动处理文件名中的非法字符，确保在各操作系统上兼容

2. **媒体组文本文件**：

   - 自动为每个媒体组创建文本文件，存储消息的文字内容
   - 文本文件以媒体组 ID 命名，便于与媒体文件关联
   - 支持 UTF-8 编码，确保多语言文字正确显示

3. **统一的组织逻辑**：

   - 在普通下载和关键词下载模式下使用一致的文件组织逻辑
   - 单条消息也以独立文件夹形式存储，提供统一的访问体验
   - 相关内容集中存放，便于查找和管理

4. **使用优势**：

   - 大幅提高相关媒体文件的查找效率
   - 保留媒体组的完整上下文信息，包括文字和媒体内容
   - 媒体组内文件关联更加清晰，避免在大量文件中寻找相关内容的困扰
   - 适用于多人制作内容的频道，便于按主题或内容系列管理下载文件

5. **目录结构示例**：
   ```
   downloads/
   ├── 频道名称-123456/                # 频道目录
   │   ├── 1234567890/                # 媒体组ID目录
   │   │   ├── title.txt           # 媒体组文本文件
   │   │   ├── 123456-100-photo.jpg   # 媒体文件1
   │   │   └── 123456-101-video.mp4   # 媒体文件2
   │   └── single_102/                # 单条消息目录
   │       ├── title.txt           # 消息文本文件
   │       └── 123456-102-photo.jpg   # 媒体文件
   └── 关键词/                        # 关键词目录（关键词下载模式）
       └── 7654321098/                # 媒体组ID目录
           ├── title.txt           # 媒体组文本文件
           ├── 654321-200-photo.jpg   # 媒体文件1
           └── 654321-201-video.mp4   # 媒体文件2
   ```

#### 并行下载高级功能

并行下载模式提供以下高级功能和优势：

1. **高效工作协程池**：系统会自动创建多个工作协程，确保始终保持指定数量的并发下载任务，大幅提高下载速度。

2. **智能文件写入**：实现了多线程文件写入池，避免文件 I/O 成为性能瓶颈，特别适合大量小文件的下载场景。

3. **自适应性能优化**：

   - 自动检测文件大小并显示预估下载时间
   - 实时计算并显示下载速度
   - 智能处理 Telegram API 速率限制，确保下载连续性

4. **详细性能监控**：

   - 显示每个下载任务的工作协程 ID
   - 跟踪文件大小、下载耗时和速度
   - 监控当前活跃下载数量和等待队列状态

5. **高级错误处理**：

   - 全局自适应速率限制处理，智能应对 Telegram 的 FloodWait 限制
   - 自动重试机制，对下载失败的文件进行多次尝试
   - 指数退避策略，自动增加重试间隔，避免连续触发限制
   - 下载内容验证，确保每个文件完整下载，防止文件损坏

6. **配置示例**：
   ```json
   "DOWNLOAD": {
     "start_id": 1,
     "end_id": 1000,
     "source_channels": ["@channel1", "@channel2"],
     "organize_by_chat": true,
     "download_path": "downloads",
     "media_types": ["photo", "video", "document", "audio", "animation", "sticker"],
     "parallel_download": true,
     "max_concurrent_downloads": 10
   }
   ```

通过合理配置并行下载参数，可以在保证稳定性的同时，获得数倍于顺序下载的性能提升。

### 本地文件上传

将本地文件上传到指定频道，支持按文件夹组织媒体组，并可以设置自定义文本。

#### 媒体组标题功能

从 0.7.4 版本开始，TG Forwarder 支持从文件夹中的 title.txt 文件读取内容作为媒体组或单个文件的说明文字（caption）：

1. **智能标题读取**：

   - 自动从媒体组文件夹中的 title.txt 读取内容作为上传时的说明文字
   - 支持单个文件上传和媒体组上传
   - 如果 title.txt 不存在或读取失败，自动回退到使用文件夹名称或默认模板

2. **使用方式**：

   - 在需要上传的文件夹中创建一个名为 title.txt 的文本文件
   - 在文件中编写需要显示的说明文字
   - 系统会自动读取该文件内容，并将其作为上传文件时的 caption
   - 上传时会自动跳过 title.txt 文件本身，只上传其他媒体文件

3. **多频道上传一致性**：

   - 同一媒体组上传到多个频道时，所有频道都会使用相同的说明文字
   - 确保内容在不同频道间的一致性

4. **与下载模块的协同**：
   - 与下载模块生成的 title.txt 格式兼容
   - 下载后的媒体文件可以直接通过上传模块发送到其他频道，保留原始说明文字

#### 视频缩略图功能

从 0.6.0 版本开始，TG Forwarder 支持为视频文件自动生成和上传缩略图：

1. **智能缩略图生成**：

   - 自动从视频中提取第一帧作为缩略图
   - 智能调整尺寸，确保符合 Telegram API 要求（不超过 320×320 像素）
   - 自动压缩图片质量，保证缩略图大小在 200KB 以内

2. **增强视频上传体验**：

   - 单个视频文件和媒体组中的视频都支持缩略图
   - 上传完成后自动清理缩略图资源，避免占用存储空间
   - 为多频道上传优化，确保所有频道都能看到缩略图预览

3. **资源管理与性能优化**：

   - 临时缩略图存储在`tmp/thumb`目录
   - 文件处理完成后自动清理缩略图资源
   - 优化缩略图内存管理，防止内存泄漏

4. **使用方式**：
   - 无需额外配置，系统自动为视频文件生成缩略图
   - 支持所有常见视频格式
   - 适用于单一视频上传和媒体组上传

### 实时消息监听

监听指定频道的新消息，并实时转发到目标频道，支持设置消息过滤条件和监听时长。
