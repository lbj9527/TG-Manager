# TG-Manager 变更日志

## [v2.3.5] - 2024-12-22

### 🔧 修复
- **转发模块初始化错误修复**：
  - 修复`Forwarder`类构造函数参数缺失导致的初始化失败
  - 在`async_services.py`中正确传递`downloader`和`uploader`参数给`Forwarder`
  - 确保转发模块能够正常初始化和工作
  - 解决组件初始化失败导致的转发功能不可用问题

### 📝 技术细节
- **问题识别**：`Forwarder.__init__() missing 1 required positional argument: 'uploader'`
- **根本原因**：`Forwarder`类需要7个参数，但只传递了5个参数
- **修复方案**：在`async_services.py`中添加缺失的`downloader`和`uploader`参数
- **参数列表**：`client`, `ui_config_manager`, `channel_resolver`, `history_manager`, `downloader`, `uploader`, `app`

### 🎯 影响范围
- 转发模块初始化
- 转发功能可用性
- 组件依赖关系

---

## [v2.3.4] - 2024-12-22

### 🔧 修复
- **首次登录代理配置支持**：
  - 修复首次登录时未从设置界面读取代理配置的问题
  - 在首次登录流程中添加代理配置的读取和验证
  - 确保首次登录时使用用户配置的代理设置连接Telegram
  - 添加代理配置验证，确保启用代理时填写了有效的代理地址
  - 在日志中记录代理使用情况，便于调试和监控

### 📝 技术细节
- **问题识别**：首次登录时只读取API凭据，忽略代理配置，导致网络连接超时
- **修复方案**：在`_handle_first_login`方法中添加代理配置读取逻辑
- **代理验证**：检查代理地址是否为空，确保配置完整性
- **配置应用**：将界面读取的代理配置应用到客户端管理器
- **日志记录**：添加代理使用情况的详细日志输出

### 🎯 影响范围
- 首次登录流程
- 网络连接稳定性
- 代理配置支持

---

## [v2.3.3] - 2024-12-22

### 🔧 修复
- **翻译文件重复键修复**：
  - 修复中英文翻译文件中`ui.login.errors`部分的重复键问题
  - 合并两个重复的`errors`对象，将所有登录相关错误消息统一到一个`errors`对象中
  - 确保JSON文件语法正确，避免解析错误
  - 保持所有翻译键的完整性和一致性
  - 验证修复后的翻译文件可以正常加载和使用

### 📝 技术细节
- **问题识别**：在`ui.login`部分存在两个重复的`errors`键，导致JSON解析冲突
- **修复方案**：将第二个`errors`对象中的键合并到第一个`errors`对象中
- **影响范围**：`settings_not_open_title`、`settings_not_open_msg`、`invalid_api_id_title`、`invalid_api_id_msg`等键
- **验证方法**：使用Python的json模块验证文件语法正确性

### 🎯 影响范围
- 翻译文件结构
- 登录错误消息显示
- 多语言支持稳定性

---

## [v2.3.2] - 2024-12-22

### 🔧 修复
- **会话名称验证和默认值优化**：
  - 为会话名称输入框添加严格的格式验证
  - 会话名称只能包含英文字母、数字和下划线，且必须以英文字母开头
  - 在保存配置时验证会话名称格式，不符合要求时显示错误提示
  - 在会话名称输入框下方添加格式说明提示
  - 验证错误消息和提示信息支持中英文切换
  - 将默认会话名称从 `"tg_manager_session"` 改为 `"tg_manager"`
  - 更新UI配置模型、配置文件示例和设置界面的默认值
  - 保持向后兼容性，现有配置文件不受影响

### 📝 技术细节
- **验证逻辑**：使用正则表达式 `^[a-zA-Z][a-zA-Z0-9_]*$` 验证会话名称格式
- **验证位置**：在 `_validate_settings()` 方法中添加会话名称验证逻辑
- **用户提示**：添加 `session_name_tip` 翻译键，提供用户友好的格式说明
- **翻译更新**：更新中英文翻译文件，添加验证错误消息
- **默认值统一**：所有相关文件中的默认会话名称都改为 `"tg_manager"`

### 🎯 影响范围
- API设置界面
- 配置文件结构
- 会话名称验证
- 用户输入体验

---

## [v2.3.1] - 2024-12-22

### 🔧 修复
- **会话名称配置修复**：完善API设置界面中会话名称的保存和读取功能
  - 修复设置界面中会话名称未保存到配置文件的问题
  - 修复客户端启动时未使用配置文件中的会话名称的问题
  - 在UIGeneralConfig模型中添加session_name字段
  - 在config_utils.py中添加session_name字段的转换处理
  - 修复设置界面的_collect_settings和load_config方法
  - 修改ClientManager从配置中读取session_name
  - 更新config-example.json包含session_name字段
  - 添加会话名称的日志输出，便于调试和监控

### 📝 技术细节
- **UI配置模型更新**：在UIGeneralConfig中添加session_name字段，默认值为"tg_manager_session"
- **配置转换工具完善**：convert_ui_config_to_dict函数现在支持session_name字段的转换
- **设置界面修复**：_collect_settings方法现在收集session_name，load_config方法现在加载session_name
- **客户端管理器优化**：ClientManager初始化时优先使用配置文件中的会话名称，如果不存在则使用默认值
- **向后兼容性**：保持与现有配置文件的兼容性，如果配置中没有session_name字段，使用默认值

### 🎯 影响范围
- API设置界面
- 配置文件结构
- 客户端启动流程
- 会话管理

---

## [v2.3.0] - 2024-12-22

### 🗄️ 重大升级
- **历史记录管理架构重大升级**：将历史记录管理从JSON文件迁移到SQLite数据库
  - 解决JSON文件无限增大、性能低下、并发安全差等问题
  - 数据库查询性能比JSON文件提升10-100倍
  - 使用SQLite的WAL模式和事务机制，确保多线程环境下的数据一致性
  - 支持数据清理、备份、统计等高级功能
  - 采用标准化的数据库设计，便于扩展和维护

### 📊 技术实现
- 设计三张核心表：下载历史、上传历史、转发历史
- 保持与原有API完全兼容，无缝迁移
- 支持索引优化、批量操作、连接池等高级特性
- 完善的错误处理和日志记录机制

### 🔄 模块迁移
- 完成下载、上传、转发三大核心模块的数据库化改造
- 保持所有现有功能不变，平滑升级无风险

---

## [v2.2.43] - 2024-12-22

### 🔧 修复
- 修复监听界面初始化时的`AttributeError`错误
- 添加缺失的`_update_translations`方法实现
- 完善监听界面的动态语言切换功能
- 确保所有UI组件都能正确响应语言变更
- 优化翻译更新的异常处理和日志记录

---

## [v2.2.42] - 2024-12-22

### 🌐 国际化
- 完成监听界面的全面国际化支持
- 所有UI组件（标签页、按钮、标签、输入框、复选框）的翻译
- 所有消息和对话框的多语言支持
- 编辑对话框的完整翻译
- 右键菜单的本地化
- 状态显示和日志消息的翻译
- 新增120+个翻译键，涵盖监听界面的所有文本元素
- 支持带参数的翻译（如消息ID、频道名称、错误信息等）
- 实现动态语言切换，无需重启应用
- 优化翻译文件结构，采用层次化组织
- 完善错误处理和日志记录的多语言支持

---

## [v2.2.41] - 2024-12-22

### 🌐 国际化
- 完成上传界面的全面国际化支持
- 所有UI组件（标签页、按钮、标签、输入框、复选框）的翻译
- 所有消息框和对话框的多语言支持
- 编辑对话框的完整翻译
- 右键菜单的本地化
- 状态显示和进度消息的翻译
- 新增100+个翻译键，涵盖上传界面的所有文本元素
- 支持带参数的翻译（如文件数量、大小、时间等）
- 实现动态语言切换，无需重启应用
- 优化翻译文件结构，采用层次化组织
- 完善错误处理和异常消息的多语言支持

---

## [v2.2.40] - 2024-12-22

### 🔧 修复
- 修复转发日志中"过滤"文本的硬编码问题
- 添加翻译键`ui.forward.log.filtered`支持"过滤"文本的多语言显示
- 确保所有用户界面元素都支持完整的多语言切换
- 优化日志显示的一致性和可读性

---

## [v2.2.39] - 2024-12-22

### 🌐 国际化
- 完成TG-Manager项目的系统级多语言支持
- 修复所有模块中的硬编码中文消息：
  - 消息过滤模块：单个消息、媒体组消息、媒体类型过滤等
  - 并行处理模块：媒体组描述和格式化
  - 媒体上传模块：媒体组文件描述
  - 文件上传模块：媒体组上传事件
  - 下载模块：下载停止提示
- 新增9个翻译键，支持参数化翻译
- 修复各模块的错误导入语句
- 所有UI显示消息现在都支持中英文切换
- 为国际用户提供完全本地化的使用体验

---

## [v2.2.38] - 2024-12-21

### 🔧 修复
- 修复转发模块中的硬编码中文消息问题
- 新增翻译键支持媒体组转发的多语言显示
- 改进转发日志的用户体验
- 优化转发状态显示的一致性

---

## [v2.2.37] - 2024-12-21

### 🎨 界面优化
- 改进转发界面的布局和用户体验
- 优化媒体组转发的显示效果
- 增强转发日志的可读性

---

## [v2.2.36] - 2024-12-20

### 🔧 稳定性改进
- 优化API限流处理机制
- 改进媒体文件处理流程
- 增强错误恢复能力

---

## [v2.2.35] - 2024-12-19

### 🌐 多语言支持
- 实现完整的UI多语言支持
- 支持中文和英文界面切换
- 优化翻译系统架构

---

## [v2.2.34] - 2024-12-18

### 🔧 核心功能优化
- 改进消息转发算法
- 优化媒体组处理逻辑
- 增强系统稳定性

---

## [v2.2.33] - 2024-12-17

### 🎨 用户界面改进
- 优化主界面布局
- 改进任务管理界面
- 增强用户交互体验

---

## [v2.2.32] - 2024-12-16

### 🔧 性能优化
- 优化媒体文件处理性能
- 改进内存使用效率
- 增强并发处理能力

---

## [v2.2.31] - 2024-12-15

### 🌐 国际化支持
- 添加多语言支持框架
- 实现界面元素的本地化
- 为国际用户提供更好的体验

---

## 版本说明

### 语义化版本规范 (SemVer)
- **主版本号 (X)**：不兼容的API修改
- **次版本号 (Y)**：向后兼容的功能性新增
- **修订号 (Z)**：向后兼容的问题修正

### 变更类型
- 🗄️ **重大升级**：架构级别的重大变更
- 🌐 **国际化**：多语言支持相关变更
- 🔧 **修复**：问题修复和错误处理
- 🎨 **界面优化**：用户界面和用户体验改进
- 📊 **技术实现**：技术细节和实现方式
- 🔄 **模块迁移**：模块重构和迁移
- 📝 **技术细节**：技术实现的具体细节
- 🎯 **影响范围**：变更影响的功能模块
