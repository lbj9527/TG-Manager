# TG-Manager 更新日志

## [1.9.88] - 2025-06-01

### 🐛 关键Bug修复
- **修复监听模块"排除纯文本消息"功能无效的问题**
  - 发现并修复了配置转换函数`convert_ui_config_to_dict`中的重大bug：监听配置转换时缺少关键字段
  - 问题原因：在`src/utils/config_utils.py`的监听配置转换部分，没有处理`keywords`、`exclude_forwards`、`exclude_replies`、`exclude_text`、`exclude_links`等关键过滤字段
  - 导致结果：虽然UI界面显示`exclude_text=True`，但在监听器实际使用的配置字典中这些字段缺失，默认为`False`
  - 修复方案：在监听频道对转换逻辑中添加了对所有关键过滤字段的转换处理
  - 现在当用户勾选"排除纯文本消息"后，监听器将正确过滤纯文本消息并在日志中显示过滤信息

### 🎨 用户界面优化
- **优化监听界面关键词输入框的显示效果**
  - 在关键词输入框右侧添加了备注文字"只转发含关键词的消息"，帮助用户理解关键词过滤的作用
  - 同时在主界面和编辑频道对对话框中添加了相同的备注文字
  - 设置关键词输入框的最小宽度为540像素，并支持随程序界面最大化自动扩展宽度
  - 修复了关键词输入框无法自动扩展的问题：设置QFormLayout的字段增长策略为`ExpandingFieldsGrow`，移除阻止扩展的弹性空间
  - 主界面关键词输入框采用水平可扩展的大小策略，能够充分利用可用空间显示更多关键词
  - 备注文字采用最小空间策略，确保不会占用输入框的扩展空间
  - 将备注文字颜色设置为红色(#ff0000)，使其更加醒目，提醒用户关键词过滤的重要作用
  - 备注文字使用12px小字体，既醒目又不会干扰主要内容的阅读
  - 改进了输入框的用户体验，让用户更清楚关键词功能的作用机制

### 🧪 测试验证
- 创建了专门的测试文件验证配置转换修复的正确性
- 测试了从UI配置模型到字典配置的完整转换链路
- 验证了所有关键过滤字段（`keywords`、`exclude_forwards`、`exclude_replies`、`exclude_text`、`exclude_links`）都能正确转换
- 确认了`exclude_text=True`能正确传递到监听器的配置字典中
- 验证了修复后的代码语法正确性

### 🔧 技术细节
- 修复了`src/utils/config_utils.py`第203-205行的监听配置转换逻辑
- 在监听频道对基本字段处理后添加了关键过滤字段的转换循环
- 确保了UI配置模型与监听器配置字典之间的完全兼容性
- 保持了所有字段类型和值的正确性（布尔值、列表等）

### 📋 相关修复历史
- 此次修复解决了1.9.87版本中UI保存bug修复后仍然无法正常过滤纯文本消息的问题
- 1.9.87版本修复了UI保存配置时的键名错误，但配置转换环节仍有问题
- 现在整个"排除纯文本消息"功能链路完全正常：UI界面 → 配置保存 → 配置转换 → 监听器过滤

---

## [1.9.87] - 2025-06-01

### 🐛 关键Bug修复
- **修复监听界面"排除纯文本消息"复选框保存失败的问题**
  - 修复了在监听界面中勾选"排除纯文本消息"后，保存配置时`exclude_text`字段没有正确保存到配置文件的重大bug
  - 问题出现在`_save_config`函数中使用了错误的键名`exclude_media`而不是正确的`exclude_text`
  - 修复了创建`UIMonitorChannelPair`对象时使用错误参数名`exclude_media`的问题，现在正确使用`exclude_text`
  - 此bug影响了两个地方：
    1. 添加频道对时勾选"排除纯文本消息"的保存
    2. 右键编辑频道对时勾选"排除纯文本消息"的保存
  - 现在无论通过添加频道对还是编辑频道对勾选"排除纯文本消息"，都能正确保存到配置文件中

### 🔧 功能增强  
- **增强监听模块的调试日志功能**
  - 在监听器启动时添加详细的过滤配置日志，显示每个频道对的`exclude_forwards`、`exclude_replies`、`exclude_text`、`exclude_links`设置
  - 在消息处理时添加详细的消息类型检测日志，显示消息是否为媒体消息或纯文本消息
  - 在消息过滤时添加详细的过滤决策日志，包括过滤条件和决策结果
  - 在过滤信号发射时添加确认日志，便于调试信号传递问题
  - 这些日志增强将帮助用户诊断"排除纯文本消息"功能是否正常工作

### 🧪 测试验证
- 创建了专门的测试文件验证`exclude_text`功能的完整性
- 测试了`exclude_text`配置的序列化和反序列化
- 验证了不同`exclude_text`值的正确处理
- 确认了向后兼容性：旧配置文件中没有`exclude_text`字段时使用默认值False
- 验证了配置字典结构中正确包含`exclude_text`字段
- 确认了修复后的代码语法正确性

### 🔧 技术细节
- 修复了`_save_config`函数第971行和第980行的错误键名和参数名
- 确保了UI界面、配置模型和保存逻辑之间的一致性
- 保持了与`UIMonitorChannelPair`模型字段定义的完全兼容性

---

## [1.9.86] - 2025-06-01

### 🐛 重大Bug修复
- **修复监听重启后媒体组转发被意外中断的问题**
  - 修复了当监听器停止再重新启动后，MediaGroupHandler的`is_stopping`标志没有被重置，导致所有媒体组转发任务被错误中断的关键bug
  - 在监听器的`start_monitoring`方法中添加了MediaGroupHandler停止标志的重置逻辑
  - 在监听器的`stop_monitoring`方法中添加了等待机制，让正在进行的媒体组转发任务有时间完成后再停止处理器
  - 现在即使在监听器重启后，媒体组（如两个图片的媒体组）也能正常转发，不会出现"任务已停止，中断发送过程"的错误
  - 解决了非禁止转发频道收到媒体组消息并勾选移除媒体说明时发送失败的问题

- **修复监听界面加载配置时的NameError错误**
  - 修复了在`load_config`函数中`exclude_text`变量未定义导致的NameError错误
  - 问题出现在从exclude_media字段改为exclude_text字段时，有一个地方变量名没有完全更新
  - 现在监听界面可以正常加载配置，不会再出现"name 'exclude_text' is not defined"的错误
  - 修复了变量命名不一致导致的界面崩溃问题

- **修复媒体组处理器中过滤逻辑不完整的问题**
  - 修复了媒体组处理器中的链接过滤逻辑，现在能正确检查消息的`caption`字段和`entities`实体，与单条消息处理器保持一致
  - 修复了媒体组处理器中的关键词过滤逻辑，现在同样检查`text`和`caption`字段
  - 解决了含有链接或关键词的媒体说明在媒体组中无法被正确过滤的问题
  - 统一了单条消息和媒体组消息的过滤行为，确保过滤逻辑的一致性

### 🔄 重大功能更改
- **重新设计排除过滤功能：从"排除媒体消息"改为"排除纯文本消息"**
  - 删除了原有的"排除媒体消息"功能，该功能在实际使用中效果不佳
  - 新增"排除纯文本消息"功能，允许用户过滤掉只包含文本而不包含任何媒体内容的消息
  - 更新了UI界面，将复选框从"排除媒体消息"改为"排除纯文本消息"
  - 在配置文件中，字段名从`exclude_media`改为`exclude_text`，同时保持向后兼容性
  - 监听模块的过滤逻辑已相应更新，现在能正确识别和过滤纯文本消息
  - 媒体组处理器也更新了相应的过滤逻辑，确保功能一致性
  - 旧配置文件中的`exclude_media`设置会自动转换为`exclude_text`设置

### 🔧 技术改进
- 改进了监听器生命周期管理，确保各个组件的状态同步
- 增强了媒体组处理器的稳定性，避免状态残留导致的功能异常
- 优化了监听器停止流程，减少对正在进行任务的干扰
- 统一了过滤逻辑实现，提高了代码一致性和可维护性
- 改进了配置文件的兼容性处理，确保旧配置文件能正常迁移

### 🧪 测试验证
- 验证了监听器重启后媒体组转发功能正常工作
- 确认了移除媒体说明选项与媒体组转发的兼容性
- 测试了各种媒体组配置下的转发稳定性
- 验证了四个排除过滤功能在单条消息和媒体组中的一致性
- 测试了新的"排除纯文本消息"功能在各种场景下的正确性
- 验证了配置文件的向后兼容性和自动迁移功能

---

## [1.9.85] - 2025-06-01

### 修复
- 修复程序启动后第一次监听转发时消息遗漏的问题
  - 修复延迟检查逻辑，使用`last_update_time`而不是`first_message_time`来判断是否应该处理媒体组
  - 增加延迟时间从3秒到5秒，确保有足够时间收集完整的媒体组
  - 扩大延迟检查触发条件，从3条消息增加到5条消息
  - 添加双重超时机制：距离最后更新3秒或距离第一条消息10秒时强制处理
  - 添加延迟任务跟踪，避免为同一个媒体组重复创建延迟检查任务
  - 完善任务清理机制，防止内存泄漏
- 修复MediaGroupHandler初始化时缺失属性定义的问题
  - 添加`media_group_timeout`（媒体组超时时间）
  - 添加`media_group_locks`（媒体组锁字典）
  - 添加`last_processed_groups_cleanup`（上次清理已处理媒体组的时间）
  - 添加`last_media_group_fetch`（媒体组获取时间记录）
  - 在stop方法中添加对新增属性的清理
- 修复消息积压处理异常：`'list' object has no attribute 'keys'`
  - 将`message_backlog`从列表类型改为字典类型
  - 修正了数据结构不匹配导致的运行时错误
  - 确保积压消息处理逻辑正常工作

### 技术改进
- 优化媒体组消息收集机制，确保在高延迟网络环境下正确收集所有消息
- 改进任务管理，避免重复任务创建和资源泄漏
- 增强时间窗口控制，提高媒体组处理的可靠性
- 完善属性初始化，消除运行时AttributeError错误

## [1.9.84] - 2025-06-01

### 🐛 重大Bug修复
- **媒体组过滤后原始标题丢失问题的根本性修复**
  - 修复了媒体组过滤时原始标题丢失的关键bug：当媒体组中第一条消息（通常带标题）被过滤掉时，过滤后的消息没有标题信息
  - 在媒体组过滤统计中添加`original_caption`字段，在消息过滤过程中保存原始媒体组标题
  - 修改`_send_filtered_media_group`方法，优先从过滤统计中获取保存的原始标题，而不是从过滤后的消息中寻找
  - 现在即使第一条消息（视频等）被过滤掉，剩余的媒体（照片等）仍能正确保留和应用原始媒体组标题
  - 完善了清理逻辑，确保媒体组处理完成后正确清理保存的统计信息，防止内存泄漏

### 🔧 技术改进
- 在媒体组消息处理时添加了原始标题保存逻辑，确保标题信息不会因过滤而丢失
- 完善了`_send_filtered_media_group`的错误处理，确保异常情况下也能正确清理统计信息
- 增强了日志记录，详细记录原始标题的保存和获取过程，便于调试

### 🧪 测试验证
- 验证了"9个照片+1个视频，标题为'女女'"的媒体组在只允许照片过滤条件下，能正确保留标题并应用文本替换
- 确认了原始标题保存和获取机制的正确性
- 测试了各种媒体组配置下的过滤和标题处理逻辑

---

## [1.9.83] - 2025-06-01

### 🐛 Bug修复
- **媒体组过滤后文本替换规则重大修复**
  - 修复了当过滤条件设置为只允许特定媒体类型（如只允许照片）时，媒体组过滤后没有正确应用文本替换规则的关键bug
  - 修复了`_send_modified_media_group`方法中caption为None时被错误设置为空字符串的问题，现在当caption为None时会保持为None而不是设置为空字符串
  - 修复了`_send_filtered_media_group`方法中的文本替换逻辑，确保过滤后的媒体组能正确应用文本替换规则
  - 修复了单条消息转发时的文本替换逻辑，当消息没有标题时replaced_caption应该为None而不是原始标题
  - 优化了单条消息转发的参数传递逻辑，当没有标题时不传递replace_caption参数，避免不必要的参数传递
  - 现在无论是禁止转发还是非禁止转发的源频道，媒体组过滤后都能正确应用文本替换规则并保持正确的媒体说明显示

### 🔧 技术改进
- 完善了媒体组过滤后的标题处理逻辑，确保文本替换规则正确应用
- 改进了单条消息转发时的参数处理，避免传递无效的参数
- 优化了caption处理的边界条件，防止None值被误转换为空字符串
- 增强了日志记录，更详细地记录文本替换的过程和结果

### 🧪 测试验证
- 验证了只允许照片类型过滤条件下的文本替换功能正常工作
- 确认了禁止转发和非禁止转发频道的媒体组过滤文本替换都能正常工作
- 测试了有标题和无标题消息的处理逻辑
- 验证了caption为None时不会被错误地设置为空字符串

---

## [1.9.82] - 2025-06-01

### 🐛 Bug修复
- **监听模块媒体组文本替换规则重大修复**
  - 修复了当过滤条件设置为只允许特定媒体类型（如只允许视频）时，媒体组消息过滤后没有应用文本替换规则的关键bug
  - 修复了`MediaGroupHandler`中错误的`TextFilter`方法调用，将`add_replacement_rule`和`apply_filters`方法替换为正确的`apply_text_replacements_static`方法
  - 修复了`_process_media_group`方法中单条消息转发时的文本替换逻辑
  - 修复了`_send_filtered_media_group`方法中重组媒体组时的文本替换配置读取错误
  - 现在无论是禁止转发还是非禁止转发的源频道，媒体组消息过滤后都能正确应用文本替换规则
  - 优化了文本替换规则的获取逻辑，优先使用`pair_config`中预构建的`text_replacements`，确保与其他模块的一致性

### 🔧 技术改进
- 统一了媒体组处理器中的文本替换逻辑实现
- 完善了错误的方法调用检查，防止类似问题再次出现
- 优化了文本替换规则的构建和应用流程

### 🧪 测试验证
- 验证了媒体组过滤功能与文本替换规则的正确协作
- 确认了单条消息和媒体组消息的文本替换都能正常工作
- 修复了方法调用错误导致的功能失效问题

---

## [1.9.81] - 2025-05-31

### 🐛 Bug修复
- **MediaGroupHandler关键Bug修复**
  - 修复`MediaGroupHandler`缺失`should_stop`属性导致的清理任务异常
  - 修复`MessageProcessor`中不存在的`process_single_message`方法调用错误
  - 修复`MediaGroupHandler`缺失`api_worker_task`属性导致的停止监听异常
  - 正确实现单条消息转发逻辑，使用`forward_message`方法替代
  - 添加`media_group_timeout`超时设置以确保系统稳定性

### 🔧 技术改进
- 重构MediaGroupHandler的单条消息处理流程
- 完善过滤后媒体组的文本替换和标题处理逻辑
- 优化错误处理和日志记录机制

### 🧪 测试验证
- 验证媒体组过滤功能正常工作
- 确认单条消息转发逻辑无误
- 修复系统启动和停止过程中的异常

---

## [1.9.80] - 2025-05-31

### 修复 🔧
- **媒体组处理重大修复**：
  - 修复了媒体组消息跳过API调用后不进行处理的关键bug
  - 添加了基于时间和消息数量的强制处理机制，避免媒体组永远不被处理
  - 实现了延迟检查机制，确保即使在高流量情况下媒体组也能被正确处理
  - 添加了first_message_time跟踪，基于第一条消息的时间进行超时判断
  - 媒体组现在会在5秒超时、10条消息阈值或完整接收时自动处理
- **非禁止转发频道媒体组过滤重大修复**：
  - 修复了非禁止转发频道收到媒体组消息时，即使只勾选部分媒体类型，仍转发完整媒体组的问题
  - 修复了过滤后的媒体组重复发送的问题
  - 当媒体组被过滤后，现在会使用`send_modified_media_group`而不是`copy_media_group`来发送过滤后的媒体组
  - 为过滤后的消息添加原始数量标记，准确判断是否需要特殊处理
- **修复过滤变量未定义错误**：
  - 修复了`_process_media_group`方法中`exclude_forwards`等过滤变量未定义的NameError
  - 添加了从`pair_config`中正确获取所有过滤配置的代码

### Fixed
- 修复媒体组处理中的重复过滤逻辑问题
  - 移除了_process_media_group中冗余的第二套过滤逻辑
  - 解决了三套过滤逻辑同时运行导致的冲突问题
  - 修复了可能的双重过滤和统计错误
  - 简化了媒体组处理流程，提高了性能和稳定性
  - 确保了"2张照片+3个视频，过滤照片"等场景的正确处理

### Improved
- 优化了媒体组过滤的执行路径，避免重复计算
- 增强了过滤逻辑的一致性和可预测性
- 改进了媒体组处理器的代码结构和可维护性

## [1.9.79] - 2025-05-31

### Fixed
- 彻底修复媒体组过滤统计和重组发送逻辑
  - 添加了媒体组过滤统计跟踪系统，记录每个媒体组的总接收数、过滤数和预期数
  - 修复了媒体组过滤后无法正确判断是否需要重组发送的问题
  - 解决了日志显示"原始消息数：9，过滤后消息数：9，被过滤：0"的错误统计问题
  - 现在能正确显示如"总接收=10, 已过滤=1, 缓存中=9"的准确统计信息
  - 过滤后如果剩余消息>1，将使用send_media_group()方法重组发送
  - 过滤后如果只剩1条消息，将作为单条消息发送
  - 过滤后如果没有剩余消息，将跳过转发
  - API工作器获取的完整媒体组也同步应用过滤统计跟踪
  - 添加了过滤统计的自动清理机制，防止内存泄漏

### Improved
- 优化了媒体组处理器的初始化结构，统一了缓存和统计管理
- 增强了媒体组过滤的日志记录，提供更详细的统计信息
- 改进了过滤消息的UI事件发送，确保所有过滤操作都能在界面中显示
- 统一了handle_media_group_message和API工作器的过滤统计逻辑

## [1.9.78] - 2025-05-31

### Fixed
- 修复媒体组过滤逻辑重大问题
  - 解决了设置仅转发特定媒体类型时，被过滤的媒体仍然被转发的问题
  - 修复了媒体组被重复转发两次的问题  
  - 在handle_media_group_message中被过滤的消息现在不会添加到缓存中
  - 在_process_media_group中添加了媒体类型过滤，确保只处理允许的媒体类型
  - 改进了_send_modified_media_group，确保只发送支持的媒体类型
  - 被过滤掉的媒体类型消息会正确显示过滤日志
  - 支持部分媒体组转发：如果媒体组中有些消息被过滤，只转发允许的消息类型
  - 修复了API请求工作器的task_done()重复调用错误
  - 修复了API工作器获取完整媒体组时跳过媒体类型过滤的问题
  - 修复了转发失败重试时重复转发给成功频道的问题

### Improved
- 增强了媒体组处理的日志记录，显示原始消息数、过滤后消息数和被过滤消息数
- 优化了媒体组转发的显示ID生成，只包含实际发送的消息ID
- 改进了API请求工作器的错误处理和任务完成机制
- 增强了媒体组重复处理检查，确保媒体组只被处理一次

## [1.9.76] - 2025-05-30

### 增强
- **监听过滤日志完善**：
  - 添加了完整的过滤消息日志提示功能
  - 当消息被过滤时，现在会在监听日志界面显示详细的过滤信息
  - 支持所有过滤类型的日志提示：转发消息、回复消息、媒体消息、包含链接、关键词过滤、媒体类型过滤
  - 过滤日志会显示在主消息面板和对应的频道标签页中
  - 添加了智能的频道标签页创建功能，确保过滤消息能正确显示在对应频道的标签页中

### 改进
- **用户体验优化**：
  - 过滤日志使用特殊的[过滤]标签，便于用户识别
  - 提供中文化的媒体类型名称显示（如：照片、视频、文件等）
  - 关键词过滤会显示具体的关键词列表
  - 媒体类型过滤会显示具体被过滤的媒体类型
  - 过滤日志包含完整的源频道信息和过滤原因

### 技术改进
- **信号系统增强**：添加了message_filtered信号，实现监听模块到UI的过滤消息通知
- **日志级别调整**：将过滤相关的日志从debug级别提升到info级别，确保在UI中可见
- **代码统一性**：在核心监听器、媒体组处理器中统一了过滤日志的格式和处理方式

## [1.9.75] - 2025-01-20

### 修复
- **监听转发媒体类型支持完善**：
  - 修复了语音消息在禁止转发频道中无法正确处理的问题
  - 修复了视频笔记消息在禁止转发频道中无法正确处理的问题
  - 为`RestrictedForwardHandler`添加了语音和视频笔记的特殊处理逻辑
  - 语音和视频笔记现在支持使用file_id直接转发，避免不必要的下载上传过程
  - 优先使用copy_message方式，失败时降级为send_voice/send_video_note方式

### 增强
- **媒体类型全面支持**：监听转发功能现在完全支持所有8种媒体类型
  - ✅ 照片 (photo) - 完全支持
  - ✅ 视频 (video) - 完全支持
  - ✅ 文件 (document) - 完全支持
  - ✅ 音频 (audio) - 完全支持
  - ✅ 动画 (animation) - 完全支持
  - ✅ 贴纸 (sticker) - 完全支持
  - ✅ 语音 (voice) - 现已完全支持
  - ✅ 视频笔记 (video_note) - 现已完全支持

### 技术改进
- **禁转处理优化**：为特殊媒体类型（贴纸、语音、视频笔记）使用更高效的处理方式
- **错误处理增强**：添加了完整的错误处理和降级机制，确保转发成功率
- **性能优化**：避免对不需要下载的媒体类型进行下载上传操作

## [1.9.74] - 2025-05-30

### 修复
- **媒体组转发日志显示优化**：
  - 修复了媒体组转发成功后在监听日志中显示多次"发送成功"的问题
  - 现在媒体组作为整体只显示一次"媒体组[N个文件]发送成功"
  - 统一了所有媒体组转发路径的信号发射逻辑，包括copy_media_group、forward_messages和下载上传方式
  - 修复了EventEmitterMonitor中forward_updated信号的类型定义，支持字符串格式的媒体组显示ID

- **禁止转发频道标题修改状态修复**：
  - 修复了源频道禁止转发时，即使没有修改标题也没有移除媒体说明，监听日志中仍显示"标题已修改"的问题
  - 现在RestrictedForwardHandler会返回实际的标题修改状态，只有真正修改了标题才会显示"标题已修改"
  - 优化了下载上传方式的标题修改检测逻辑，确保显示状态与实际操作一致
  - 同时修复了单条消息和媒体组消息的标题修改状态检测

- **临时目录清理优化**：
  - 修复了源频道禁止转发时下载上传媒体后，tmp/monitor文件夹中残留大量空文件夹的问题
  - 优化了MediaUploader的cleanup_media_group_dir方法，增加了递归清理空父目录的功能
  - 在RestrictedForwardHandler中添加了try-finally块，确保即使异常情况下也能清理临时目录
  - 在Monitor停止时主动清理RestrictedForwardHandler的残留临时目录
  - 添加了析构函数确保对象销毁时清理临时目录，防止长期运行时积累过多空文件夹

### 增强
- **转发成功分割线功能优化**：
  - 恢复并优化了转发成功后的分割线功能，现在使用50个#作为分割线
  - 分割线在转发成功后自动添加到主消息面板和频道标签页中
  - 只有转发成功时才显示分割线，失败时不显示，保持日志清晰
  - 分割线功能适用于单条消息和媒体组转发

### 技术改进
- **媒体组显示ID生成机制**：
  - 新增`_generate_media_group_display_id`方法，统一生成格式为"媒体组[N个文件]-最小消息ID"的显示ID
  - 添加了对无效消息ID和空消息列表的防护性处理
  - 确保媒体组显示ID的一致性和可读性，提升用户体验

## [1.9.73] - 2025-05-30

### 修复
- 修复禁止转发频道消息处理中的事件发射缺失问题
  - 修复`ChatForwardsRestricted`异常处理中`copy_message`成功后缺少转发成功事件发射
  - 修复`FloodWait`重试成功后缺少转发成功事件发射
  - 确保所有成功转发的情况都能在UI中正确显示

## [1.9.66] - 2025-05-30

### 修复
- 修复媒体组转发中的变量未定义错误
  - 修复`should_remove_caption`变量未定义问题
  - 修复异常处理中`target_info`变量引用错误
  - 统一变量命名：将`should_remove_caption`改为`remove_captions`保持参数一致性
  - 改进媒体组转发失败时的事件发射逻辑

## [1.9.65] - 2025-05-30

### 修复
- **监听日志"标题已修改"标识优化**：精确控制"标题已修改"标识的显示逻辑
  - 将"已修改"改为"标题已修改"，更准确地描述修改内容
  - 只有在真正使用了文本替换或移除媒体说明时才显示"标题已修改"
  - 原样转发（`forward_messages`）不再显示任何修改标识
  - 复制转发（`copy_message`）但未修改文本/标题时也不显示修改标识
  - 提升了转发状态显示的精确性和用户理解度

### 优化
- **转发状态标识精确性**：确保"标题已修改"标识准确反映消息的实际处理状态
  - 文本替换：当替换后的文本与原文本不同时显示"标题已修改"
  - 移除媒体说明：当原本有标题且被移除时显示"标题已修改"
  - 其他情况：不显示任何修改标识，保持界面简洁
- **媒体组处理一致性**：确保单条消息和媒体组消息的标识逻辑完全一致

## [1.9.64] - 2025-05-30

### 修复
- **监听日志"已修改"标识修复**：修正了转发日志中"已修改"标识的错误显示问题
  - 修复了使用`forward_messages`（原样转发）时错误显示"已修改"的问题
  - 现在只有真正经过修改的转发（文本替换、标题修改、复制转发、下载上传转发等）才会显示"已修改"
  - 原样转发（`forward_messages`）不再错误地显示"已修改"标识
  - 提升了转发状态显示的准确性，用户可以更清楚地了解消息的处理方式

### 优化
- **转发状态标识准确性**：确保"已修改"标识准确反映消息的实际处理状态
  - `modified=True`：文本替换、标题修改、复制转发、下载上传转发等修改操作
  - `modified=False`：原样转发，保持消息完全不变

## [1.9.63] - 2025-05-30

### 修复
- **监听日志标签页名称优化**：解决了动态创建日志标签页时有时显示频道ID而非频道名称的问题
  - 改进了频道信息格式化逻辑，在无法获取频道详细信息时提供更智能的显示名称
  - 新增`_extract_channel_title_from_source_info`方法，智能提取频道名称作为标签页标题
  - 优化了`_generate_fallback_channel_title`方法，为不同格式的频道标识符生成合适的显示名称
  - 确保标签页标题始终显示有意义的频道名称而不是纯数字ID

### 优化
- **标签页标题智能化**：支持多种频道标识符格式的智能识别和显示
  - 支持标准格式："频道名称 (ID: -1001234567890)"
  - 支持用户名格式："@username" 或 "@username (ID: -1001234567890)"
  - 支持链接格式："https://t.me/username"
  - 支持纯数字ID：自动转换为"频道ID"格式显示
  - 自动限制标签页标题长度，避免界面显示问题

## [1.9.62] - 2025-05-30

### 修复
- **媒体组转发日志完全修复**：解决了监听媒体组消息时转发成功日志缺失的问题
  - 为`MediaGroupHandler`添加了`emit`事件发射器属性
  - 在`EventEmitterMonitor`中为媒体组处理器设置事件发射方法
  - 在所有媒体组转发成功的地方添加了`forward`事件发射
  - 在媒体组转发失败时也添加了相应的失败事件发射
- **转发状态完整显示**：现在媒体组消息的转发状态会完整显示在监听日志中
  - 总日志标签页中显示转发成功/失败记录
  - 动态创建的源频道日志标签页中也显示转发状态
  - 支持所有转发方式：直接转发、复制转发、下载上传转发等
- **事件一致性改进**：确保单条消息和媒体组消息的转发日志行为完全一致

### 优化
- **日志完整性**：确保所有类型的消息转发都能产生完整的日志记录
- **事件发射统一**：统一了消息处理器和媒体组处理器的事件发射机制

## [1.9.61] - 2025-05-30

### 优化
- **完全动态标签页管理**：删除了所有预先创建标签页的逻辑
  - 取消添加频道对时预先创建标签页
  - 取消程序启动时从配置加载标签页
  - 取消删除频道对时自动删除标签页
- **纯动态响应**：现在标签页完全根据实际监听到的消息动态创建
  - 只有在实际收到新消息或转发消息时才创建对应的频道标签页
  - 避免了空标签页的出现，提供更清洁的用户界面
  - 保留历史消息记录，删除频道对配置不会影响已有的消息日志
- **用户体验改进**：
  - 启动时监听日志界面更加简洁，只显示"所有消息"标签页
  - 监听开始后自动为有消息活动的频道创建标签页
  - 标签页数量与实际监听活动完全对应，避免混淆

### 改进
- **内存使用优化**：减少了不必要的UI组件创建
- **界面清洁度**：消除了空白无用的频道标签页
- **逻辑简化**：移除了复杂的标签页同步和管理逻辑

## [1.9.60] - 2025-05-30

### 修复
- **源频道标签卡完全修复**：彻底解决标签卡不显示日志的问题
- **动态标签页创建**：自动为所有监听频道创建对应的标签页
- **智能频道识别**：从监听消息中自动提取频道信息并创建匹配的标签页
- **新消息和转发日志分类**：确保所有类型的日志都能正确显示在对应标签页中

### 改进
- **零配置适应**：无需用户手动配置，系统自动识别并适配所有监听频道
- **实时响应**：监听开始后立即为新发现的频道创建标签页
- **完整日志覆盖**：新消息接收和转发结果都能正确分类显示
- **用户体验大幅提升**：监听日志功能现在完全可用

## [1.9.59] - 2025-05-30

### 修复
- **源频道标签卡日志显示增强**：添加全局频道搜索功能
- **动态标签页创建**：当匹配失败时自动搜索配置并创建对应的频道标签页
- **智能ID匹配**：支持反向ID匹配和多种ID格式转换
- **调试功能强化**：添加详细的频道匹配和搜索过程日志

### 改进
- **自动适应**：系统能够自动适应用户界面配置与实际监听配置的差异
- **容错性**：即使初始匹配失败，也能通过全局搜索找到正确的频道
- **用户体验**：确保所有监听日志都能正确显示在对应的源频道标签页中

## [1.9.58] - 2025-05-30

### 修复
- **监听日志系统**：修复源频道标签卡中不显示对应日志的问题
- **频道匹配算法**：重新设计频道匹配逻辑，支持多种匹配方式：
  - 直接匹配
  - 包含匹配（互相包含）
  - 清理@符号后匹配
  - ID提取匹配（支持格式如"频道名 (ID: -1002382449514)"）
  - 用户名匹配（@username和t.me/username格式）
  - 频道标题匹配
- **调试功能**：添加详细的频道匹配调试日志，便于问题排查

### 改进
- **匹配精度**：显著提升频道匹配的准确性和兼容性
- **日志分类**：确保新消息和转发结果都能正确显示在对应源频道的标签页中
- **错误处理**：增强匹配失败时的警告信息

## [1.9.57] - 2025-05-30

### 修复
- **关键Qt信号错误**：修复"Use the function PySide6.QtCore.SIGNAL on signals"错误
- **事件发射机制**：重新设计EventEmitterMonitor的事件发射架构
- **信号处理**：确保emit方法正确指向事件发射器而非Qt信号对象

### 改进
- **系统稳定性**：大幅提升监听系统的稳定性和可靠性
- **错误处理**：优化事件发射链路中的异常处理

## [1.9.56] - 2025-05-30

### 修复
- **监听日志功能**：重大修复监听日志显示问题
- **转发状态显示**：修复转发成功/失败状态不显示的问题
- **信号连接**：修复事件发射器与UI组件的信号连接问题

### 新增
- **转发结果日志**：新增详细的转发结果显示，包括成功/失败状态和修改标识
- **源频道分类日志**：每个监听的源频道都有独立的日志标签页

### 改进
- **日志格式**：优化日志显示格式，信息更加清晰
- **事件处理**：改进监听事件的处理和传递机制

## [1.9.55] - 2025-05-30

### 监听日志功能重大改进

- **转发结果日志显示增强**：
  - 监听日志界面现在显示详细的转发结果信息，包括转发成功和失败的状态
  - 日志显示格式为："消息[ID] 从 源频道 转发到 目标频道 - 成功/失败 (已修改)"
  - 支持显示转发是否经过修改（文本替换、移除说明等操作）
  - 转发失败时会显示具体的失败原因和错误信息

- **频道分类日志显示**：
  - 监听日志现在不仅在"所有消息"标签页显示，还会在对应的源频道标签页中显示
  - 每个监听的源频道都有独立的日志标签页，显示该频道的专属日志
  - 支持更宽松的频道名称匹配，包括去除@符号的匹配规则
  - 新消息和转发结果都会同时显示在总日志和对应频道的日志中

- **日志显示格式优化**：
  - 统一了日志消息的时间戳格式（yyyy-MM-dd hh:mm:ss）
  - 改进了消息类型标识，使用[新消息]、[转发成功]、[转发失败]等明确标签
  - 优化了频道名称显示，使用更友好的频道显示名称而不是数字ID
  - 支持自动滚动和消息数量限制（每个标签页最多200条消息）

### 信号系统重构

- **转发事件信号优化**：
  - 修改了转发更新信号的参数类型，从数字ID改为字符串形式的友好名称
  - 信号现在传递源频道显示名和目标频道显示名，而不是数字ID
  - 改进了事件发射器中的信号定义，支持更丰富的转发信息传递
  - 优化了信号处理方法，提供更准确的频道匹配逻辑

- **消息处理器改进**：
  - 在转发消息时获取更友好的频道显示名称信息
  - 为所有转发操作（成功、失败、重试）添加了完整的事件发射
  - 支持禁止转发频道的特殊处理，确保所有情况下都有正确的日志输出
  - 改进了异常处理路径中的事件发射，确保失败情况也能正确记录

### 技术改进

- **频道解析器集成**：
  - 使用频道解析器获取更友好的频道显示名称
  - 支持自动格式化频道信息，提供一致的显示效果
  - 改进了频道ID和用户名之间的转换逻辑
  - 增强了频道信息缓存机制，提高显示性能

- **UI组件协调**：
  - 优化了监听界面中的标签页管理，确保频道标签页与配置同步
  - 改进了消息显示逻辑，支持多标签页的并行更新
  - 增强了频道名称匹配算法，提高日志分类的准确性
  - 添加了消息数量限制和自动清理机制，防止内存占用过高

### 用户体验提升

- **实时监听反馈**：
  - 用户现在可以实时查看每个频道的监听状态和转发结果
  - 点击"开始监听"后自动切换到监听日志标签页，提供即时反馈
  - 支持按源频道分类查看日志，便于跟踪特定频道的监听情况
  - 提供详细的转发状态信息，包括成功率和失败原因

- **日志界面优化**：
  - 监听日志界面布局更加合理，支持多标签页浏览
  - 日志消息格式统一且易读，包含完整的时间和状态信息
  - 支持大量日志的高效显示和自动管理
  - 改进了日志更新的性能，减少界面卡顿现象

## 1.9.54 (2025-01-20)

### 重要修复

- **非禁止转发频道媒体消息移除媒体说明功能修复**：
  - 修复了非禁止转发频道转发媒体消息时，勾选"移除媒体说明"但caption没有被正确移除的问题
  - 问题根源：Pyrogram的`copy_message`方法在移除caption时，需要传递空字符串`""`而不是`None`
  - 当传递`caption=None`时，`copy_message`会保留原始消息的caption内容，无法实现移除效果
  - 修复方案：在所有使用`copy_message`的地方，当`remove_caption=True`时传递空字符串`""`

- **全方位移除媒体说明功能修复**：
  - 修复了`MessageProcessor.forward_message`方法中的三个处理路径：
    - 正常转发路径：使用`copy_message`时正确移除caption
    - `ChatForwardsRestricted`异常处理：使用`copy_message`时正确移除caption
    - `FloodWait`异常处理：使用`copy_message`时正确移除caption
  - 修复了`MessageProcessor.send_modified_message`方法中各种媒体类型的发送逻辑：
    - 照片、视频、文档、动画、音频、语音消息：当`remove_caption=True`时不传递`caption`参数
    - 使用kwargs字典动态构建参数，避免传递无效的caption值
  - 修复了`RestrictedForwardHandler`中的禁止转发消息处理：
    - 非媒体消息：使用空字符串而不是None来移除caption
    - 媒体消息组：正确处理final_caption的移除逻辑
    - 媒体消息复制：在copy_message时确保正确移除caption

### 功能确认

- **移除媒体说明功能全面支持确认**：
  - 禁止转发频道：媒体消息移除说明功能正常工作
  - 非禁止转发频道：媒体消息移除说明功能正常工作
  - 所有消息类型的移除媒体说明功能现在工作正常，无论频道转发权限如何
  - 支持各种媒体类型：照片、视频、文档、动画、音频、语音、视频笔记等

### 技术改进

- **API调用参数优化**：
  - 对于Pyrogram的`copy_message`方法，移除caption时使用空字符串`""`
  - 对于Pyrogram的`send_*`方法（如send_photo、send_video等），移除caption时不传递caption参数
  - 采用kwargs字典动态构建参数的方式，提高代码的灵活性和可维护性
  - 在所有异常处理路径中保持一致的caption处理逻辑

- **代码逻辑统一**：
  - 统一了所有模块中移除caption的实现方式
  - 确保消息处理器和禁止转发处理器使用相同的逻辑
  - 改进了条件判断逻辑，提高代码的清晰度和可读性
  - 增加了详细的注释说明，便于后续维护

## 1.9.53 (2025-01-20)

### 重要修复

- **非禁止转发频道纯文本消息文本替换功能修复**：
  - 修复了非禁止转发频道中纯文本消息的文本替换功能不工作的问题
  - 问题根源：对于纯文本消息，Pyrogram的`copy_message`方法的`caption`参数无法修改文本内容，必须使用`send_message`方法
  - 修复方案：在消息处理器中检测纯文本消息且需要文本替换的情况，使用`send_message`而不是`copy_message`
  - 现在所有类型的频道（禁止转发和非禁止转发）的纯文本消息都支持完整的文本替换功能
  - 同时修复了异常处理路径（ChatForwardsRestricted和FloodWait）中的相同问题

### 功能确认

- **文本替换功能全面支持确认**：
  - 禁止转发频道：媒体消息和纯文本消息都支持文本替换
  - 非禁止转发频道：媒体消息和纯文本消息都支持文本替换
  - 所有消息类型的文本替换功能现在工作正常，无论频道转发权限如何

### 技术改进

- **消息处理逻辑优化**：
  - 在`MessageProcessor.forward_message`方法中添加了纯文本消息的特殊处理逻辑
  - 对于纯文本消息且需要文本替换的情况，直接使用`send_message`发送替换后的文本
  - 对于媒体消息或无需文本替换的情况，继续使用`copy_message`方法
  - 在异常处理路径中同样实现了正确的处理逻辑，确保一致性
  - 增加了详细的调试日志，便于跟踪文本替换的处理过程

## 1.9.52 (2025-01-20)

### 重要修复

- **主题切换状态保持问题修复**：
  - 修复了在设置界面切换主题后，点击监听界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 修复了在设置界面切换主题后，点击历史转发界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 修复了在设置界面切换主题后，点击本地上传界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 修复了在设置界面切换主题后，点击下载界面的"保存配置"按钮会导致主题自动切换回之前主题的问题
  - 问题根源：各界面保存配置时，由于配置可能包含旧的主题设置，导致系统错误地认为需要切换回旧主题
  - 修复方案：在所有界面保存配置时，主动获取当前应用的主题设置并保留到配置中，防止主题被错误覆盖
  - 现在所有界面的配置保存操作都不会影响用户当前选择的主题设置

### 功能改进

- **开发工具清理**：
  - 删除了QtAsyncio测试模块和相关引用，减少了不必要的开发测试代码
  - 移除了导航树、侧边栏和actions文件中对QtAsyncio测试的引用
  - 简化了导航结构，提高了应用程序的整洁性

- **监听界面优化**：
  - 删除了监听界面点击"开始监听"按钮后弹出的保存配置对话框
  - 用户现在可以直接开始监听，无需额外的确认对话框
  - 用户可以通过单独的"保存配置"按钮来保存配置，操作更加直观
  - 简化了监听操作流程，提升了用户体验

### 技术改进

- **配置保存逻辑优化**：
  - 在监听界面的`_save_config`方法中添加主题保护逻辑
  - 在历史转发界面的`_save_config`方法中添加主题保护逻辑
  - 在本地上传界面的`_save_config`方法中添加主题保护逻辑
  - 在下载界面的`_save_config`方法中添加主题保护逻辑
  - 从主题管理器获取当前主题设置，确保在保存配置时不会丢失
  - 改进了配置合并逻辑，确保关键UI设置（如主题）得到正确保留
  - 增加了详细的调试日志，便于跟踪主题设置的处理过程

### 用户体验提升

- **配置保存一致性**：
  - 确保所有界面的配置保存操作都不会意外影响主题设置
  - 用户在设置界面修改主题后，可以正常使用所有功能界面的保存功能
  - 保持主题切换的实时预览功能，同时避免配置保存时的意外重置
  - 提升了应用程序的整体稳定性和用户体验
  - 解决了用户在使用过程中主题意外切换的困扰

- **操作流程简化**：
  - 监听功能的操作流程更加直观，减少了不必要的确认对话框
  - 各功能界面的按钮职责更加明确，避免了操作混淆
  - 提升了应用程序的响应速度和使用便利性

## 1.9.51 (2025-01-20)

### 重要修复

- **监听界面配置加载问题修复**：
  - 修复了程序重新启动时，监听界面中已配置监听频道对的关键词和四个排除选项不显示在滚动区域的问题
  - 问题根源：在`load_config`方法末尾错误地清空了关键词输入框和排除选项复选框，导致这些配置虽然正确加载到列表项数据中，但在UI界面上显示为空白
  - 修复方案：移除了在配置加载过程中重置关键词输入框和排除项复选框的代码，保持这些控件为空白状态供用户添加新频道对时使用
  - 配置数据存储和显示功能正常：关键词和排除项仍会正确显示在频道对列表的文本描述中，也会正确保存到配置文件中
  - 现在程序重启后，滚动区域中的已配置频道对会正确显示所有参数，包括关键词和排除项

### 代码优化

- **界面状态管理改进**：
  - 优化了配置加载时的UI状态管理，避免不必要的界面重置操作
  - 保持了关键词和排除项输入控件的正确用途：仅用于添加新频道对时的输入
  - 加载配置时不再影响这些输入控件的状态，确保已配置项目的完整显示
  - 添加了详细的代码注释，说明了界面重置逻辑的适用场景

## 1.9.50 (2025-01-20)

### ⚠️ 重大变更 (Breaking Changes)

- **监听模块媒体类型架构重构**：
  - **移除了全局媒体类型配置**：不再支持监听配置中的公共媒体类型设置
  - **改为每个频道对单独配置媒体类型**：现在每个监听频道对都可以单独设置要监听的媒体类型
  - **配置文件结构变更**：旧的`MONITOR.media_types`字段已移除，媒体类型现在保存在`MONITOR.monitor_channel_pairs[].media_types`中
  - **向后兼容处理**：系统会自动为没有媒体类型的旧配置添加默认的全部媒体类型支持

### 新功能特性

- **频道对级别的媒体类型过滤**：
  - 每个频道对现在可以独立配置要监听的媒体类型（照片、视频、文件、音频等）
  - 支持8种媒体类型：照片、视频、文件、音频、动画、贴纸、语音、视频笔记
  - 在添加频道对时，UI界面的媒体类型选择将应用到该特定频道对
  - 监听过程中会根据每个频道对的媒体类型设置进行精确过滤

- **智能媒体类型检测与过滤**：
  - 监听核心模块新增消息媒体类型检测功能
  - 媒体组处理器支持按频道对的媒体类型设置进行过滤
  - 不符合媒体类型要求的消息将被自动跳过，不会转发到目标频道

### 界面改进

- **监听界面UI优化**：
  - 媒体类型复选框现在控制单个频道对的设置，而非全局设置
  - 添加频道对后会自动重置媒体类型复选框为全选状态
  - 加载配置时媒体类型复选框默认为全选状态，适应新的单频道对配置模式

### 技术改进

- **配置模型重构**：
  - `UIMonitorChannelPair`模型新增`media_types`字段
  - `UIMonitorConfig`模型移除全局`media_types`字段
  - 配置转换工具更新以支持新的数据结构

- **监听核心优化**：
  - 监听器启动时为每个频道对保存独立的媒体类型配置
  - 消息处理流程中添加媒体类型验证步骤
  - 支持枚举类型和字符串类型的媒体类型兼容处理

- **代码质量提升**：
  - 新增详细的文档字符串和注释说明
  - 改进错误处理和日志记录
  - 保持与现有功能的完全兼容性

### 升级说明

- **自动迁移**：系统会自动处理旧配置文件的兼容性，无需手动干预
- **功能增强**：现有的监听功能保持不变，但现在支持更精细的媒体类型控制
- **配置建议**：建议用户重新检查并优化各频道对的媒体类型设置，以获得更精确的监听效果

## 1.9.49 (2025-01-20)

### 界面优化

- **监听界面布局改进**：
  - 将"监听参数:"标签和"移除媒体说明"复选框合并到同一行显示，界面更加紧凑
  - 将"添加频道对"和"删除所选"按钮从频道列表下方移动到"已配置监听频道对"标签上方
  - 优化了按钮在界面中的位置，现在位于四个排除复选框下方，操作流程更加直观
  - 改进了界面布局的逻辑性，按钮位置更符合用户操作习惯
  - 提升了用户体验，频道管理操作现在更加便捷

### 技术改进

- **界面代码优化**：
  - 重构了监听界面的布局代码，优化了控件的排列顺序
  - 改进了水平布局的使用，使监听参数部分更加紧凑
  - 保持了所有现有功能的完整性，仅优化了界面组织结构
  - 提高了代码的可维护性，相关操作按钮现在位置更加合理

## 1.9.48 (2025-01-20)

### 界面优化

- **菜单栏功能增强**：
  - 在文件和工具菜单之间新增"功能"菜单，提供对主要功能的快速访问
  - 功能菜单包含：回到主界面、普通下载、本地上传、历史转发、实时监听
  - 为功能菜单项配置了快捷键：Ctrl+0(回到主界面)、Ctrl+1-4(各功能模块)
  - 当侧边栏隐藏时，用户仍可通过功能菜单访问所有核心功能
  - 移除了"配置"菜单，删除了导入配置和导出配置功能，简化界面结构

### 技术改进

- **代码优化**：
  - 清理了不再使用的配置导入导出相关代码和依赖
  - 移除了`_import_config`和`_export_config`方法
  - 清理了不再需要的模块导入：`deepcopy`和`QFileDialog`
  - 优化了功能视图打开逻辑，确保与侧边栏导航的功能一致性
  - 保持了所有现有功能的完整性，仅优化了界面组织结构

### 用户体验提升

- **访问便利性**：
  - 功能菜单为隐藏侧边栏的用户提供了完整的功能访问途径
  - 快捷键设计更加直观，使用数字键对应不同功能模块
  - 界面结构更加简洁，减少了不常用的配置导入导出功能
  - 回到主界面功能现在可通过菜单栏和工具栏双重访问

## 1.9.47 (2025-01-20)

### 界面优化

- **监听界面选项卡重组**：
  - 在频道配置选项卡和监听日志选项卡中间添加了新的"通用配置"选项卡
  - 将监听截止日期相关的UI控件从监听参数部分移动到通用配置选项卡
  - 监听参数部分现在只保留"移除媒体说明"复选框，界面更加简洁
  - 优化了选项卡的逻辑分组，相关配置项现在分类更加合理
  - 改善了界面的组织结构，提升了用户体验

### 技术改进

- **界面代码重构**：
  - 重新组织了监听界面的UI布局代码，增加了通用配置选项卡
  - 优化了相关UI控件的布局和事件连接，确保功能正常工作
  - 保持了所有现有功能的完整性，仅优化了界面的组织结构
  - 提高了代码的可维护性，相关配置项现在更加集中管理

## 1.9.46 (2025-01-20)

### 界面优化

- **监听界面布局改进**：
  - 将频道配置界面中的8个媒体类型复选框移动到过滤选项中
  - 删除了"要转发的媒体类型:"标签，减少界面冗余
  - 优化了过滤选项的结构组织，媒体类型选择现在统一在过滤选项下管理
  - 改进了界面布局的逻辑性，相关功能分组更加合理
  - 提升了用户体验，界面更加简洁直观

### 技术改进

- **界面代码优化**：
  - 重构了监听界面的UI布局代码，移除了冗余的标签和容器
  - 统一了媒体类型复选框的管理方式，现在集中在过滤选项中处理
  - 保持了所有现有功能的完整性，仅优化了界面组织结构
  - 改进了代码可维护性，相关功能更加集中

## 1.9.45 (2025-01-20)

### 重要修复

- **监听模块文本替换和移除媒体说明功能修复**：
  - 修复了文本替换和移除媒体说明参数不从配置文件读取的问题
  - 实现了正确的文本替换和移除媒体说明逻辑：
    - 当设置了移除媒体说明时，媒体组或媒体的说明文字的文本替换功能失效，应删除说明
    - 纯文本消息时移除媒体说明失效，而文本替换依旧起作用
  - 修复了监听器启动时配置传递不完整的问题，确保text_replacements和remove_captions参数正确传递
  - 优化了频道对配置的解析和存储逻辑，确保配置一致性

### 功能增强

- **配置管理改进**：
  - 监听器现在在每次启动时都会从配置文件重新读取text_filter和remove_captions配置
  - 改进了频道对配置的解析逻辑，增加了详细的调试日志
  - 优化了媒体组和单条消息的处理逻辑，确保配置参数正确应用

### 代码优化

- **消息处理逻辑优化**：
  - 重构了单条消息和媒体组消息的处理逻辑，使其遵循统一的配置规则
  - 改进了消息类型判断逻辑，准确区分媒体消息和纯文本消息
  - 增强了错误处理和日志记录，便于问题诊断

## 1.9.44 (2025-01-20)

### 功能增强

- **监听器配置读取流程优化**：
  - 重构了监听器的配置读取机制，现在监听器在每次启动时都会从配置文件读取最新配置
  - 修改了用户操作流程：添加频道对 → 保存配置 → 开始监听，确保配置一致性
  - 在开始监听前会提示用户保存配置，确保监听器能读取到最新的频道对配置
  - 移除了UI直接更新监听器配置的逻辑，改为统一从配置文件读取
  - 增强了配置同步的可靠性，避免UI和监听器配置不一致的问题

### 代码优化

- **配置管理改进**：
  - 简化了UI和监听器之间的配置传递逻辑
  - 确保了配置文件作为唯一的配置源，提高了数据一致性
  - 优化了监听器启动时的配置重新加载机制
  - 添加了详细的调试日志，便于跟踪配置读取过程

### 错误修复

- **监听功能配置更新修复**：
  - 修复了添加频道对后点击开始监听，但监听器没有监听新添加源频道的问题
  - 问题根源：监听器在初始化时从配置文件读取频道对列表，但UI中添加频道对后没有正确更新监听器的配置
  - 修复方案：改进`_update_monitor_config()`方法，从仅更新配置改为完全替换配置，确保新添加的频道对能被监听器识别
  - 添加了`should_stop`标志重置逻辑，确保监听器在重新启动时能正常工作
  - 增强了配置更新的调试日志，便于诊断配置同步问题

### 代码优化

- **监听配置管理改进**：
  - 优化了监听器配置更新流程，确保UI界面中的频道对配置能实时同步到监听器
  - 改进了文本过滤器的重新初始化逻辑，使用最新的配置而不是监听器内部的配置
  - 添加了详细的调试日志，帮助跟踪配置更新和频道解析过程

## 1.9.43 (2025-01-20)

### 错误修复

- **监听功能配置更新修复**：
  - 修复了添加频道对后点击开始监听，但监听器没有监听新添加源频道的问题
  - 问题根源：监听器在初始化时从配置文件读取频道对列表，但UI中添加频道对后没有正确更新监听器的配置
  - 修复方案：改进`_update_monitor_config()`方法，从仅更新配置改为完全替换配置，确保新添加的频道对能被监听器识别
  - 添加了`should_stop`标志重置逻辑，确保监听器在重新启动时能正常工作
  - 增强了配置更新的调试日志，便于诊断配置同步问题

### 代码优化

- **监听配置管理改进**：
  - 优化了监听器配置更新流程，确保UI界面中的频道对配置能实时同步到监听器
  - 改进了文本过滤器的重新初始化逻辑，使用最新的配置而不是监听器内部的配置
  - 添加了详细的调试日志，帮助跟踪配置更新和频道解析过程

## 1.9.42 (2025-05-06)

### 功能增强

- **禁止转发频道示例程序增强**：
  - 添加 SOCKS5 代理支持，允许在网络受限环境中使用程序
  - 实现频道解析功能，支持使用频道链接（https://t.me/channel）、用户名（@channel）和ID（-100xxxx）格式
  - 引入 `ChannelResolver` 类，负责解析各种格式的频道标识符并获取频道 ID
  - 优化代理配置逻辑，支持带认证和不带认证的代理服务器
  - 添加频道链接缓存机制，减少重复解析频道的 API 调用
  - 更新示例程序文档，提供代理设置和频道链接使用的详细说明

### 代码优化

- **示例程序代码重构**：
  - 将频道解析逻辑从转发器类中分离出来，创建专门的`ChannelResolver`类
  - 改进转发器类初始化流程，添加异步初始化方法，确保频道解析完成
  - 添加更详细的日志记录，便于跟踪频道解析和代理连接过程
  - 增强错误处理机制，提供更明确的错误信息

### 文档更新

- **示例程序文档完善**：
  - 更新`examples/README.md`，添加代理配置和频道链接支持的说明
  - 添加频道链接格式支持的详细说明，包括格式示例
  - 完善技术亮点部分，增加频道解析和代理支持的描述
  - 添加代理使用的注意事项

## 1.9.41 (2025-05-05)

### 新增功能

- **禁止转发频道消息转发示例**：
  - 添加了`examples/restricted_channel_forwarder.py`示例程序，用于监听禁止转发频道并转发消息
  - 实现了基于 Pyrogram 的流式下载上传机制，支持高效传输大型媒体文件，无需完全下载到本地
  - 添加了媒体组消息处理逻辑，支持 2-10 个媒体文件的组合，并保持原始排列顺序
  - 支持处理各种类型的消息（文本、图片、视频、文档、贴纸、GIF 等）
  - 优化了错误处理和重试机制，提高了在网络不稳定环境下的可靠性
  - 更新了示例程序文档，添加了详细的使用说明和技术细节解释

### 文档完善

- **示例目录完善**：
  - 添加了`examples/README.md`文件，提供示例程序的使用说明和详细文档
  - 完善了示例程序中的代码注释和文档字符串，提高代码可读性
  - 整理了示例代码结构，确保代码符合项目编码规范和最佳实践

## 1.9.40 (2025-05-04)

### 错误修复

- **贴纸消息处理修复**：
  - 修复了禁止转发频道中贴纸消息导致"400 MESSAGE_EMPTY"错误的问题
  - 为`MessageProcessor.send_modified_message`方法添加了对贴纸、语音和视频笔记等特殊消息类型的支持
  - 优化了`RestrictedForwardHandler`类中贴纸消息的处理逻辑，实现两阶段处理：优先尝试复制，失败时直接发送
  - 增强了消息类型检测，确保各种特殊媒体类型都能正确处理
  - 完善了错误处理和日志记录，提供更详细的处理过程信息

## 1.9.39 (2025-05-03)

### 错误修复

- **禁止转发频道处理改进**：
  - 修复了源频道禁止转发但消息为文本、表情、位置等非媒体消息时，处理失败的问题
  - 优化了`RestrictedForwardHandler`类，使其能正确处理非媒体消息
  - 改进了`MessageProcessor`类中对禁止转发频道的处理逻辑，确保所有类型的消息都能正确处理
  - 消除了处理非媒体消息时出现的"400 MESSAGE_EMPTY"错误
  - 改善了日志记录，更清晰地显示不同类型消息的处理方式

## 1.9.38 (2025-05-02)

### 性能优化

- **媒体组处理效率提升**：
  - 优化了媒体组 API 调用逻辑，现在缓存中只要有 1 条消息就会跳过 API 调用，大幅减少了`get_media_group`的调用次数
  - 之前需要缓存至少 6 条消息才会跳过 API 调用，现在认识到只需 1 条消息即可通过`get_media_group`获取整个媒体组
  - 这一优化显著减少了 Telegram API 的调用频率，降低了触发 API 限流的可能性
  - 提高了大量媒体组同时涌入时的处理效率

### 实现细节

- **API 调用控制机制**：
  - 使用信号量限制并发 API 请求数量（最多 3 个并发请求）
  - 实现全局 API 调用最小间隔，确保请求均匀分布
  - 添加随机抖动延迟，避免请求同时发生
- **消息处理优化**：
  - 添加积压消息处理队列，平滑处理大量涌入的消息
  - 优化媒体组超时处理机制，减少对 API 的依赖
  - 基于媒体组消息完成比例的智能决策系统
- **资源管理改进**：
  - 增强了异常情况下的资源清理机制
  - 改进了任务取消和停止流程
  - 优化了内存使用，防止长时间运行时的资源泄漏

## 1.9.37 (2023-12-15)

### 性能优化

- **媒体组处理 API 限流优化**：
  - 修复了大量媒体组同时涌入时触发 Telegram API 限流("Waiting for X seconds")的问题
  - 实现了 API 请求队列系统，使用工作器处理排队的请求，避免短时间内大量 API 调用
  - 添加了高流量保护模式，在检测到大量媒体组时自动调整处理策略
  - 实现了 API 请求的随机延迟和分散策略，减少 API 请求集中
  - 优化了缓存决策逻辑，根据媒体组完成度智能决定是否需要 API 调用

### 实现细节

- **API 调用控制机制**：
  - 使用信号量限制并发 API 请求数量（最多 3 个并发请求）
  - 实现全局 API 调用最小间隔，确保请求均匀分布
  - 添加随机抖动延迟，避免请求同时发生
- **消息处理优化**：
  - 添加积压消息处理队列，平滑处理大量涌入的消息
  - 优化媒体组超时处理机制，减少对 API 的依赖
  - 基于媒体组消息完成比例的智能决策系统
- **资源管理改进**：
  - 增强了异常情况下的资源清理机制
  - 改进了任务取消和停止流程
  - 优化了内存使用，防止长时间运行时的资源泄漏

## 1.9.36 (2023-12-10)

### 错误修复

- **媒体组处理优化**：
  - 修复了监听模块中对同一媒体组重复调用`get_media_group`方法的问题
  - 添加了媒体组获取状态跟踪机制，防止重复 API 调用
  - 实现了媒体组 API 调用频率限制，减少不必要的 API 请求
  - 优化了媒体组缓存和处理逻辑，提高程序稳定性和效率
  - 改进了媒体组获取超时和频率控制，避免触发 Telegram API 限制

### 实现细节

- **媒体组处理器增强**：
  - 添加了`fetching_media_groups`集合，用于跟踪正在获取的媒体组
  - 新增`last_media_group_fetch`字典，记录每个媒体组的上次获取时间
  - 设置了最小获取间隔参数(`media_group_fetch_interval`)，默认为 3 秒
  - 新增`_add_message_to_cache`方法，优化消息缓存逻辑，减少代码重复
  - 改进了锁机制和资源清理，确保并发安全和资源正确释放

## 1.9.35 (2025-06-25)

### 代码重构

- **监听模块重构**：
  - 将监听模块拆分为多个文件，按照功能职责进行划分
  - 创建了 `src/modules/monitor/` 目录，包含 core.py, text_filter.py, message_processor.py, media_group_handler.py, history_fetcher.py 等文件
  - 优化了代码组织结构，降低了类的复杂度，提高了代码的可维护性
  - 分离了文本过滤、消息处理、媒体组处理等功能到专门的类中
  - 添加了详细的类型注解和文档字符串，提高了代码可读性
  - 保持了与原监听模块完全相同的功能和接口，确保了向后兼容性

### 实现细节

- **核心组件分离**：
  - TextFilter 类：负责关键词过滤和文本替换规则的应用
  - MessageProcessor 类：专注于消息的处理和转发
  - MediaGroupHandler 类：处理媒体组消息的缓存、组装和转发
  - 历史消息获取功能：单独抽离为 history_fetcher 模块
- **改进错误处理**：各组件都具有更完善的错误处理机制，提高了程序的稳定性
- **模块文档**：添加了 README.md 文件，详细说明了重构后的模块结构和使用方法

## 1.9.34 (2025-06-18)

### 代码优化

- **监听模块清理**：
  - 删除了未使用的 `_monitor_channel` 函数，减少代码冗余
  - 清理了旧版本的频道监听实现代码，保留更高效的统一监听处理方式
  - 提高了代码可维护性，减少潜在的混淆和维护负担

### 性能优化

- 优化了媒体组消息处理的性能，支持并发转发和发送
- 减少了媒体组转发的等待时间，提高了大量媒体组处理的效率
- 简化了媒体组权限检查逻辑，直接尝试最佳方法转发
- 增强了媒体组转发失败时的容错处理机制

## 1.9.33 (2023-12-05)

### 增强

- **转发模块**:
  - 添加自定义文字尾巴功能，支持在转发完成后发送一条自定义格式的 HTML 消息
  - 实现 HTML 消息解析器，支持粗体、斜体、下划线、超链接和表情符号
  - 增加消息模板加载系统，可从外部 HTML 文件加载消息内容
  - 添加发送失败自动重试机制，最多尝试 3 次
- **UI 改进**:
  - 优化转发配置页面布局，添加自定义消息选项
  - 新增 HTML 消息预览功能，实时显示格式化后的消息效果
  - 改进文件选择对话框，增加 HTML 文件过滤器
- **性能优化**:
  - 优化批量转发过程中的内存使用
  - 减少 API 调用频率，避免触发 Telegram 限制

### 错误修复

- 修复转发过程中因消息格式不兼容导致的崩溃问题
- 解决 HTML 消息中特殊字符转义不正确的问题
- 修复多线程环境下偶发的转发队列混乱问题

## 1.9.32 (2025-06-15)

### 错误修复

- **转发模块异步任务处理优化**：
  - 修复了"Cannot enter into task ... while another task ... is being executed"错误
  - 重构了`forward_view.py`中的`_start_forward`方法，使用`run_async_task`改进异步任务处理
  - 新增`_run_forward_task`异步方法，改善任务执行流程，避免任务嵌套问题
  - 添加了`_update_forward_status`槽函数，用于安全地在主线程中更新转发状态
  - 改进了`_stop_forward`方法，确保正确取消任务并清理资源
  - 强化了取消和完成时的资源清理机制，移除任务回调以避免循环引用
  - 使用`QMetaObject.invokeMethod`在主线程中安全地更新 UI，替代直接从异步任务调用 UI 方法
  - 安全地处理`CancelledError`异常，确保任务取消时不会出现未处理的异常
- **导入错误修复**：
  - 修复了`QCursor`导入错误，将其从`PySide6.QtWidgets`移动到正确的`PySide6.QtGui`模块
  - 解决了导航到下载模块时出现的"cannot import name 'QCursor' from 'PySide6.QtWidgets'"错误

### 实现细节

- **异步通信机制改进**：
  - 借鉴`upload_view.py`中的异步任务处理模式，统一了转发和上传模块的任务处理方式
  - 在转发完成和出错时使用`QTimer.singleShot`延迟显示对话框，避免 UI 阻塞
  - 为错误显示添加了回退机制，确保即使对话框显示失败，用户仍能看到错误信息
  - 添加了`forward_task`属性以保持对任务的引用，便于取消和资源清理
  - 提高了转发大量媒体时的稳定性，解决了偶发的崩溃问题

### 右键菜单功能增强

- **为下载模块添加频道列表右键菜单**：
  - 支持编辑和删除操作
- **为上传模块添加目标频道右键菜单**：
  - 支持编辑和删除操作
- **统一各模块右键菜单用户体验**：
  - 提高操作一致性
- **优化编辑对话框布局**：
  - 提供更友好的编辑界面

## 1.9.31 (2025-06-10)

### 错误修复

- **转发模块异步任务处理优化**：
  - 修复了"Cannot enter into task ... while another task ... is being executed"错误
  - 重构了`forward_view.py`中的`_start_forward`方法，使用`run_async_task`改进异步任务处理
  - 新增`_run_forward_task`异步方法，改善任务执行流程，避免任务嵌套问题
  - 添加了`_update_forward_status`槽函数，用于安全地在主线程中更新转发状态
  - 改进了`_stop_forward`方法，确保正确取消任务并清理资源
  - 强化了取消和完成时的资源清理机制，移除任务回调以避免循环引用
  - 使用`QMetaObject.invokeMethod`在主线程中安全地更新 UI，替代直接从异步任务调用 UI 方法
  - 安全地处理`CancelledError`异常，确保任务取消时不会出现未处理的异常

### 实现细节

- **异步通信机制改进**：
  - 借鉴`upload_view.py`中的异步任务处理模式，统一了转发和上传模块的任务处理方式
  - 在转发完成和出错时使用`QTimer.singleShot`延迟显示对话框，避免 UI 阻塞
  - 为错误显示添加了回退机制，确保即使对话框显示失败，用户仍能看到错误信息
  - 添加了`forward_task`属性以保持对任务的引用，便于取消和资源清理
  - 提高了转发大量媒体时的稳定性，解决了偶发的崩溃问题

## 1.9.30 (2025-06-06)

### 错误修复

- **转发模块消息范围处理**：
  - 修复了频道对配置中`start_id`和`end_id`为`None`时导致的转发失败问题
  - 增强了`_get_media_groups_info`和`_get_media_groups`方法中对`start_id`和`end_id`的健壮性处理
  - 改进了配置转换逻辑，确保每个频道对配置中的`start_id`和`end_id`被正确转换为整数
  - 修复了配置转换过程中忽略频道对配置中媒体类型的问题
  - 针对无效的 ID 值提供了更明确的日志警告，提高故障排查效率

### 实现细节

- **配置转换逻辑增强**：
  - 优化`convert_ui_config_to_dict`函数，正确处理频道对配置中的参数
  - 删除公共`start_id`和`end_id`配置项，统一使用频道对中的对应配置
  - 为每个频道对配置添加错误处理，确保即使配置无效程序也能正常运行
  - 提高了程序对不同配置格式的兼容性和容错能力

## 1.9.29 (2025-06-05)

### 功能改进

- **上传模块 UI 优化**：
  - 移除了"使用自定义作为说明文字模板"功能，简化用户界面
  - 添加了"上传完成后发送最后一条消息"功能，支持在上传完成后自动发送一条总结性消息
  - 新功能支持 HTML 格式的文本消息，可包含表情符号、加粗文本和超链接
  - 添加了 HTML 文件选择对话框，便于用户选择预先编写好的 HTML 消息文件

### 实现细节

- **配置选项调整**：

  - 修改了上传配置选项结构，将`use_custom_template`替换为`send_final_message`
  - 新增`final_message_html_file`配置项，用于存储 HTML 文件路径
  - 确保配置文件与 UI 界面选项保持一致，支持无缝保存和加载配置

- **上传逻辑增强**：
  - 在 uploader.py 中实现了`_send_final_message`方法，负责在上传完成后发送最终消息
  - 使用 pyrogram 的 HTML 解析模式发送消息，支持超链接预览
  - 添加了错误重试机制，最多尝试 3 次确保消息能够成功发送
  - 实现了新的事件通知机制，包括`final_message_sent`和`final_message_error`事件

### 用户指南

- **使用说明**：
  - 在上传选项面板中选择"上传完成后发送最后一条消息"选项
  - 点击"浏览..."按钮选择 HTML 格式的消息文件
  - HTML 文件可以包含表情符号、超链接(`<a href="链接">文本</a>`)、粗体(`<b>文本</b>`)和斜体(`<i>文本</i>`)等格式
  - 所有上传文件完成后，系统会自动向目标频道发送最终消息

## 1.9.28 (2025-06-01)

### 错误修复

- **视频缩略图生成问题修复**：修复了"object str can't be used in 'await' expression"错误

  - 修正了`uploader.py`中对`VideoProcessor`方法的调用方式
  - 将错误使用的同步方法`extract_thumbnail`改为使用异步方法`extract_thumbnail_async`
  - 正确添加了`await`关键字于异步方法调用
  - 确保视频缩略图能够正确生成并用于视频上传

- **上传历史记录问题修复**：修复了"HistoryManager.add_upload_record() missing 1 required positional argument: 'media_type'"错误

  - 更正了`uploader.py`中对`add_upload_record`方法的调用，提供所有必需的参数
  - 正确传递文件路径、目标频道、文件大小和媒体类型四个参数
  - 解决了因参数不足导致的上传历史记录失败问题，防止重复上传已成功发送的文件

- **事件和信号处理问题修复**：修复了事件处理和信号发射相关的错误

  - 解决了"找不到与事件类型 file_uploaded 对应的信号 file_uploaded_updated"警告
  - 修复了"media_uploaded() only accepts 0 argument(s), 1 given!"错误
  - 在事件映射中添加了`file_uploaded`和`media_upload`事件到`media_uploaded`信号的映射
  - 将信号参数类型从`Dict`改为更通用的`object`类型以适应不同数据格式
  - 优化了事件处理逻辑，确保`complete`事件也会触发`all_uploads_completed`信号

- **异步任务嵌套问题修复**：解决了"Cannot enter into task ... while another task ... is being executed"错误
  - 重构了上传任务的异步执行机制，避免任务嵌套导致的 RuntimeError
  - 添加了`run_async_task`工具函数，通过独立事件循环安全地执行异步任务
  - 使用`QMetaObject.invokeMethod`在主线程中更新 UI，替代直接从异步任务调用 UI 方法
  - 添加了信号槽机制处理上传完成和错误状态，确保 UI 操作在正确的线程上执行
  - 提高了应用在高负载上传任务下的稳定性，消除了偶发的崩溃问题

## 1.9.27 (2025-05-25)

### 错误修复

- **同义关键词配置问题修复**：修复了同义关键词在保存配置时的问题
  - 修复了同义关键词组（如"关键词 1-关键词 2-关键词 3"）在配置文件中保存为嵌套字符串的问题
  - 确保配置文件中的关键词正确保存为字符串列表，而不是包含一个嵌套字符串的列表
  - 优化了配置加载过程对关键词的处理，支持正确加载同义关键词

## 1.9.26 - 2025-05-28

### 重要修复

- **监听配置加载修复**: 修复了监听界面中关键词和排除项配置无法正确加载显示的关键问题
  - 在UIConfigManager的配置转换过程中，之前缺少对关键词(`keywords`)和排除项(`exclude_forwards`, `exclude_replies`, `exclude_media`, `exclude_links`)的处理
  - 导致即使配置文件中有正确的关键词和排除项设置，程序运行时这些字段始终为空
  - 现在已正确处理这些字段的加载、验证和保存，确保监听配置的完整性
  - 重启程序后，监听界面中的关键词和排除项设置现在能正确显示

### 新增功能

- **监听界面右键菜单功能**: 为监听界面的已配置频道对列表添加了右键菜单支持
  - 仿照历史转发界面的实现，为监听频道对添加了编辑和删除功能
  - 右键点击频道对列表项可弹出菜单，选择"编辑"或"删除"
  - 编辑功能提供完整的对话框，支持修改所有监听参数：
    - 源频道和目标频道设置
    - 文本替换规则配置
    - 媒体类型选择（照片、视频、文档、音频、动画、贴纸、语音、视频笔记）
    - 过滤选项（关键词、排除转发消息、排除回复消息、排除媒体消息、排除包含链接的消息）
    - 其他选项（移除媒体说明）
  - 编辑后自动更新显示文本和数据，提醒用户保存配置

### 技术改进

- **配置处理增强**: 在UIConfigManager中为监听频道对添加了完整的关键词和排除项处理逻辑
- **数据验证**: 增强了关键词的验证，确保只保存非空的有效关键词
- **类型安全**: 确保排除项始终为布尔类型，关键词始终为字符串列表
- **UI交互优化**: 监听界面现在支持右键编辑频道对，提升用户体验

## 1.9.25 - 2025-05-28

### 功能优化

- **下载命令简化**：
  - 移除了`downloadKeywords`命令行参数，统一通过`download`命令执行所有下载任务
  - 自动识别配置中的关键词参数，根据每个下载设置决定目录组织方式
  - 当设置中有关键词时，按照`downloads/[频道]/[关键词]/[文件或媒体组]`组织文件
  - 当设置中没有关键词时，按照`downloads/[频道]/[文件或媒体组]`组织文件
  - 取消了"关键词模式"的概念，改为自动根据配置判断目录结构

### 代码优化

- **下载模块重构**：
  - 删除了`use_keywords`标志和相关模式切换代码
  - 使用`_setting_has_keywords`函数判断每个下载设置是否包含关键词
  - 简化了用户使用流程，不再需要选择不同的命令来进行不同类型的下载
  - 为每个下载设置单独确定目录组织方式，支持同时处理有关键词和无关键词的设置
  - 修复了 UI 界面中事件发射器包装类对已删除属性和方法的引用，确保 GUI 能正常初始化
  - 优化了日志输出，清晰显示每个下载设置的目录组织方式

## 1.9.24 - 2025-05-25

### 文件结构优化

- **统一目录结构**：
  - 重构文件结构，统一普通下载和关键词下载的目录组织逻辑
  - 所有下载文件现在都会保存在对应的频道子目录中
  - 普通下载模式：`downloads/[频道]/[文件或媒体组]`
  - 关键词下载模式：`downloads/[频道]/[关键词]/[文件或媒体组]`

### 信息文件简化

- **移除冗余文件**：
  - 删除了`channel_info.txt`文件，减少冗余存储
  - 简化`title.txt`文件内容，现在只保存媒体组或消息的标题信息
  - 统一信息文件存储位置和命名规范

### 代码优化

- **目录处理重构**：
  - 修正目录创建逻辑，确保在所有下载模式下正确创建频道目录
  - 优化路径变量处理，解决关键词模式下路径错误问题
  - 统一媒体组和单条消息的处理流程，保持一致的目录结构

## 1.9.23 - 2025-05-22

### 功能优化

- **下载目录结构统一**：
  - 重构下载目录组织逻辑，统一普通下载和关键词下载的目录结构
  - 普通下载模式：`downloads/[频道]/[文件或媒体组]`
  - 关键词下载模式：`downloads/[频道]/[关键词]/[文件或媒体组]`
  - 修复了关键词下载可能直接存储在根目录的问题，确保文件正确存放在频道子目录

### 文件管理改进

- **信息文件简化**：
  - 删除`channel_info.txt`相关代码，减少冗余文件
  - 简化`title.txt`文件内容，只保存媒体组或单条消息的说明文字（caption）
  - 优化信息存储逻辑，不再存储不必要的元数据，如消息 ID、下载时间等

### 代码优化

- **目录处理逻辑重构**：
  - 修正目录组织变量，确保所有下载模式下都能正确创建频道目录
  - 优化目录路径变量传递，解决关键词模式下文件路径不正确的问题
  - 统一媒体组和单条消息的处理逻辑，确保一致的目录结构

## 1.9.22 - 2025-05-20

### 错误修复

- **下载模块修复**：
  - 修复了\_iter_messages 函数忽略结束消息 ID 的问题，确保指定范围内的所有消息（包括 end_id 指定的消息）都能被正确获取并下载
  - 完善了消息获取机制，现在会在多个阶段尝试获取 end_id 指定的消息，包括预先获取、批处理后检查和最终验证，显著提高了下载完整性
  - 添加了重试机制，对于难以获取的结束 ID 消息，会进行多次尝试，确保最大限度地获取所有指定消息
  - 改进了消息获取的日志记录，提供更详细的进度反馈
  - 增强了错误处理机制，防止在获取特定消息时的异常影响整体下载进程

## 1.9.21 - 2025-05-15

### 性能优化

- **日志查看器异步改进**：
  - 使用 qasync 重构日志查看器，解决界面卡顿问题
  - 将日志加载、解析和筛选操作移至后台线程执行，大幅提升 UI 响应速度
  - 使用`AsyncTimer`替代`QTimer`进行自动刷新，减少主线程阻塞
  - 通过事件循环执行器隔离耗时的 IO 操作，确保用户界面流畅响应

### 界面简化

- **日志查看器界面优化**：
  - 移除文件选择相关控件，包括"日志文件:"文本框、"浏览..."按钮和"刷新"按钮
  - 移除表格中的"来源"和"行号"列，保留"时间"、"级别"和"消息"列以提高信息密度
  - 移除自动刷新和自动滚动复选框，默认启用这些功能以简化用户操作
  - 移除导出日志按钮及相关代码，使界面更加精简

### 用户体验改进

- **日志显示优化**：
  - 设置默认显示 INFO 级别的日志，减少 DEBUG 信息干扰，聚焦重要消息
  - "清空过滤器"操作现在保持 INFO 级别筛选不变，而非显示所有级别
  - 优化状态栏消息更新逻辑，避免在自动刷新时重复显示"加载了 xxx 条日志记录"
  - 使用异步信号机制实现 UI 更新，确保即使处理大量日志时界面也保持响应

### 代码优化

- **异步通信机制改进**：
  - 实现日志加载完成信号和状态更新信号，规范化异步通信
  - 添加加载状态标志，避免重复加载操作导致的资源浪费
  - 使用事件循环运行 IO 操作，避免阻塞 UI 线程
  - 简化代码结构，移除冗余的控制逻辑，提高可维护性

## 1.9.20 - 2025-05-12

### 功能增强

- **初始化状态界面管理**：
  - 添加了程序启动过程中的初始化状态管理功能
  - 在状态栏显示"初始化中，请稍等..."提示，并将状态栏背景设置为淡红色
  - 在初始化过程中禁用界面操作，防止用户在功能模块尚未初始化完成时进行误操作
  - 用户尝试在初始化过程中点击导航树项目时会显示友好的提示信息

### 错误修复

- **修复未初始化时报错问题**：
  - 解决了程序未全部初始化完成时用户点击导航树模块导致的"下载器实例为空，无法设置"错误
  - 添加了对初始化状态的检查，确保功能模块在准备就绪后才能被访问
  - 优化了异常处理，即使在初始化过程中或异常退出时也能正确恢复界面启用状态

### 用户体验改进

- **初始化过程视觉反馈**：
  - 通过状态栏背景颜色变化提供明确的视觉反馈，区分初始化中和初始化完成状态
  - 初始化完成后自动恢复界面正常状态，并显示"初始化完成"消息
  - 增加了在程序退出时自动恢复界面启用状态的机制，防止界面被永久锁定

### 代码优化

- **界面状态管理**：
  - 添加了`set_initialization_state`和`set_ui_enabled`方法，统一管理界面初始化状态
  - 在`TGManagerApp`类中添加了初始化状态标志，并在关键流程中更新此标志
  - 优化了导航树处理逻辑，添加初始化状态检查以提供更好的用户体验

## 1.9.19 - 2025-05-10

### 代码结构优化

- **应用代码重构**：
  - 将大型的`app.py`文件拆分为多个模块化文件，放置在`src/ui/app_core`目录下
  - 建立了`src/ui/app_core/app.py`作为应用程序主类，集成所有子模块功能
  - 创建了`src/ui/app_core/config.py`负责配置管理
  - 创建了`src/ui/app_core/async_services.py`负责异步服务和组件初始化
  - 创建了`src/ui/app_core/network.py`处理网络连接检查功能
  - 创建了`src/ui/app_core/cleanup.py`负责资源清理功能
  - 创建了`src/ui/app_core/theme.py`负责主题管理
  - 创建了`src/ui/app_core/client.py`负责客户端管理
  - 创建了`src/ui/app_core/first_login.py`负责首次登录处理

### 代码质量改进

- **可维护性提升**：
  - 通过模块化设计，每个文件现在都有明确的单一职责
  - 降低了代码复杂度，使错误定位和修复更加容易
  - 增强了代码可读性，新的模块化结构更易于理解和维护
  - 保持了原有功能的完整性，确保应用行为与重构前保持一致
  - 修复了`ThemeManagerWrapper`类中缺少`get_current_theme_name`方法的问题

### 架构优化

- **依赖解耦**：
  - 通过合理的模块化设计，减少了各组件之间的紧耦合
  - 使用信号机制进行组件间通信，降低了直接依赖
  - 实现了更清晰的责任分离，使未来的功能扩展和修改更加简单

## 1.9.18 - 2025-05-08

### 功能增强

- **登录功能优化**：
  - 改进首次登录体验，自动打开设置界面并显示指导对话框
  - 优化验证码输入界面，增加验证码格式限制和按钮状态控制
  - 登录成功后及时更新状态栏和设置界面的用户登录状态信息
  - 在登录过程中提供更详细的状态反馈和错误处理

### 用户体验改进

- **首次使用引导**：
  - 添加首次登录检测机制，自动识别是否为用户首次使用程序
  - 增加友好的引导对话框，提供 API 凭据获取和登录过程的详细指导
  - 确保用户在首次使用时能够轻松完成账号配置和登录流程

### 错误处理增强

- **登录异常处理**：
  - 完善登录过程中的异常捕获和处理机制
  - 提供更友好的错误提示信息，帮助用户快速解决登录问题
  - 优化异步登录流程，确保线程安全和 UI 响应性

## 1.9.17 - 2025-05-05

### 错误修复

- **解决会话数据库锁定问题**:
  - 修复了客户端重新连接时遇到的"database is locked"错误，添加了会话数据库锁定检测和自动修复机制
  - 当检测到会话数据库被锁定时，会自动备份并重置数据库文件，允许程序继续运行
  - 优化了客户端停止流程，确保会话数据库连接正确关闭和资源释放
  - 增加了会话数据库锁定的错误追踪和用户提示功能，在多次修复失败时提醒用户重启应用

### 稳定性改进

- **客户端管理器增强**:
  - 增加了错误历史记录功能，跟踪最近的 10 个连接错误，帮助诊断反复出现的问题
  - 改进了客户端停止和重启流程，减少资源泄漏和竞态条件的可能性
  - 为连接检查添加了超时处理，避免长时间阻塞导致的程序卡顿
  - 在会话数据库修复后主动进行垃圾回收，确保资源被正确释放

### 用户体验优化

- **错误处理与用户反馈**:
  - 添加了在持续出现数据库锁定错误时向用户显示操作建议的功能
  - 优化了日志记录，提供更清晰的错误分类和上下文信息
  - 状态栏实时显示连接状态变化，确保用户能够了解当前应用状态
  - 在检测到会话数据库问题时提供手动解决方案的指导

## 1.9.16 - 2025-05-02

### 用户界面改进

- **状态栏客户端状态显示增强**:
  - 修复了代理断开后状态栏客户端状态不更新的问题
  - 优化了状态栏客户端状态显示样式，增加粗体显示，断开连接时使用红色高亮提示
  - 添加了状态更新的实时刷新机制，确保状态变化立即反映在界面上

### 连接管理优化

- **代理连接状态检测增强**:
  - 为连接检查添加了超时处理机制，避免连接检查长时间阻塞
  - 扩展了代理错误关键词匹配范围，提高了代理问题的检测准确性
  - 根据连接状态动态调整检查频率，在连接异常时增加检查频率

### 稳定性提升

- **客户端重启过程改进**:
  - 重构了客户端重启流程，确保状态信号发送更可靠
  - 增加了异常处理机制，避免重启失败时 UI 状态不一致
  - 改进了代理配置刷新逻辑，确保使用最新的代理设置

## 1.9.15 - 2025-04-30

### 界面精简

- **移除网络延时显示功能**:
  - 从状态栏中移除了网络延时显示功能，保留客户端连接状态显示
  - 移除了网络状态定时检查器和相关的异步网络测试代码
  - 优化状态栏布局，使界面更加简洁明了
  - 减少了对 aiohttp 的依赖使用

### 代码优化

- **代码清理与优化**:
  - 移除了所有与网络延时检测相关的冗余代码
  - 优化了状态栏创建和资源管理流程
  - 简化了应用关闭时的计时器清理过程
  - 提高了应用启动和运行时的性能

### 修复

- **修复代理断开时状态栏不更新问题**：优化了代理连接状态检测机制，当代理断开连接时，状态栏会及时更新客户端状态
- **修复代理恢复后客户端不自动重连问题**：增强了网络连接自动恢复功能，在代理恢复后客户端能够自动重连
- **网络连接检查优化**：缩短了网络状态检查间隔，从 10 秒减少到 5 秒，使客户端能更快响应网络状态变化
- **代理配置管理改进**：在客户端重启过程中自动刷新代理配置，确保始终使用最新的代理设置

## 1.9.14 - 2025-04-28

### 界面精简

- **移除网络延时显示功能**:
  - 从状态栏中移除了网络延时显示功能，保留客户端连接状态显示
  - 移除了网络状态定时检查器和相关的异步网络测试代码
  - 优化状态栏布局，使界面更加简洁明了
  - 减少了对 aiohttp 的依赖使用

### 代码优化

- **代码清理与优化**:
  - 移除了所有与网络延时检测相关的冗余代码
  - 优化了状态栏创建和资源管理流程
  - 简化了应用关闭时的计时器清理过程
  - 提高了应用启动和运行时的性能

## 1.9.13 - 2025-04-26

### 状态栏增强

- **网络状态显示改进**:
  - 将原有的网络状态显示（已连接/断开）改为网络延时显示（"网络：XXms"格式）
  - 根据网络延时不同，显示不同颜色：<100ms 为绿色，<300ms 为蓝色，<500ms 为橙色，>=500ms 为红色
  - 支持使用 SOCKS5 代理和不使用代理的网络检测
  - 将网络状态检查频率从 30 秒提高到 10 秒，提供更及时的网络状态反馈
  - 优化网络状态检测逻辑，增加对代理配置的自动识别

### 网络延时检测修复

- **检测逻辑优化**:
  - 修复网络检测时的"Timeout context manager should be used inside a task"错误
  - 改进网络连接检测，代理模式使用 Telegram API 测试，非代理模式使用百度测试
  - 简化网络状态显示逻辑，未连接状态统一显示为"网络：未连接"
  - 移除冗余的\_update_network_status 方法，简化代码结构
  - 优化状态栏初始显示，默认显示"网络：未连接"，颜色为红色，直到成功检测到网络连接

## 1.9.12 - 2025-04-25

### 用户界面优化

- **简化任务概览组件**:
  - 移除任务概览组件中的任务计数器部分，避免与状态栏中的任务统计信息重复
  - 优化任务列表显示区域，提供更多空间展示活动任务
  - 重命名组件标题从"当前任务概览"为"任务列表"，更准确反映其功能
  - 保留`update_counters`方法接口以确保向后兼容性

### 代码优化

- **状态栏与任务组件协同**:
  - 增强 TaskView 类中的任务统计功能，添加`get_task_statistics`方法提供更精确的任务统计数据
  - 添加`tasks_updated`信号，在任务状态变化时通知主窗口更新状态栏
  - 优化任务添加和移除逻辑，确保状态栏数据实时更新
  - 重构`_add_sample_tasks`方法，直接使用状态栏更新功能

## 1.9.11 - 2025-04-22

### 功能增强

- **状态栏信息增强**:
  - 添加了任务统计信息显示功能，在状态栏实时显示运行中、等待中和已完成的任务数量
  - 根据任务状态动态调整显示颜色，提供更直观的视觉反馈（运行中任务为蓝色，等待中任务为橙色，无活动任务为绿色）
  - 优化了所有状态栏组件的布局和样式，增加了最小宽度设置，确保信息显示完整
  - 在视图组件之间添加任务状态同步机制，确保状态栏信息与任务概览保持一致
  - 添加了任务状态变化时的自动更新功能，包括任务暂停、恢复、取消和完成时的状态刷新
  - 实现了应用关闭时的资源清理增强，确保所有定时器和任务得到妥善处理

### 代码优化

- **任务状态管理改进**:
  - 添加`_refresh_task_statistics`方法，实现从任务管理器获取最新任务数据的功能
  - 重构任务操作方法（暂停、恢复、取消），确保操作后状态统计得到更新
  - 优化应用关闭逻辑，实现任务的优雅取消和资源释放
  - 将任务统计功能与已有的任务概览组件集成，保持数据一致性

## 1.9.10 - 2025-04-20

### Bug 修复

- **视图加载错误修复**:
  - 修复主窗口 `get_view` 方法导致的 'MainWindow' object has no attribute 'download_view' 错误
  - 重构 `get_view` 方法，使其从 `opened_views` 字典中获取视图组件，而不是直接访问不存在的属性
  - 添加视图名称到导航项 ID 的映射关系，确保延迟加载视图时能够正确获取
  - 添加详细的日志记录，在视图不存在时提供明确的反馈
  - 提高应用程序在视图尚未创建时的健壮性
  - 解决了功能模块初始化后无法将其设置到视图组件的问题，优化了应用启动流程

## 1.9.9 - 2023-11-10

### 主要变更

- 完成从 QtAsyncio 到 qasync 的迁移，移除对 QtAsyncio 的依赖
- 添加 qasync 版本检测和兼容性层，支持跨版本 qasync 和回退到标准 asyncio
- 增强`AsyncTaskManager`，添加任务组功能和更完善的异常处理

### 新增特性

- 支持 qasync 多版本，提供统一异步操作接口
- 改进的任务管理功能，包括任务组化和批量控制能力
- 添加异步操作性能追踪与分析功能
- 增强 UI 响应性，减少异步操作对主线程的阻塞

### 文档更新

- 更新迁移计划文档，详细描述 qasync 兼容性方案
- 添加 qasync 使用的最佳实践指南
- 更新 README 中的依赖说明，明确指定 qasync 作为新依赖

### 代码优化

- 重构`async_utils.py`，提供更一致的异步操作接口
- 优化异步调度策略，提高并发任务执行效率
- 简化事件循环管理，统一不同版本的 qasync 接口

### Bug 修复

- 修复在某些操作系统上 qasync 初始化失败的问题
- 解决并发任务取消时可能出现的竞态条件
- 修复异步任务完成回调中的异常处理逻辑

## 1.9.8 - 2025-04-17

### 主要变更

- 移除 QtAsyncio 依赖，实现与 qasync 的集成
- 优化事件循环管理和异步任务执行
- 完成功能集成阶段，所有核心服务和功能组件已成功集成到界面程序中

### 新增特性

- 支持 qasync 多版本，提供统一异步操作接口
- 改进的任务管理功能，包括任务组化和批量控制能力
- 添加异步操作性能追踪与分析功能
- 增强 UI 响应性，减少异步操作对主线程的阻塞

### 文档更新

- 更新迁移计划文档，详细描述 qasync 兼容性方案
- 添加 qasync 使用的最佳实践指南
- 更新 README 中的依赖说明，明确指定 qasync 作为新依赖

### 代码优化

- 重构`async_utils.py`，提供更一致的异步操作接口
- 优化异步调度策略，提高并发任务执行效率
- 简化事件循环管理，统一不同版本的 qasync 接口

### Bug 修复

- 修复在某些操作系统上 qasync 初始化失败的问题
- 解决并发任务取消时可能出现的竞态条件
- 修复异步任务完成回调中的异常处理逻辑

## 1.9.7 - 2025-04-15

### 功能增强

- **核心服务集成**:

  - 将`run.py`中的核心服务（客户端管理、配置系统、日志等）完全集成到`run_ui.py`中
  - 确保所有核心服务支持 QtAsyncio，提高 UI 响应性和性能
  - 优化服务初始化流程，确保各服务以正确的顺序启动，减少依赖冲突

- **核心功能组件集成**:
  - 在`TGManagerApp`类中集成了所有核心功能组件:
    - 完成客户端管理器、频道解析器、历史记录管理器的完整集成
    - 根据配置动态选择并行或顺序下载模式
    - 添加上传、转发和监听模块的完整初始化代码
  - 实现功能模块与视图组件的连接:
    - 添加`_initialize_views`方法将功能模块传递给相应视图组件
    - 在视图组件中添加设置方法（如`set_downloader`、`set_uploader`等）
    - 使用信号连接机制实现功能模块和 UI 之间的通信
  - 优化资源管理和异常处理:
    - 实现资源的依赖注入，减少模块间的硬耦合
    - 统一异常处理方式，确保应用稳定性

### 代码优化

- **应用初始化过程改进**:
  - 重构`async_run`和`_init_async_services`方法，支持异步初始化流程
  - 优化服务启动顺序，确保依赖服务先初始化
  - 改进错误处理，提供详细的启动阶段错误日志

## 1.9.6 - 2025-04-14

### 修复

- **频道消息 URL 解析修复**:
  - 修复了`downloader_serial.py`模块中处理消息 URL 格式`https://t.me/channel_name/123`的问题
  - 更新了频道解析逻辑，正确处理`resolve_channel`函数返回的元组结果
  - 改进了代码以正确提取和使用真实的频道 ID 进行下载
  - 优化了消息下载判断逻辑，确保使用正确的频道 ID 检查消息是否已下载
  - 完善了日志输出，更准确地反映频道处理的上下文
  - 提高了程序在处理不同格式的频道链接时的稳定性

## 1.9.5 - 2025-04-13

### 功能增强

- **Telegram 登录流程优化**:
  - 改进了登录对话框，在点击"确定"按钮后添加验证码输入步骤
  - 实现了验证码输入对话框，包含清晰的操作提示和说明
  - 添加了验证码输入验证，仅允许输入数字
  - 优化了用户体验，在未输入验证码时禁用"确定"按钮
  - 完善了登录状态的提示和反馈，在状态栏显示当前登录状态
  - 为后续实现实际登录功能做好准备

### 修复

- **导入错误修复**:
  - 修复了 `QRegularExpressionValidator` 导入错误，将其从 `PySide6.QtGui` 模块导入而非 `PySide6.QtCore`
  - 确保了验证码输入对话框的数字验证功能正常工作
  - 解决了应用程序启动时的导入异常问题

## 1.9.4 - 2025-04-12

### 修复

- **配置参数引用修正**:
  - 修正了 `downloader_serial.py` 模块中引用了不存在的配置参数问题
  - 删除了对 `exclude_types` 和 `max_file_size` 参数的引用，这些参数在 config.json 中不存在
  - 将 `download_channels` 参数引用修改为正确的 `downloadSetting`
  - 从 GENERAL 配置部分获取 `limit` 参数，而非 DOWNLOAD 部分
  - 使用 `pause_time` 替代不存在的 `download_delay` 参数
  - 增加了对配置文件中媒体类型过滤的支持，确保只下载配置的媒体类型

### 代码优化

- **配置一致性优化**:
  - 提高了配置文件与代码实现之间的一致性
  - 统一了各模块对配置项的命名和使用方式
  - 增强了参数缺失情况下的默认值处理，提高代码健壮性
  - 优化了下载限制计算逻辑，支持通过 start_id 和 end_id 计算下载量

## 1.9.3 - 2025-04-11

### 代码优化

- **应用关闭逻辑优化**:
  - 修复了应用程序关闭时出现的"Event loop is already running"错误
  - 优化了 cleanup 方法中的事件循环处理逻辑，避免在事件循环已运行的情况下执行可能导致冲突的操作
  - 完善了异常处理和日志记录，提供更清晰的状态信息
  - 提高了应用程序关闭过程的稳定性和可靠性

## 1.9.2 - 2025-04-10

### 修复

- **多协程并发演示任务取消问题修复**:
  - 修复了 QtAsyncio 测试模块中"多协程并发演示"功能点击"停止演示"后，素数计算任务仍在后台运行的问题
  - 完善了 Eratosthenes 类的任务管理机制，通过添加 tasks 列表对所有创建的子任务进行跟踪
  - 添加 cancelled 标志和 cancel_all_tasks 方法，确保所有子任务能够被正确取消
  - 优化了任务循环中的取消检测，在各个重要循环中添加了取消检查点
  - 完善了异常处理和状态恢复逻辑，确保在任务被取消时 UI 状态能够正确重置
  - 增加了子任务取消日志，方便调试和监控任务状态
  - 改进了停止按钮点击处理逻辑，尝试获取所有运行中的任务进行取消

### 代码优化

- **模块初始化过程重构**:
  - 优化各模块的初始化过程，统一接收`UIConfigManager`实例
  - 重构配置获取方式，使用`get_ui_config()`和`convert_ui_config_to_dict()`方法
  - 提高代码可读性和可维护性，减少代码冗余
  - 简化配置处理流程，消除不必要的中间转换层

## 1.9.1 - 2025-04-10

### 功能增强

- **配置管理系统完全统一**:
  - 完成了所有模块从`ConfigManager`到`UIConfigManager`的迁移工作，包括:
    - 更新`uploader.py`模块，使其完全使用`UIConfigManager`和`convert_ui_config_to_dict`工具
    - 更新`forwarder.py`模块，使其完全使用`UIConfigManager`和`convert_ui_config_to_dict`工具
    - 更新`monitor.py`模块，使其完全使用`UIConfigManager`和`convert_ui_config_to_dict`工具
  - 统一所有模块的配置访问方式为字典风格访问，同时保持原有逻辑不变
  - 完善配置转换工具，确保配置数据格式转换的准确性和一致性

### 代码优化

- **模块初始化过程重构**:
  - 优化各模块的初始化过程，统一接收`UIConfigManager`实例
  - 重构配置获取方式，使用`get_ui_config()`和`convert_ui_config_to_dict()`方法
  - 提高代码可读性和可维护性，减少代码冗余
  - 简化配置处理流程，消除不必要的中间转换层

## 1.9.0 - 2025-04-09

### 代码优化

- **配置管理系统优化**:
  - 移除了`UIConfigManager`中未使用的兼容方法：`get_general_config`、`get_download_config`、`get_upload_config`、`get_forward_config`、`get_monitor_config`和`get_proxy_settings`
  - 统一采用更直接的配置访问模式，使用`get_ui_config()`结合`convert_ui_config_to_dict`函数
  - 简化了配置处理流程，减少了不必要的中间转换层
  - 更新了项目集成计划文档，反映新的配置访问方式

### 文档更新

- **项目集成计划完善**:
  - 更新了`ui_assembly_plan.md`文件中的配置管理系统统一部分
  - 简化了配置访问模式的描述，更符合实际实现
  - 提供了更清晰的配置获取示例代码

## 1.8.9 - 2025-04-08

### 功能增强

- **配置管理系统完全统一**:
  - 完成了将所有模块从`ConfigManager`到`UIConfigManager`的迁移工作
  - 更新了`downloader.py`模块，使其完全使用`UIConfigManager`和`convert_ui_config_to_dict`工具
  - 为其他模块(`uploader.py`, `forwarder.py`, `monitor.py`)准备了迁移方案
  - 记录了详细的迁移步骤，并更新了项目集成计划文档
  - 优化了项目架构，减少了代码复杂度和配置转换层
  - 改进了模块初始化过程，使配置获取更加直接和高效
  - 增强了配置访问的一致性，统一采用字典风格的访问方式

### 文档更新

- **项目集成计划文档更新**:
  - 更新了`ui_assembly_plan.md`文件，详细记录了配置管理系统统一的实施过程
  - 添加了每个模块的具体迁移步骤和代码示例
  - 明确了迁移的优先级和顺序，确保项目的平稳过渡
  - 详细说明了`UIConfigManager`中添加的兼容方法的实现和用途
  - 记录了`config_utils.py`工具模块的功能和使用方法

## 1.8.8 - 2025-04-07

### 功能增强

- **配置管理系统统一**:

  - 将所有模块（downloader.py, uploader.py, forwarder.py, monitor.py, client_manager.py）从使用`ConfigManager`迁移到使用`UIConfigManager`
  - 创建了新的`config_utils.py`工具模块，提供了`convert_ui_config_to_dict`函数，用于将 UI 配置对象转换为字典格式
  - 为`UIConfigManager`添加了兼容方法，包括`get_general_config()`、`get_download_config()`、`get_upload_config()`、`get_forward_config()`、`get_monitor_config()`和`get_proxy_settings()`
  - 重构了各模块的初始化过程，使其接受`UIConfigManager`实例而非`ConfigManager`
  - 修改了配置获取方式，采用字典风格的访问方式替代直接属性访问
  - 优化了错误处理和配置验证，增强了系统稳定性
  - 简化了配置管理架构，消除了配置转换层，提高了代码可维护性

- **客户端管理优化**:
  - 重构了`client_manager.py`，使其使用`UIConfigManager`和新的配置工具
  - 更新了`ClientManager`类的初始化和配置加载逻辑
  - 优化了代理设置处理，使用`get_proxy_settings_from_config`函数获取正确格式的代理配置
  - 完善了错误处理机制，提供更详细的错误信息和日志记录

### 修复

- **UI 集成问题修复**:
  - 修复了 UI 界面和核心功能模块之间配置不一致的问题
  - 解决了多处配置转换和读取时可能出现的类型错误
  - 修复了在 UI 界面保存设置后，核心模块无法识别最新配置的问题
  - 确保配置变更能即时反映到所有功能模块中

## 1.8.7 - 2025-04-06

### 功能增强

- **设置界面电话号码添加**:

  - 在设置界面的 API 设置选项卡中添加了手机号码输入字段
  - 更新了配置模型`UIGeneralConfig`，添加`phone_number`字段以保存用户的 Telegram 账号手机号码
  - 修改了`ui_config_models.py`和`ui_config_manager.py`，确保新字段能正确加载和保存
  - 扩展了配置文件格式，在 GENERAL 部分添加 phone_number 字段
  - 升级了`config.json`和`config-example.json`示例文件，支持新的配置字段

- **登录对话框优化**:
  - 改进登录对话框，使其显示设置界面中已配置的登录信息
  - 替换了原有的输入模式，改为显示从设置中读取的 API ID、API Hash 和手机号码
  - 优化了登录信息显示方式，API Hash 只显示前后 6 位，保护用户隐私
  - 登录对话框现在会检查设置中的信息是否完整，若不完整则提示用户并自动打开设置界面
  - 在用户点击"确定"按钮后，直接使用设置中的凭据开始登录流程
  - 改进了登录状态显示，会在状态栏显示"登录中"而非"已登录"

### 修复

- **设置保存与加载优化**:
  - 修复了`settings_view.py`中的`_collect_settings`方法，确保手机号码字段能正确收集和保存
  - 改进了`load_config`方法，确保从配置中正确加载手机号码
  - 优化了配置收集逻辑，确保所有设置项都能正确添加到配置字典中
  - 修复了设置界面中主题选择器命名不一致的问题，统一使用`theme_selector`变量名

## 1.8.6 - 2025-04-06

### 修复

- **实时监听界面转发延迟值保存问题修复**:

  - 修复了实时监听界面中转发延迟值修改后无法正确保存到配置文件的问题
  - 优化了`ListenView`类中的配置保存逻辑，参考`ForwardView`的实现方式
  - 添加了`config_saved`信号以便与主窗口通信
  - 改进了配置保存过程中的日志记录，便于问题诊断
  - 增强了转发延迟值的类型检查，确保在加载时可以正确处理不同类型的值
  - 统一了转发延迟值的处理方式，使用四舍五入到一位小数的方式储存
  - 确保界面与配置文件之间的数据一致性，提高用户体验

- **实时监听界面文本替换配置修复**:

  - 修复了添加频道对时，当用户未输入文本替换内容时，`text_filter`中缺少`original_text`和`target_text`字段的问题
  - 确保在所有情况下，`text_filter`列表至少包含一个默认的空项，避免配置不完整
  - 优化了配置加载逻辑，当配置中`text_filter`为空时，自动添加默认空项
  - 增强了各处配置处理，统一处理`text_filter`的格式，确保数据一致性
  - 修复了保存和加载配置时可能出现的文本替换规则丢失问题

- **代码清理和优化**:
  - 移除了`MainWindow`类中未使用的`_init_views`函数，该函数引用了不存在的`views_stack`变量
  - 清理遗留代码，减少潜在的错误风险
  - 优化了代码结构，提高可维护性

### 功能增强

- **实时监听界面多文本替换规则支持**:

  - 增加同时配置多个文本替换规则的功能，提高批量替换效率
  - 实现通过逗号分隔输入多个原始文本和替换文本，一一对应进行替换
  - 添加输入验证功能，当原始文本和替换文本数量不匹配时，显示警告提示
  - 增强验证机制，禁止使用空字符串作为原始文本，确保替换规则有效
  - 实现精确的错误提示，当检测到空原始文本时，显示准确的错误位置信息
  - 改进输入框提示文本，增加使用示例，提高用户体验
  - 完善异常处理，支持原始文本多于替换文本的情况，自动使用空字符串作为默认替换值
  - 重构文本替换规则显示逻辑，统一添加频道和加载配置两处的显示方式

- **实时监听界面多文本替换规则支持**:
  - 增加同时配置多个文本替换规则的功能，提高批量替换效率
  - 实现通过逗号分隔输入多个原始文本和替换文本，一一对应进行替换
  - 添加输入验证功能，当原始文本和替换文本数量不匹配时，显示警告提示
  - 增强验证机制，禁止使用空字符串作为原始文本，确保替换规则有效
  - 实现精确的错误提示，当检测到空原始文本时，显示准确的错误位置信息
  - 改进输入框提示文本，增加使用示例，提高用户体验
  - 完善异常处理，支持原始文本多于替换文本的情况，自动使用空字符串作为默认替换值
  - 重构文本替换规则显示逻辑，统一添加频道和加载配置两处的显示方式

### 界面改进

- **实时监听界面替换规则显示优化**:

  - 改进了已配置监听频道对的替换规则显示方式，从简单的数量计数改为详细内容展示
  - 优化显示格式为`替换规则：text1->text2，text3->text4`，使用户可以直观地查看替换规则
  - 提高了界面信息的完整性，无需点击编辑即可查看所有替换规则
  - 增强了用户体验，使配置信息一目了然
  - 过滤了空的替换规则，只显示有意义的文本替换内容

- **实时监听界面布局优化**:
  - 调整了"移除媒体说明"复选框的位置，从表单区域移至添加频道对按钮所在行
  - 优化了表单布局空间利用，使界面更加紧凑和直观
  - 改进了用户操作流程，将相关控件放置在更合理的位置
  - 提高了界面美观度和操作便捷性

## 1.8.5 - 2025-04-05

### 功能增强

- **实时监听界面重构**:

  - 重构实时监听界面，使其布局与历史转发界面保持一致
  - 修改界面结构，使其与`UIMonitorConfig`配置结构完全匹配
  - 优化配置面板布局，调整频道配置、过滤选项和转发选项的展示方式
  - 改进频道配置部分，添加文本替换规则支持，完整支持`text_filter`配置
  - 改进已配置监听频道对的显示样式，参考普通下载界面样式，显示更多信息
  - 简化监听选项标签页，只保留标准配置中的`media_types`、`duration`和`forward_delay`
  - 改进消息显示区域，支持按频道分组显示消息
  - 统一配置加载和保存逻辑，确保与配置文件格式一致
  - 提高界面响应性，优化消息处理和添加过程
  - 移除非标准配置字段，确保配置格式的一致性和兼容性

- **文本替换规则默认配置优化**:

  - 修复自动配置创建功能，确保在首次创建配置文件时，监听频道对（`monitor_channel_pairs`）的`text_filter`字段包含正确的示例项
  - 优化`UIMonitorChannelPair`类的默认配置，添加示例文本替换规则，使新用户能够直观了解替换规则的格式和用法
  - 改进`UIConfigManager`中的配置转换逻辑，确保即使在旧配置中`text_filter`为空时，也会添加默认示例规则
  - 在配置文件不存在时生成的默认配置现在包含完整的文本替换规则示例，包括`original_text`和`target_text`字段
  - 增强新用户体验，无需手动添加文本替换规则即可理解其结构和用法
  - 简化监听配置的初始设置过程，用户可直接通过修改示例规则来添加自己的替换需求

- **会话自动重连功能优化**:

  - 修复了会话自动重连功能的配置保存问题，确保重连设置能正确保存到配置文件中
  - 完善了`UIGeneralConfig`类中的`auto_restart_session`参数配置，默认值设为`True`
  - 优化了`create_default_config`函数，确保默认配置中包含自动重连参数
  - 更新了设置界面中的`_collect_settings`方法，使其能够正确收集自动重连状态
  - 增强了配置加载功能，确保从配置文件正确读取自动重连设置
  - 修改了应用默认配置，即使在加载配置失败时也会创建包含自动重连参数的默认设置
  - 提高了系统稳定性，使 Telegram 会话在意外断开后能够根据用户设置自动重新连接

- **网络代理界面优化**:

  - 简化了网络代理类型设置，仅保留 SOCKS5 代理类型选项
  - 优化了代理类型设置界面，降低用户设置复杂度
  - 调整了代理类型处理逻辑，确保所有代理连接使用可靠的 SOCKS5 协议
  - 提高了代理连接的稳定性和兼容性

- **上传和转发延迟优化**:
  - 上传延迟和转发延迟设置支持一位小数，提供更精确的时间控制
  - 改进了 UIUploadConfig 和 UIForwardConfig 模型，添加延迟值四舍五入验证器，精确到一位小数
  - 优化了上传和转发界面中的延迟设置控件，从整数微调框改为支持小数的双精度微调框
  - 配置保存时自动四舍五入到一位小数，解决浮点数精度问题
  - 增强配置加载机制，确保能正确加载整数和小数形式的延迟值
  - 优化了延迟值在配置文件中的存储格式，避免出现过长的小数位

### 修复

- **实时监听界面转发延迟保存修复**:

  - 修复了实时监听界面中转发延迟值修改后无法正确保存到配置文件的问题
  - 在`UIMonitorConfig`模型中添加了`forward_delay`字段的验证器，将值四舍五入到一位小数
  - 改进了`forward_delay`字段在配置处理过程中的精度处理，确保界面设置的值能正确保存
  - 统一了转发延迟值的处理方式，与`UIForwardConfig`中的处理一致
  - 增强了配置保存时的数据转换逻辑，避免精度丢失问题
  - 修复了界面切换时转发延迟值可能重置的问题，确保用户设置的值始终有效

- **导航树高度稳定性修复**:
  - 修复了导航树在应用启动时高度略微增加的问题
  - 优化了侧边栏分割器的组件调整机制，保持原有界面实现方式的同时增强高度稳定性
  - 改进了 QSplitter 的设置参数，使其在初始化时能够保持稳定的组件高度比例
  - 增强了窗口尺寸变化事件的处理，确保导航树高度维持合理的比例
  - 调整了导航树和任务预览的显示比例，设置导航树区域占 42%，任务预览区域占 58%，优化整体界面布局
  - 提高了用户界面的一致性和专业性

### UI 优化

- **任务概览界面优化**:
  - 精简了任务概览组件的界面元素，删除了多余的"活跃任务列表"标题文字
  - 减少了界面的视觉干扰，提高了整体界面的简洁性
  - 优化了垂直空间使用，为实际任务列表提供更多的显示区域
  - 保留了分隔线作为视觉分隔，维持了良好的界面层次结构

## 1.8.4 - 2025-04-05

### 功能增强

- **自动配置创建功能**:
  - 新增程序首次启动时自动创建默认配置文件的功能，解决无配置文件导致程序无法启动的问题
  - 默认配置包含完整的配置结构和示例值，使新用户能够直接通过设置界面修改并保存配置
  - 改进了 ConfigManager 和 UIConfigManager 配置加载逻辑，确保在配置文件不存在时能自动创建
  - 增强了程序的容错性，避免在首次运行时因缺少配置文件而出现错误
  - 优化了用户首次使用体验，提供了更友好的初始化流程

### 修复

- **本地上传功能修复**:

  - 修复了本地上传界面中文件夹路径没有从配置文件中加载和保存的问题
  - 改进上传配置保存逻辑，现在会正确保存用户选择的文件夹路径
  - 优化上传界面加载时的路径初始化，确保从配置中读取的路径能正确应用到文件选择器
  - 确保文件浏览器和文件列表显示与配置中保存的路径一致
  - 增强用户体验，使上传路径配置持久化，不再需要每次启动时重新选择目录

- **路径验证修复**:
  - 修复了路径验证中不允许 Windows 风格路径（包含盘符如 D:）的问题
  - 改进配置验证器，移除对冒号字符的限制，允许 Windows 盘符格式
  - 优化了下载路径、上传目录和临时文件路径的验证逻辑
  - 保留对真正非法字符（如<>"|?\*）的检查，确保路径有效性
  - 确保在所有操作系统下都能正确验证和保存路径配置

## 1.8.3 - 2025-04-04

### 功能改进

- **配置文件权限问题处理**:

  - 增强了应用对只读配置文件的检测和处理能力
  - 当检测到配置文件无法写入时，显示明确的错误对话框，提示用户修改文件权限
  - 改进权限错误提示，提供具体解决方案，包括取消文件只读属性、以管理员身份运行程序或移动到有写入权限的目录
  - 优化程序启动流程，在初始化阶段即检查配置文件权限，避免运行中突然出现权限问题
  - 完善错误对话框后的程序退出机制，确保用户点击确认后程序能立即退出，便于用户修改文件权限
  - 统一应用内所有配置保存操作的权限错误处理逻辑，保持一致的用户体验

- **界面显示优化**:

  - 优化程序启动时的窗口位置，使主窗口在屏幕中央居中显示
  - 提升首次启动应用时的用户体验，避免窗口出现在屏幕角落

- **系统托盘功能优化**:
  - 实现了"启动时最小化"功能，允许程序启动后自动最小化到系统托盘
  - 该功能需要同时启用"最小化到托盘"选项，确保托盘图标可用
  - 优化托盘通知机制，在程序启动时以托盘形式运行时显示友好提示
  - 用户可以通过点击托盘图标或托盘菜单中的"显示主窗口"选项来显示主界面
  - 增强托盘图标的可靠性，确保在各种启动场景下都能正确显示

### 修复

- **系统托盘功能修复**:

  - 修复了设置界面中"最小化到托盘"选项不生效的问题
  - 实现完整的系统托盘支持，允许应用在最小化时隐藏到系统托盘
  - 添加托盘图标菜单，提供"显示主窗口"和"退出"选项
  - 优化托盘图标交互，支持双击或单击托盘图标恢复窗口
  - 添加窗口最小化事件处理，使最小化行为符合用户设置
  - 退出应用程序时自动清理系统托盘图标
  - 修复了窗口状态变化处理代码中的 QEvent 枚举引用错误，确保最小化到托盘功能正常工作

- **权限错误处理优化**:
  - 修复了配置文件为只读时可能弹出多个相同权限错误提示框的问题
  - 添加错误提示状态跟踪，确保权限错误对话框只显示一次
  - 改进权限错误处理逻辑，避免重复执行错误处理流程

### 代码优化

- **错误处理机制改进**:
  - 重构配置保存相关代码，正确捕获和处理权限错误（PermissionError）
  - 改进错误消息传递机制，确保错误信息能清晰地显示给用户
  - 优化日志记录，更详细地记录配置文件权限问题，便于问题排查
  - 重构应用程序退出流程，确保在出现严重错误时能够优雅退出
  - 增强 UIConfigManager 配置检查能力，在保存配置前主动验证文件写入权限

## 1.8.2 - 2025-04-03

### 修复

- **设置界面错误修复**:
  - 修复了设置界面中保存设置时出现的 "local variable 'logger' referenced before assignment" 错误
  - 优化异常处理逻辑，直接使用外部定义的 logger 变量，避免重复定义
  - 增强设置保存功能的稳定性和可靠性

## 1.8.1 - 2025-04-03

### 配置改进

- 简化配置文件结构，将 API 和代理设置整合到 GENERAL 部分中
- 删除了冗余的 API 和 PROXY 部分，提高配置一致性
- 保持向后兼容，仍然能够读取旧版本配置文件
- 优化设置界面，移除了通用标签页，因为相关设置已在各功能模块中单独设置
- 从 GENERAL 部分移除了重复的配置参数（如 download_path, max_concurrent_downloads 等），这些参数已在各自专门的模块配置中定义
- 精简 DOWNLOAD 部分的配置项，只保留 downloadSetting 数组、download_path、parallel_download 和 max_concurrent_downloads 参数

### 界面优化

- **下载界面改进**:
  - 将媒体类型选项从"下载选项"标签页移至"频道配置"标签页中关键词行的下方
  - 修改频道显示格式，在添加频道后显示更丰富的信息：链接、ID 范围、关键词和媒体类型
  - 优化配置加载逻辑，从 downloadSetting 数组的每个条目中单独读取媒体类型
  - 每个频道支持独立设置不同的媒体类型，提高灵活性

### 修复

- **主题设置保存问题修复**:

  - 修复了在设置界面更改主题后，关闭应用程序时主题设置被重置的问题
  - 改进了应用程序关闭时的配置保存逻辑，确保在保存窗口状态时不会覆盖主题设置
  - 优化了程序关闭时的保存行为，关闭程序时不再自动保存所有配置，只保存窗口布局状态
  - 明确区分了需要手动保存的配置（如主题、一般设置等）和自动保存的布局状态（如工具栏位置）
  - 修改了`_on_config_saved`方法处理窗口状态变化的逻辑，使其只保存窗口几何信息和状态，不影响其他配置
  - 增强了配置保存的健壮性，避免在保存特定配置项时意外覆盖其他配置
  - 添加了更详细的日志记录，便于跟踪配置保存过程和问题诊断

- **配置保存问题修复**:

  - 修复了下载配置无法正确保存到 config.json 文件的问题
  - 集成 UIConfigManager 类处理配置的加载、保存和转换，确保正确处理媒体类型等枚举值
  - 优化配置信号处理机制，确保从各视图发送的配置更新能正确保存
  - 修改 TGManagerApp 类中的 \_on_config_saved 方法，使其能正确接收和处理包含配置数据的信号
  - 改进 DownloadView 类的 \_save_config 方法，确保媒体类型的有效性和一致性
  - 增强配置系统的健壮性，增加错误处理和日志记录
  - 实现配置保存时的类型验证，避免因类型错误导致的保存失败

- **配置验证错误修复**:

  - 修复了启动时可能出现的配置验证错误，增强应用稳定性
  - 改进 UIConfigManager 中的配置转换逻辑，添加详细的错误处理
  - 增强对无效频道链接格式的容错能力，特别是私有频道链接的处理
  - 自动修复过期的监听截止日期，设置为未来日期
  - 修复 API ID 和 API Hash 格式验证问题，提供有效的默认占位符
  - 增强配置加载流程的错误处理，确保在配置无效时能优雅降级到默认配置
  - 添加更详细的错误日志，便于排查配置问题

- **UI 配置系统统一化**:
  - 创建 UIUIConfig 配置模型，将 UI 设置纳入统一的配置验证体系
  - 移除分散的 UI 配置加载与保存逻辑，改用统一的配置管理机制
  - 优化 UI 配置与其他配置的一致性，确保所有配置都通过相同的路径处理
  - 强化 UI 设置的验证和错误处理，包括主题名称、窗口位置和布尔值字段
  - 改进主题切换逻辑，确保主题设置在保存和应用之间保持一致性
  - 增强窗口状态保存机制，避免窗口位置和工具栏布局在应用重启后丢失

### 改进

- **历史转发界面重构**：完全重构历史转发界面，采用与 FORWARD 配置文件一致的布局和功能，优化用户体验
  - 将"源频道"选项卡更改为"频道配置"，支持配置源频道和目标频道对
  - 简化"转发选项"，直接对应 config.json 中的 FORWARD 配置项
  - 删除了不必要的"转发规则"选项卡，使界面更加简洁
  - 使用 UIForwardConfig 模型实现配置的加载和保存
  - 优化界面布局，删除重复的"频道对配置"和"转发选项"标题
  - 将"已配置频道对"列表样式与下载界面保持一致，以滚动列表形式呈现
  - 媒体类型选项改为横向复选框布局，与下载界面保持一致
- **UI 优化**：从任务概览组件中移除多余的"活跃任务列表"标题文本，提高视觉清晰度和垂直空间利用率
- **窗口宽度优化**：增加主界面默认宽度 40 像素，提供更宽阔的显示空间，同时保持导航树宽度不变

### 修复

- **窗口尺寸**：修正了窗口尺寸调整机制，确保界面宽度不小于 1040 像素
- **导航树高度**：修复了应用启动时导航树高度微增的问题

## [1.7.5] - 2025-04-02

### 界面改进

- **导航结构优化**:

  - 移除导航树中的关键词下载选项，与版本 0.7.2 中的功能一致
  - 统一普通下载和关键词下载的界面，使用同一个下载界面处理所有下载需求
  - 在频道配置标签卡中集成关键词筛选功能，用户可为每个频道配置单独的关键词
  - 简化用户操作流程，减少界面复杂度
  - 优化导航树布局，使核心功能更加突出
  - 保留核心功能模块：媒体下载、媒体上传、消息转发和消息监听

- **主题设置保存机制优化**:

  - 修复了可能自动保存主题设置的问题，现在只有在点击设置界面的"保存设置"按钮后才会保存主题更改
  - 在设置界面中更改主题时，立即预览主题效果，但只有点击保存按钮后才会永久应用主题设置
  - 优化了应用程序关闭时的配置保存逻辑，确保不会自动保存未经确认的主题设置
  - 保留窗口状态和其他设置的自动保存功能，不影响其他配置项的正常保存
  - 实现更加一致的用户体验，主题设置的更改行为现在与其他设置的行为保持一致

- **普通下载界面优化**:

  - 调整下载选项标签卡布局，将下载路径设置项移至标签卡底部
  - 减少媒体类型选项上下留白，优化垂直空间使用
  - 调整控件间距和对齐方式，使内容靠上显示，提高信息密度
  - 添加弹性空间，确保界面元素分布合理，即使在较小窗口下也能良好显示
  - 添加适当的空间间隔，使界面元素排布更加合理
  - 优化用户操作流程，提高界面的直观性和一致性
  - 重构频道配置选项卡的布局，使用垂直分割器分隔频道列表和关键词部分
  - 优化按钮大小和布局，使界面更加紧凑和美观
  - 改进空间分配比例，使频道列表和关键词部分协调显示
  - 增强布局结构稳定性，防止界面组件被挤压或隐藏
  - 将关键词输入和相关按钮移至独立一行，提高操作直观性和空间利用率
  - 限制已配置频道列表的显示高度为 3 行，优化整体布局平衡
  - 改进各控件间的间距设置，使界面更加紧凑有序
  - 增加关键词输入框的默认宽度，并设置自适应拉伸，窗口放大时自动扩展
  - 优化关键词标签与输入框的比例关系，使关键词输入占据更多水平空间
  - 优化频道列表标题，动态显示当前已配置的频道数量，增强用户信息感知

- **普通下载界面优化**:
  - 调整下载选项标签卡布局，将下载路径设置项移至标签卡底部
  - 减少媒体类型选项上下留白，优化垂直空间使用
  - 调整控件间距和对齐方式，使内容靠上显示，提高信息密度
  - 添加弹性空间，确保界面元素分布合理，即使在较小窗口下也能良好显示
  - 添加适当的空间间隔，使界面元素排布更加合理
  - 优化用户操作流程，提高界面的直观性和一致性
  - 重构频道配置选项卡的布局，使用垂直分割器分隔频道列表和关键词部分
  - 优化按钮大小和布局，使界面更加紧凑和美观
  - 改进空间分配比例，使频道列表和关键词部分协调显示
  - 增强布局结构稳定性，防止界面组件被挤压或隐藏

### 修复

- **修复下载界面问题**:

  - 修复因界面改造遗留的信号连接问题，移除对已不存在控件的引用（如 add_keyword_button 和 remove_keyword_button）
  - 清理关键词标签页相关代码，移除条件判断代码块，确保界面加载稳定性
  - 优化日志输出，统一下载界面初始化完成的日志格式
  - 清理 use_keywords 模式下的冗余代码，简化代码结构
  - 完善界面重构过程，确保所有关联代码一致性
  - 解决导航树中下载功能在主窗口无法正确处理的 bug
  - 完善导航处理逻辑，优化用户体验

- **修复工具栏位置保存问题**:

  - 修复了工具栏拖动到界面右侧后关闭重启程序时位置未被保存的问题
  - 增强工具栏状态变化的监测机制，捕获更多可能的位置变更事件
  - 添加鼠标事件过滤器，确保能捕获工具栏拖动结束事件
  - 优化窗口状态保存逻辑，确保工具栏位置被正确保存到配置文件
  - 改进应用程序关闭流程，在关闭前主动触发一次窗口状态保存
  - 增加调试日志，便于追踪工具栏位置保存和恢复过程
  - 优化配置保存接口，确保内存中的 UI 配置能正确同步到配置文件

- **修复窗口信号处理问题**:
  - 解决启动时出现的工具栏信号断开连接警告
  - 优化工具栏信号监听机制，使用安全的方式处理信号连接和断开
  - 彻底重构信号连接代码，使用新的连接策略完全避免先断开连接的操作
  - 取消尝试断开信号的做法，直接进行信号连接，避免产生不必要的警告信息
  - 添加详细日志记录信号连接过程，便于调试和故障排除
  - 使用简洁安全的信号连接方式，增强代码的可靠性和可维护性
  - 改进工具栏状态变化监听的稳定性和可靠性
  - 消除控制台中的运行时警告信息，提升程序启动体验

## [1.7.4] - 2025-04-02

### 界面改进

- **设置按钮优化**:
  - 从导航树中移除了设置按钮，简化导航结构
  - 在菜单栏文件菜单中添加了设置按钮，提高可访问性
  - 优化工具栏设置按钮的处理方式，直接加载设置界面
  - 修改设置按钮的处理逻辑，使其与其他工具栏按钮一致
  - 确保设置功能的实现符合"功能单一性"原则，增强代码可维护性

## [1.7.3] - 2025-04-11

### 修复

- 修复了拖动工具栏时频繁保存配置的问题，现在拖动工具栏结束后只保存一次配置
- 添加了防抖功能来避免短时间内多次保存窗口状态
- 优化了工具栏事件处理和状态保存逻辑

## [1.7.2] - 2025-04-11

### 修复

- 修复了`QAction`导入错误问题，将导入从`PySide6.QtWidgets`移至正确的`PySide6.QtGui`模块
- 修复了程序退出时可能出现的线程清理问题

### 重构

- 将主窗口`MainWindow`类从单一文件拆分为多个功能模块
- 使用混入类（Mixin）模式提高代码可维护性
- 创建了模块化的目录结构，更好地组织各个功能
- 保持了 API 向后兼容

### 改进

- 增强了代码可读性和可维护性
- 降低了单个文件的复杂度
- 使功能扩展变得更加方便

## [1.7.1] - 2025-03-28

### 改进

- 优化了 UI 响应性能
- 改进了任务管理器功能
- 更新了帮助文档

### 修复

- 修复了一些 UI 布局问题
- 修复了在某些情况下任务状态不正确的问题

## [1.7.0] - 2025-03-15

### 功能

- 添加了新的转发功能
- 支持频道消息监听和自动处理
- 添加了 Qt 异步测试模块

### 改进

- 改进的用户界面，支持多种主题
- 优化了频道媒体下载速度
- 添加了更多的配置选项

## [1.6.0] - 2024-04-01

### 优化状态

- **业务逻辑与界面完全分离**:

  - ✅ 已实现 `LoggerEventAdapter` 适配器，连接日志系统与事件系统
  - ✅ 已实现 `EventEmitter` 类作为事件系统基础
  - ✅ 所有核心模块（Downloader、Uploader、Forwarder、Monitor、DownloaderSerial）已重构，使用事件系统传递用户界面信息
  - ✅ 已实现 `UICallback` 接口，提供统一的回调结构
  - ✅ 已实现 `EventToUIAdapter`，将事件转发到 UI 回调

- **异步处理机制完善**:

  - ✅ 已实现 `CancelToken` 和 `PauseToken` 类，支持任务取消和暂停恢复
  - ✅ 已实现 `TaskContext` 类，集成多种控制机制
  - ✅ 已实现 `TaskManager` 和 `TaskScheduler`，提供完整的任务管理系统
  - ✅ 所有耗时操作均采用异步接口，支持取消和暂停

- **错误处理机制升级**:

  - ✅ 实现细粒度的错误处理和报告机制
  - ✅ 错误信息包含类型、可恢复性等详细信息
  - ✅ 统一的错误上报机制，确保 UI 可获取全面的错误状态

- **配置模型优化**:

  - ✅ 采用 Pydantic 模型进行配置验证
  - ✅ 配置结构清晰，支持验证和默认值
  - ✅ 配置管理器可以与 UI 无缝交互

- **资源管理系统**:
  - ✅ 文件操作使用 context manager 管理资源
  - ✅ 任务系统确保资源正确释放
  - ✅ 实现统一的资源管理方式

### UI 界面开发对接步骤

1. **初始化 UI 框架**:

   - 选择 PyQt6/PySide6 作为 UI 框架
   - 创建基本应用程序结构
   - 设计主窗口和多标签页界面

2. **实现 UI 状态管理**:

   - 连接已有的`UIState`系统
   - 实现`UICallback`接口
   - 建立 UI 组件与状态的双向绑定

3. **配置界面**:

   - 为每个功能模块创建配置表单
   - 将表单连接到配置模型
   - 实现配置验证和即时反馈
   - 添加配置导入/导出功能

4. **功能模块界面**:

   - 为每个核心功能创建专用界面:
     - 转发界面
     - 下载界面
     - 上传界面
     - 监听界面
   - 连接界面组件与事件系统

5. **系统集成**:

   - 实现全局设置和主题管理
   - 添加日志查看器和状态监控
   - 设计系统托盘集成
   - 实现键盘快捷键

6. **测试与优化**:

   - 进行 UI 响应性能测试
   - 优化组件布局和用户体验
   - 实现异常情况下的 UI 稳定性
   - 支持多显示器和高 DPI 设置

7. **打包与发布**:
   - 为 Windows/Linux 平台创建安装包
   - 设计自动更新机制
   - 优化安装体验

### 技术准备

- 已创建 UI 示例代码，展示业务逻辑与界面分离的正确方式
- 所有后端功能已准备好与 UI 框架集成
- `MockDownloader`和`ConsoleUISimulator`类提供了集成参考

## [1.5.1] - 2024-03-30

### 新功能

- **界面分离优化**: 完成业务逻辑与界面输出的完全分离
  - 创建`LoggerEventAdapter`适配器，统一连接日志系统和事件系统
  - 重构所有核心模块，移除直接日志输出，使用事件系统传递用户界面信息
  - 保留内部调试日志，但不再直接输出到界面
  - 为 GUI 开发做好准备

### 优化

- **代码结构**: 通过事件系统统一模块间的通信机制
- **错误处理**: 改进错误处理逻辑，提供更详细的错误类型和可恢复性信息
- **进度报告**: 统一的进度和状态报告机制，为后续 GUI 开发奠定基础

### 模块改进

- **Downloader**: 移除直接日志输出，改用事件系统传递下载状态和进度
- **Uploader**: 移除直接日志输出，改用事件系统传递上传状态和进度
- **Forwarder**: 移除直接日志输出，改用事件系统传递转发状态和进度
- **Monitor**: 重构监听机制，使用事件系统传递消息接收和处理状态
- **DownloaderSerial**: 完全重写，使用更现代的异步设计和事件驱动架构

## [1.5.0] - 2024-03-25

### 新增

- **业务逻辑与 UI 分离系统**：
  - 实现 UI 状态管理系统，通过 UIState 和 UICallback 优雅地传递 UI 状态和事件
  - 开发事件到 UI 适配器，将业务逻辑的事件转换为 UI 回调
  - 建立统一的状态管理和事件处理机制
- **任务管理与调度系统**：
  - 实现任务管理器，支持任务创建、监控和状态跟踪
  - 开发任务调度器，支持优先级和先进先出调度模式
  - 提供任务暂停、恢复和取消功能
  - 实现任务统计和历史记录功能
- **示例代码**：
  - 添加 UI 状态和任务管理示例
  - 添加任务取消和恢复示例
  - 添加 UI 和任务管理集成示例，模拟完整的用户界面操作

### 优化

- 优化代码组织结构，采用更符合领域驱动设计的模块划分
- 增强系统扩展性，支持未来更多功能的集成

## [1.4.0] - 2024-03-20

### 新增

- **资源管理系统**：
  - 实现 ResourceManager 类，统一管理临时文件和目录
  - 提供引用计数机制，确保资源能够正确释放
  - 实现会话管理，支持资源分组和批量操作
  - 开发自动清理机制，定期清理过期资源
  - 添加异步和同步接口，便于不同场景使用
- **集成视频处理**：
  - 优化 VideoProcessor，集成资源管理系统
  - 视频缩略图自动注册到资源管理器，确保不会泄漏
- **完善测试用例**：
  - 为 ResourceManager 添加全面的单元测试
  - 更新 VideoProcessor 测试，验证与资源管理器的集成

### 改进

- 优化资源清理策略，提高系统效率
- 增强错误处理，提供更详细的错误信息

## [1.3.0] - 2024-03-15

### 新增

- **UI 配置系统**：
  - 实现 UI 配置模型，支持统一的设置管理
  - 添加配置验证功能，确保配置有效性
  - 开发配置管理器，负责读取、保存和应用配置
  - 提供默认配置生成功能，简化初始设置

### 优化

- 改进配置文件结构，更符合用户习惯
- 提供配置迁移工具，支持不同版本间的配置兼容

## [1.2.0] - 2024-03-10

### 新增

- **统一错误处理系统**：
  - 创建异常基类及子类层次结构，实现更精细的异常分类
  - 开发异常处理器，统一处理各种异常情况
  - 增加错误日志记录与查询功能
  - 实现可恢复性标记，指示异常是否可恢复
  - 提供异常转换工具，简化错误处理流程
  - 添加错误处理装饰器，简化异步和同步函数的错误处理

### 优化

- 改进错误提示信息，更加用户友好
- 完善错误处理文档，方便开发者理解和使用

## [1.1.0] - 2024-03-05

### 新增

- **客户端会话管理**：
  - 实现 ClientManager 类，统一管理 Telegram 客户端
  - 支持多账户登录和会话复用
  - 实现智能重连和会话恢复机制
  - 添加客户端池，优化资源利用
- **配置系统**：
  - 实现 ConfigManager 类，处理应用配置
  - 支持多配置文件和配置继承
  - 添加配置验证和自动修复功能

### 优化

- 改进日志系统，分类记录不同级别的日志
- 优化内存使用，减少资源占用

## [1.0.0] - 2024-03-01

### 初始版本

- **核心功能**：
  - 实现基础的 Telegram 消息转发功能
  - 支持媒体文件的下载和上传
  - 提供基本的过滤条件配置
  - 实现简单的状态跟踪和报告
- **工具和辅助功能**：
  - 实现日志记录系统
  - 添加基础的异常处理
  - 提供简单的命令行界面

## [0.7.5] - 2024-03-30

### 改进

- 优化上传模块的转发逻辑，参考转发模块实现了多目标频道的高效上传
- 为上传模块添加频道权限检测功能，自动识别非禁止转发的频道并优先使用
- 实现先上传到一个非禁止转发频道，然后使用复制转发到其他目标频道的功能
- 添加错误处理机制，当第一个目标频道上传失败时自动尝试下一个频道
- 大幅降低多频道上传的耗时和流量消耗，提高了上传效率

## [0.7.4] - 2024-03-29

### 改进

- 优化上传模块的 caption 逻辑，从使用文件夹名称改为读取 title.txt 文件内容
- 支持单文件上传和媒体组上传从同级目录的 title.txt 读取说明文字
- 添加 title.txt 文件不存在或读取失败时的回退机制，保持与之前行为的兼容性
- 上传单文件时自动跳过 title.txt 文件，避免重复上传

## [0.7.3] - 2024-03-28

### 修复

- 修复了由 auth.ExportAuthorization 导致的 FloodWait 错误处理问题
- 增强了数据中心切换和授权过程中的错误处理机制
- 改进了错误消息解析，准确提取等待时间
- 修复了 current_dc_id 获取方式，正确区分属性和方法调用
- 修复了零大小文件的检测和处理
- 完善了 media 下载过程中的错误处理
- 统一了顺序下载和并行下载模式中的错误处理机制
- 统一了媒体组文本文件的命名，所有文本文件现在统一使用"title.txt"作为文件名

## [0.7.2] - 2023-08-15

### 改进

- 统一普通下载和关键词下载的配置结构，使用相同的配置模式
- 优化配置项管理，提高代码重用性和一致性
- 简化用户配置流程，采用统一的配置方式

### 变更

- 移除了公共配置中的`source_channels`、`start_id`和`end_id`字段，统一使用`downloadSetting`配置
- 无论是普通下载还是关键词下载，均使用`downloadSetting`数组中的配置项
- 关键词下载模式下，使用`downloadSetting`中的`keywords`字段进行筛选
- 普通下载模式下，忽略`downloadSetting`中的`keywords`字段

### 修复

- 解决了普通下载和关键词下载使用不同配置结构导致的潜在问题
- 修复了在某些情况下配置解析不一致的问题

## [0.7.1] - 2023-07-10

### 改进

- 优化本地文件组织结构，按媒体组 ID 进行二级目录分类
- 添加媒体组文本自动保存功能，在每个媒体组文件夹中创建文本文件存储媒体组的文字内容
- 增强普通下载模式和关键词下载模式下的文件结构一致性
- 改进媒体组内文件的组织方式，确保相关文件存放在同一目录中
- 增强用户体验，通过合理文件组织使查找相关媒体更加便捷

## [0.7.0] - 2023-07-05

### 新增

- 添加关键词下载功能，支持根据消息文本中的关键词筛选下载内容
- 新增`downloadKeywords`命令，专用于关键词下载模式
- 实现关键词匹配消息文本和说明文字功能，支持大小写不敏感匹配
- 添加关键词目录组织功能，自动按关键词创建子目录
- 升级配置结构，新增`downloadSetting`数组，支持多频道多关键词配置
- 为每个下载设置项添加单独的源频道、ID 范围、媒体类型和关键词配置

### 改进

- 重构下载模块，支持三种下载模式：顺序下载、并行下载和关键词下载
- 优化目录创建逻辑，根据不同下载模式自动选择合适的目录组织方式
- 增强配置文件结构，保持向后兼容性
- 改进关键词匹配算法，提高匹配准确性和效率
- 优化日志输出，更清晰地显示关键词匹配和下载状态
- 增强下载配置的灵活性，简化多源频道配置流程

### 修复

- 修复关键词下载模式下媒体组处理的逻辑问题，确保当媒体组中任意消息包含关键词时，下载该媒体组中的所有文件
- 优化媒体组关键词匹配算法，提高媒体组下载的完整性和准确性
- 修复 `_iter_messages` 函数在获取消息时可能导致的无限循环问题
- 添加最大尝试次数限制，防止在消息不可获取时陷入死循环
- 改进消息获取算法，使用更高效的方式处理可能不存在的消息 ID
- 实现智能批次调整，当无法获取消息时自动减小批次大小
- 优化日志输出，提供更清晰的消息获取状态和错误信息
- 增强对缺失消息的处理，跳过不存在的消息 ID 而不影响其他消息获取
- 修复媒体组 ID 类型处理问题，避免在处理整数类型的媒体组 ID 时导致的类型错误

## [0.6.1] - 2023-06-25

### 修复

- 修复了 `

## [1.7.2] - 2023-XX-XX

### 新增

- 添加了通用的 BaseEventEmitter 基类，实现了基于 Qt Signal 的事件处理基础设施
- 添加了 EventEmitterDownloader、EventEmitterUploader、EventEmitterForwarder 和 EventEmitterMonitor 类，为所有核心功能模块提供 Qt 信号支持
- 实现了所有核心模块与 UI 层的统一信号槽连接机制，提高了代码可维护性

### 修复

- 修复上传视图、转发视图和监听视图无法正确连接到对应模块的问题（'Uploader/Forwarder/Monitor' object has no attribute 'on'）
- 修复下载视图无法正确接收下载器事件的问题
- 优化了状态和进度更新的处理

### 变更

- 重构所有核心模块的实现，将原始功能与 UI 信号机制分离
- 改进了事件处理机制，使用标准的 Qt Signal/Slot 模式
- 使用装饰器模式包装原始功能模块，避免修改原始代码

## [1.9.78] - 2025-05-31

### Fixed
- 彻底修复媒体组过滤逻辑问题
  - 解决了被过滤消息仍被添加到缓存导致过滤失效的根本问题
  - 重构了handle_media_group_message，确保只有通过过滤的消息才添加到缓存
  - 修复了重复转发问题：第一个目标频道成功后不再重复转发
  - 优化了转发失败重试逻辑，避免向已成功的频道重复发送

### Added  
- 实现媒体组过滤后重组发送功能
  - 当媒体组中部分消息被过滤后，如果剩余消息>1，使用send_media_group()重组发送
  - 过滤后只剩1条消息时，作为单条消息发送
  - 支持重组媒体组的文本替换和标题移除功能
  - 重组媒体组在日志中显示"重组媒体组[ID]"以便区分

### Improved
- 增强了媒体组处理的过滤机制，确保100%准确的媒体类型过滤
- 优化了API工作器的媒体类型过滤，确保API获取的完整媒体组也经过过滤
- 改进了过滤消息的UI事件发送机制，添加了统一的_emit_message_filtered方法
- 增强了媒体组转发的日志记录，清楚显示过滤和重组过程
