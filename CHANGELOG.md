# 更新日志

所有项目的显著更改都将记录在此文件中。

本项目遵循[语义化版本规范](https://semver.org/lang/zh-CN/)。

## [0.4.2] - 2025-03-28

### 增强

- 全面优化 FloodWait 处理机制，引入连续触发检测和自适应退避策略
- 添加临时文件写入机制，确保文件写入的原子性和安全性
- 增强文件下载前的媒体内容验证
- 改进文件大小检查，引入百分比进度显示
- 增强对网络错误和 API 限制的智能处理

### 修复

- 修复文件大小为 0 的问题，通过多重检查和验证确保文件完整性
- 解决 PEER_ID_INVALID 错误，增加明确的错误提示
- 修复临时文件处理，防止数据损坏
- 改进频道访问权限错误处理，提供更清晰的错误信息
- 修复 FloodWait 处理中的递归和抖动问题

## [0.4.1] - 2023-05-15

### 增强

- 全面升级 FloodWait 处理机制，实现全局自适应速率限制控制
- 添加下载内容验证系统，自动检测和处理不完整下载
- 优化文件大小计算和显示，解决速度显示错误问题
- 添加重试机制，对下载失败的文件自动进行多次尝试
- 实现指数退避策略，减少 API 连续错误
- 提高下载队列容量，更好地处理大量下载任务

### 修复

- 修复文件大小为 0 的问题，现在会自动检测并重试
- 解决 FloodWait 递归调用导致的栈溢出问题
- 修复下载大文件时速度显示不准确的问题
- 修复文件写入验证，确保磁盘上的文件完整性
- 增加了详细的错误日志，便于问题诊断

## [0.4.0] - 2023-05-10

### 增强

- 彻底重构并行下载机制，解决并发瓶颈问题
- 实现真正并行处理下载任务，而不是之前的伪并行模式
- 引入工作协程池系统，确保最大化利用配置的并发下载限制
- 优化文件写入线程池，显著提高大量小文件的处理速度
- 添加详细的下载性能监控，包括每个下载任务的预计大小、实际大小和速度
- 增加工作协程 ID 显示，使并行任务跟踪更加直观
- 改进日志系统，更清晰地展示当前活跃下载数量和队列状态

### 修复

- 修复首批下载完成后并行下载停滞的问题
- 解决文件写入非并行执行的性能瓶颈
- 优化内存使用，防止大量并行下载时的内存溢出风险
- 修复 FloodWait 异常处理逻辑，确保限速后正确重试

## [0.3.9] - 2023-05-02

### 改进

- 优化了并行下载功能实现，显著提高下载速度
- 引入了文件写入线程池，减少文件 I/O 瓶颈
- 添加了详细的性能统计信息，包括下载速度和文件大小
- 减少了消息获取时的延迟，提高了下载效率
- 优化了日志输出，便于追踪并行下载的实际状态
- 修复了下载任务的进度显示问题

## [0.3.8] - 2023-04-30

### 新增

- 添加了并行下载功能，在`DOWNLOAD`配置中新增`parallel_download`和`max_concurrent_downloads`参数
- 新增`downloader_serial.py`模块，保留原始的顺序下载实现逻辑
- 根据配置自动选择并行或顺序下载模式，提高大量文件下载时的效率
- 使用信号量控制并发下载数量，避免超出 Telegram API 限制

## [0.3.7] - 2023-04-27

### 改进

- 修改了转发模块中的消息获取顺序，从"从新到旧"改为"从旧到新"，使转发按照原始发送顺序进行
- 重构了`Forwarder._iter_messages`方法，现在会先收集所有消息，然后按照 ID 升序排序后再处理
- 转发的消息现在会按照原始顺序（从旧到新）进行转发，与下载顺序保持一致，提供更直观的体验

## [0.3.6] - 2023-04-25

### 改进

- 将上传、下载和转发的三个历史记录 JSON 文件统一移动到根目录下的 history 文件夹中
- 优化了历史记录文件的管理结构，提高了项目的文件组织性

## [0.3.5] - 2023-04-15

### 改进

- 修复了转发历史记录的逻辑，现在只有转发成功才记录转发历史
- 增强了错误处理机制，转发失败时会明确记录错误并跳过，不会记录到转发历史中
- 优化了单条消息和媒体组转发的异常处理，提高了代码的健壮性

## [0.3.4] - 2023-04-12

### 改进

- 优化了媒体组消息的转发方式，现在在隐藏作者模式下使用 `copy_media_group` 方法一次性转发整个媒体组
- 改进了错误处理机制，当媒体组转发失败时会优雅地跳过并继续处理其他消息
- 减少了 API 调用次数，提高了转发效率，避免了因频繁请求导致的速率限制
- 重构了转发历史记录代码，消除了重复代码，提高代码可维护性

## [0.3.3] - 2023-04-10

### 新增

- 添加了隐藏原作者功能，在 `FORWARD` 配置中新增 `hide_author` 选项
- 当 `hide_author` 设置为 `true` 时，使用 `copy_message` 方法转发消息，隐藏原始作者信息
- 当 `hide_author` 设置为 `false` 时，使用 `forward_messages` 方法转发消息，保留原始作者信息

## [0.3.2] - 2023-04-08

### 修复

- 修复了`check_forward_permission`方法中的 Pyrogram API 兼容性问题，将`get_messages`替换为`get_chat_history`
- 更新了主程序中的 asyncio 事件循环处理方式，使用`asyncio.run()`替代旧的获取循环方法，消除 deprecation 警告

## [0.3.0] - 2023-04-05

### 改进

- 修改了消息获取顺序，从"从新到旧"改为"从旧到新"，使得下载和处理消息按照时间顺序进行
- 重构了`_iter_messages`方法，现在会先收集所有消息，然后按照 ID 升序排序后再处理
- 下载的媒体文件现在会按照原始发送顺序（从旧到新）进行下载，提供更直观的下载体验

## [0.2.0] - 2023-03-30

### 改进

- 改进了下载模块中的目录命名方式，现在使用"频道标题-频道 ID"作为文件夹名称，而不是仅使用频道 ID
- 修改了`ChannelResolver.format_channel_info`方法，现在返回更丰富的信息（格式化字符串和频道标题、ID 元组）
- 在所有相关模块中更新了对`format_channel_info`返回值的处理方式，包括：
  - Downloader 模块
  - Forwarder 模块
  - Monitor 模块
  - 测试文件
- 添加了文件名清理功能，确保生成的文件夹名称在各操作系统上都有效

## [0.1.0] - 2023-03-25

### 新增

- 初始项目结构设置
- 基础功能模块：ConfigManager、Logger、ChannelResolver、HistoryManager、ClientManager
- 核心功能模块：Downloader、Uploader、Forwarder、Monitor
- 命令行接口：forward、download、upload、startmonitor
- 配置文件读取与验证
- 添加 README.md 和 CHANGELOG.md
